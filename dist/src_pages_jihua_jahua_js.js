/*
 * ATTENTION: The "eval" devtool has been used (maybe by default in mode: "development").
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
(self["webpackChunkfzz_react_app"] = self["webpackChunkfzz_react_app"] || []).push([["src_pages_jihua_jahua_js"],{

/***/ "./node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js":
/*!*********************************************************************!*\
  !*** ./node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js ***!
  \*********************************************************************/
/***/ ((__unused_webpack___webpack_module__, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ _asyncToGenerator)\n/* harmony export */ });\nfunction asyncGeneratorStep(n, t, e, r, o, a, c) {\n  try {\n    var i = n[a](c),\n      u = i.value;\n  } catch (n) {\n    return void e(n);\n  }\n  i.done ? t(u) : Promise.resolve(u).then(r, o);\n}\nfunction _asyncToGenerator(n) {\n  return function () {\n    var t = this,\n      e = arguments;\n    return new Promise(function (r, o) {\n      var a = n.apply(t, e);\n      function _next(n) {\n        asyncGeneratorStep(a, r, o, _next, _throw, \"next\", n);\n      }\n      function _throw(n) {\n        asyncGeneratorStep(a, r, o, _next, _throw, \"throw\", n);\n      }\n      _next(void 0);\n    });\n  };\n}\n\n\n//# sourceURL=webpack://fzz-react-app/./node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js?\n}");

/***/ }),

/***/ "./node_modules/css-loader/dist/cjs.js!./node_modules/postcss-loader/src/index.js!./src/pages/jihua/jihua.css":
/*!********************************************************************************************************************!*\
  !*** ./node_modules/css-loader/dist/cjs.js!./node_modules/postcss-loader/src/index.js!./src/pages/jihua/jihua.css ***!
  \********************************************************************************************************************/
/***/ ((module, exports, __webpack_require__) => {

eval("{// Imports\nvar ___CSS_LOADER_API_IMPORT___ = __webpack_require__(/*! ../../../node_modules/css-loader/dist/runtime/api.js */ \"./node_modules/css-loader/dist/runtime/api.js\");\nexports = ___CSS_LOADER_API_IMPORT___(false);\n// Module\nexports.push([module.id, \".jihua-page{display:flex;flex-direction:column;height:100vh;background:#f7f8fa;color:#1f2328;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\";position:relative}\\r\\n.jihua-page{padding-bottom:env(safe-area-inset-bottom);padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right)}\\r\\n.jihua-header{padding:6px 12px;background:#ffffff;box-shadow:0 1px 8px rgba(0,0,0,.06);display:flex;flex-direction:column;gap:6px}\\r\\n.jihua-header .brand{font-weight:700;font-size:17px}\\r\\n.controls-primary{display:flex;gap:8px;align-items:center;flex-wrap:wrap}\\r\\n.controls-primary .spacer{flex:1}\\r\\n.controls-more{border-top:1px dashed #e5e7eb;padding-top:6px;display:flex;flex-direction:column;gap:8px}\\r\\n.controls-col{display:flex;flex-direction:column;gap:8px}\\r\\n.search-input,.api-input{flex:1;min-width:140px;padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#ffffff;color:#111;box-shadow:0 1px 2px rgba(16,24,40,.04)}\\r\\n.tile-select{background:#ffffff;border:1px solid #e5e7eb;color:#111;border-radius:12px;padding:10px 12px}\\r\\n.view-toggle{display:flex;gap:6px}\\r\\n.icon-btn.active{background:#edf2ff;border-color:#2952ff;color:#1b3fff}\\r\\n.api-form{display:flex;gap:8px;flex:1}\\r\\n.btn{background:#2952ff;border:0;color:#fff;border-radius:12px;padding:10px 14px}\\r\\n.btn:disabled{opacity:.6}\\r\\n.btn.danger{background:#ef4444}\\r\\n.icon-btn{background:#ffffff;border:1px solid #e5e7eb;color:#111;border-radius:12px;padding:8px 10px}\\r\\n.icon-btn.danger{background:#fff7f7;border-color:#fee2e2;color:#b91c1c}\\r\\n.map-container{height:46vh;width:100%;background:#e5e7eb}\\r\\n.suggestions{position:absolute;left:12px;right:12px;z-index:30;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;max-height:42vh;overflow:auto;box-shadow:0 12px 24px rgba(16,24,40,.08);margin-top:4px}\\r\\n.suggestion-item{padding:10px 12px;border-bottom:1px solid #f1f5f9;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:8px}\\r\\n.suggestion-item:hover{background:#f8fafc}\\r\\n.suggestion-item.selected{background:#eef2ff}\\r\\n.sugg-title{flex:1;min-width:0;word-break:break-word}\\r\\n.sugg-meta{font-size:12px;color:#64748b;white-space:nowrap}\\r\\n.marker-label{background:#111827;color:#fff;border:1px solid #1f2937;border-radius:8px;padding:2px 6px}\\r\\n.marker-index-icon{background:transparent;border:none}\\r\\n.marker-index-icon div{width:26px;height:26px;border-radius:13px;background:#2952ff;color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;border:1px solid #1b3fff;box-shadow:0 2px 6px rgba(0,0,0,.12)}\\r\\n.sheet{flex:1;display:flex;flex-direction:column;background:#f9fafb;border-top:1px solid #edf2f7;overflow:auto}\\r\\n.paper{background:#f3eee2; background-image:url('data:image/svg+xml;utf8,<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"160\\\" height=\\\"160\\\"><defs><filter id=\\\"n\\\"><feTurbulence type=\\\"fractalNoise\\\" baseFrequency=\\\"0.9\\\" numOctaves=\\\"2\\\" stitchTiles=\\\"stitch\\\"/></filter></defs><rect width=\\\"100%\\\" height=\\\"100%\\\" fill=\\\"%23f3eee2\\\"/><rect width=\\\"100%\\\" height=\\\"100%\\\" filter=\\\"url(%23n)\\\" opacity=\\\"0.05\\\"/></svg>'); background-size:160px 160px}\\r\\n.paper-card{background:#f7f1e3;border:1px solid #e0d7c6;border-radius:16px;box-shadow:0 6px 24px rgba(140,120,90,.15), inset 0 1px 0 rgba(255,255,255,.4)}\\r\\n.paper-header{background:linear-gradient(180deg,rgba(255,255,255,.7),rgba(255,255,255,.2));border-bottom:1px solid #e6decd}\\r\\n.sheet-header{display:flex;gap:8px;padding:10px 12px;align-items:center;border-bottom:1px solid #edf2f7;background:#ffffff}\\r\\n.plan-name{flex:1;min-width:160px;background:#ffffff;border:1px solid #e5e7eb;color:#111;border-radius:12px;padding:10px 12px}\\r\\n.actions{display:flex;gap:8px}\\r\\n.plans-bar{display:flex;gap:8px;padding:10px 12px;border-bottom:1px solid #edf2f7;background:#ffffff}\\r\\n.plan-select{background:#ffffff;border:1px solid #e5e7eb;color:#111;border-radius:12px;padding:10px 12px}\\r\\n.error{color:#b91c1c;padding:8px 12px}\\r\\n.item-list{list-style:none;margin:0;padding:10px;display:flex;flex-direction:column;gap:10px}\\r\\n.item{background:#ffffff;border:1px solid #e5e7eb;border-radius:14px;padding:10px;box-shadow:0 2px 10px rgba(16,24,40,.06)}\\r\\n.item-line{display:flex;gap:8px;align-items:center}\\r\\n.index{width:20px;text-align:center;color:#6b7280}\\r\\n.item-name{flex:1;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;color:#111;padding:8px 10px}\\r\\n.move{display:flex;gap:6px}\\r\\n.date-input,.time-input{background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;color:#111;padding:8px 10px}\\r\\n.coords{margin-left:auto;font-size:12px;color:#6b7280}\\r\\n.notes{width:100%;margin-top:6px;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;color:#111;padding:8px 10px}\\r\\n\\r\\n/* timeline view */\\r\\n.timeline{position:relative;padding:10px 12px;display:flex;flex-direction:column;gap:12px}\\r\\n.timeline-item{display:flex;gap:12px}\\r\\n.timeline-left{width:20px;position:relative;display:flex;flex-direction:column;align-items:center}\\r\\n.timeline-dot{width:10px;height:10px;border-radius:5px;background:#2952ff;border:1px solid #1b3fff;margin-top:6px}\\r\\n.timeline-line{flex:1;width:2px;background:#e5e7eb;margin-top:4px}\\r\\n.timeline-content{flex:1;background:#ffffff;border:1px solid #e5e7eb;border-radius:14px;padding:10px;box-shadow:0 2px 10px rgba(16,24,40,.06)}\\r\\n.timeline-title{display:flex;align-items:center;gap:8px}\\r\\n.timeline-meta{display:flex;align-items:center;gap:8px;margin-top:6px}\\r\\n\\r\\n/* day picker and stats */\\r\\n.day-picker{position:sticky;top:0;z-index:15;display:flex;gap:8px;overflow-x:auto;padding:8px 12px;background:linear-gradient(180deg,#ffffff,#f8fafc);border-bottom:1px solid #edf2f7}\\r\\n.day-chip{white-space:nowrap;background:#fff;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;color:#111;box-shadow:0 1px 2px rgba(0,0,0,.04)}\\r\\n.day-chip:hover{background:#f8fafc}\\r\\n.day-chip.today{border-color:#2952ff;box-shadow:0 0 0 2px rgba(41,82,255,.12)}\\r\\n.day-chip.hasFav{position:relative}\\r\\n.day-chip .badge{position:absolute;top:-3px;right:-3px;width:8px;height:8px;border-radius:50%;background:#f59e0b;border:1px solid #fff}\\r\\n.stats-bar{position:sticky;bottom:0;z-index:12;display:flex;gap:12px;align-items:center;flex-wrap:wrap;padding:8px 12px;background:rgba(255,255,255,.9);backdrop-filter:saturate(180%) blur(6px);border-top:1px solid #edf2f7}\\r\\n.stats-days{display:flex;gap:8px;flex-wrap:wrap}\\r\\n.stats-day{background:#f1f5f9;color:#0f172a;border-radius:999px;padding:4px 8px;font-size:12px}\\r\\n.warning-bar{width:100%;color:#7c2d12;background:#fffbeb;border:1px solid #fde68a;border-radius:8px;padding:6px 10px}\\r\\n\\r\\n/* splitter */\\r\\n.splitter{height:12px;cursor:row-resize;background:linear-gradient(#f3f4f6,#e5e7eb);border-top:1px solid #e5e7eb;border-bottom:1px solid #e5e7eb}\\r\\n\\r\\n@media (min-width: 720px){\\r\\n  .map-container{height:52vh}\\r\\n  .jihua-header .brand{font-size:18px}\\r\\n}\\r\\n\\r\\n/* 手机端优化 */\\r\\n@media (max-width: 480px){\\r\\n  /* 减小按钮尺寸，适合拇指操作且不占太多行 */\\r\\n  .btn,.icon-btn{padding:6px 10px; font-size:14px; border-radius:10px; min-height:36px; line-height:1.2; white-space:nowrap; flex:0 0 auto}\\r\\n  .btn.danger,.icon-btn.danger{min-height:36px}\\r\\n\\r\\n  /* 顶部主控件与视图切换、操作区统一采用横向滚动，不换行 */\\r\\n  .controls-primary,\\r\\n  .view-toggle,\\r\\n  .actions,\\r\\n  .plans-bar{flex-wrap:nowrap !important; overflow-x:auto; overflow-y:hidden; gap:6px !important}\\r\\n\\r\\n  /* 去掉占位伸缩，避免把按钮挤到第二行 */\\r\\n  .controls-primary .spacer{display:none}\\r\\n\\r\\n  /* 下拉选择与输入保留自适应宽度，其余按钮不再 100% 占满 */\\r\\n  .tile-select{flex:0 0 auto}\\r\\n  .icon-btn{width:auto}\\r\\n\\r\\n  /* 隐藏横向滚动条（微信内更干净） */\\r\\n  .controls-primary::-webkit-scrollbar,\\r\\n  .view-toggle::-webkit-scrollbar,\\r\\n  .actions::-webkit-scrollbar,\\r\\n  .plans-bar::-webkit-scrollbar{display:none; height:0}\\r\\n}\\r\\n\\r\\n/* context menu */\\r\\n.context-menu{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 12px 24px rgba(16,24,40,.16)}\\r\\n.context-item{padding:8px 10px;cursor:pointer;border-radius:8px;color:#111}\\r\\n.context-item:hover{background:#f8fafc}\\r\\n.context-item.danger{color:#b91c1c}\\r\\n.context-sep{height:1px;background:#f1f5f9;margin:6px 0}\\r\\n\\r\\n/* dark theme */\\r\\n@media (prefers-color-scheme: dark){\\r\\n  .jihua-page{background:#0b0f14;color:#e7edf5}\\r\\n  .jihua-header{background:#0f141a;box-shadow:0 1px 8px rgba(0,0,0,.5)}\\r\\n  .controls-more{border-top:1px dashed #233143}\\r\\n  .search-input,.api-input,.tile-select,.icon-btn,.plan-name,.plan-select,.item,.item-name,.date-input,.time-input,.notes{background:#0f141a;border-color:#233143;color:#e7edf5}\\r\\n  .icon-btn.active{background:#1b2a4b;border-color:#3560ff;color:#cfe1ff}\\r\\n  .map-container{background:#0d1117}\\r\\n  .suggestions{background:#0f141a;border-color:#233143;box-shadow:0 12px 24px rgba(0,0,0,.6)}\\r\\n  .suggestion-item{border-bottom-color:#1c2634}\\r\\n  .suggestion-item:hover{background:#14202e}\\r\\n  .suggestion-item.selected{background:#1b2a4b}\\r\\n  .sugg-meta{color:#9fb3c8}\\r\\n  .sheet{background:#0b0f14;border-top-color:#233143}\\r\\n  .paper{background:#10151b}\\r\\n  .paper-card{background:#121b24;border-color:#1c2634;box-shadow:0 6px 24px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.02)}\\r\\n  .paper-header{border-bottom-color:#1c2634}\\r\\n  .sheet-header{background:#0f141a;border-bottom-color:#233143}\\r\\n  .plans-bar{background:#0f141a;border-bottom-color:#233143}\\r\\n  .day-picker{background:linear-gradient(180deg,#0f141a,#0b0f14);border-bottom-color:#233143}\\r\\n  .day-chip{background:#0f141a;border-color:#233143;color:#e7edf5}\\r\\n  .day-chip:hover{background:#14202e}\\r\\n  .stats-bar{background:rgba(15,20,26,.9);border-top-color:#233143}\\r\\n  .stats-day{background:#14202e;color:#e7edf5}\\r\\n}\\r\\n\\r\\n/* 微信内置浏览器优化：去除点击高亮 */\\r\\nbutton, .btn, .icon-btn{ -webkit-tap-highlight-color: rgba(0,0,0,0); touch-action: manipulation }\\r\\n\", \"\"]);\n// Exports\nmodule.exports = exports;\n\n\n//# sourceURL=webpack://fzz-react-app/./src/pages/jihua/jihua.css?./node_modules/css-loader/dist/cjs.js!./node_modules/postcss-loader/src/index.js\n}");

/***/ }),

/***/ "./src/pages/jihua/jahua.js":
/*!**********************************!*\
  !*** ./src/pages/jihua/jahua.js ***!
  \**********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ JihuaPlanner)\n/* harmony export */ });\n/* harmony import */ var _babel_runtime_helpers_typeof__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @babel/runtime/helpers/typeof */ \"./node_modules/@babel/runtime/helpers/esm/typeof.js\");\n/* harmony import */ var _babel_runtime_helpers_extends__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! @babel/runtime/helpers/extends */ \"./node_modules/@babel/runtime/helpers/esm/extends.js\");\n/* harmony import */ var _babel_runtime_helpers_toConsumableArray__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! @babel/runtime/helpers/toConsumableArray */ \"./node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\");\n/* harmony import */ var _babel_runtime_helpers_defineProperty__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! @babel/runtime/helpers/defineProperty */ \"./node_modules/@babel/runtime/helpers/esm/defineProperty.js\");\n/* harmony import */ var _babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! @babel/runtime/helpers/asyncToGenerator */ \"./node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\");\n/* harmony import */ var _babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! @babel/runtime/helpers/slicedToArray */ \"./node_modules/@babel/runtime/helpers/esm/slicedToArray.js\");\n/* harmony import */ var react__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! react */ \"./node_modules/react/index.js\");\n/* harmony import */ var axios__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! axios */ \"./node_modules/axios/lib/axios.js\");\n/* harmony import */ var react_redux__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! react-redux */ \"./node_modules/react-redux/es/index.js\");\n/* harmony import */ var _jihua_css__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ./jihua.css */ \"./src/pages/jihua/jihua.css\");\n/* harmony import */ var _jihua_css__WEBPACK_IMPORTED_MODULE_9___default = /*#__PURE__*/__webpack_require__.n(_jihua_css__WEBPACK_IMPORTED_MODULE_9__);\n\n\n\n\n\n\nfunction _regeneratorValues(e) { if (null != e) { var t = e[\"function\" == typeof Symbol && Symbol.iterator || \"@@iterator\"], r = 0; if (t) return t.call(e); if (\"function\" == typeof e.next) return e; if (!isNaN(e.length)) return { next: function next() { return e && r >= e.length && (e = void 0), { value: e && e[r++], done: !e }; } }; } throw new TypeError((0,_babel_runtime_helpers_typeof__WEBPACK_IMPORTED_MODULE_0__[\"default\"])(e) + \" is not iterable\"); }\nfunction _createForOfIteratorHelper(r, e) { var t = \"undefined\" != typeof Symbol && r[Symbol.iterator] || r[\"@@iterator\"]; if (!t) { if (Array.isArray(r) || (t = _unsupportedIterableToArray(r)) || e && r && \"number\" == typeof r.length) { t && (r = t); var _n = 0, F = function F() {}; return { s: F, n: function n() { return _n >= r.length ? { done: !0 } : { done: !1, value: r[_n++] }; }, e: function e(r) { throw r; }, f: F }; } throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\"); } var o, a = !0, u = !1; return { s: function s() { t = t.call(r); }, n: function n() { var r = t.next(); return a = r.done, r; }, e: function e(r) { u = !0, o = r; }, f: function f() { try { a || null == t[\"return\"] || t[\"return\"](); } finally { if (u) throw o; } } }; }\nfunction _unsupportedIterableToArray(r, a) { if (r) { if (\"string\" == typeof r) return _arrayLikeToArray(r, a); var t = {}.toString.call(r).slice(8, -1); return \"Object\" === t && r.constructor && (t = r.constructor.name), \"Map\" === t || \"Set\" === t ? Array.from(r) : \"Arguments\" === t || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t) ? _arrayLikeToArray(r, a) : void 0; } }\nfunction _arrayLikeToArray(r, a) { (null == a || a > r.length) && (a = r.length); for (var e = 0, n = Array(a); e < a; e++) n[e] = r[e]; return n; }\nfunction ownKeys(e, r) { var t = Object.keys(e); if (Object.getOwnPropertySymbols) { var o = Object.getOwnPropertySymbols(e); r && (o = o.filter(function (r) { return Object.getOwnPropertyDescriptor(e, r).enumerable; })), t.push.apply(t, o); } return t; }\nfunction _objectSpread(e) { for (var r = 1; r < arguments.length; r++) { var t = null != arguments[r] ? arguments[r] : {}; r % 2 ? ownKeys(Object(t), !0).forEach(function (r) { (0,_babel_runtime_helpers_defineProperty__WEBPACK_IMPORTED_MODULE_3__[\"default\"])(e, r, t[r]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(e, Object.getOwnPropertyDescriptors(t)) : ownKeys(Object(t)).forEach(function (r) { Object.defineProperty(e, r, Object.getOwnPropertyDescriptor(t, r)); }); } return e; }\nfunction _regenerator() { /*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */ var e, t, r = \"function\" == typeof Symbol ? Symbol : {}, n = r.iterator || \"@@iterator\", o = r.toStringTag || \"@@toStringTag\"; function i(r, n, o, i) { var c = n && n.prototype instanceof Generator ? n : Generator, u = Object.create(c.prototype); return _regeneratorDefine2(u, \"_invoke\", function (r, n, o) { var i, c, u, f = 0, p = o || [], y = !1, G = { p: 0, n: 0, v: e, a: d, f: d.bind(e, 4), d: function d(t, r) { return i = t, c = 0, u = e, G.n = r, a; } }; function d(r, n) { for (c = r, u = n, t = 0; !y && f && !o && t < p.length; t++) { var o, i = p[t], d = G.p, l = i[2]; r > 3 ? (o = l === n) && (u = i[(c = i[4]) ? 5 : (c = 3, 3)], i[4] = i[5] = e) : i[0] <= d && ((o = r < 2 && d < i[1]) ? (c = 0, G.v = n, G.n = i[1]) : d < l && (o = r < 3 || i[0] > n || n > l) && (i[4] = r, i[5] = n, G.n = l, c = 0)); } if (o || r > 1) return a; throw y = !0, n; } return function (o, p, l) { if (f > 1) throw TypeError(\"Generator is already running\"); for (y && 1 === p && d(p, l), c = p, u = l; (t = c < 2 ? e : u) || !y;) { i || (c ? c < 3 ? (c > 1 && (G.n = -1), d(c, u)) : G.n = u : G.v = u); try { if (f = 2, i) { if (c || (o = \"next\"), t = i[o]) { if (!(t = t.call(i, u))) throw TypeError(\"iterator result is not an object\"); if (!t.done) return t; u = t.value, c < 2 && (c = 0); } else 1 === c && (t = i[\"return\"]) && t.call(i), c < 2 && (u = TypeError(\"The iterator does not provide a '\" + o + \"' method\"), c = 1); i = e; } else if ((t = (y = G.n < 0) ? u : r.call(n, G)) !== a) break; } catch (t) { i = e, c = 1, u = t; } finally { f = 1; } } return { value: t, done: y }; }; }(r, o, i), !0), u; } var a = {}; function Generator() {} function GeneratorFunction() {} function GeneratorFunctionPrototype() {} t = Object.getPrototypeOf; var c = [][n] ? t(t([][n]())) : (_regeneratorDefine2(t = {}, n, function () { return this; }), t), u = GeneratorFunctionPrototype.prototype = Generator.prototype = Object.create(c); function f(e) { return Object.setPrototypeOf ? Object.setPrototypeOf(e, GeneratorFunctionPrototype) : (e.__proto__ = GeneratorFunctionPrototype, _regeneratorDefine2(e, o, \"GeneratorFunction\")), e.prototype = Object.create(u), e; } return GeneratorFunction.prototype = GeneratorFunctionPrototype, _regeneratorDefine2(u, \"constructor\", GeneratorFunctionPrototype), _regeneratorDefine2(GeneratorFunctionPrototype, \"constructor\", GeneratorFunction), GeneratorFunction.displayName = \"GeneratorFunction\", _regeneratorDefine2(GeneratorFunctionPrototype, o, \"GeneratorFunction\"), _regeneratorDefine2(u), _regeneratorDefine2(u, o, \"Generator\"), _regeneratorDefine2(u, n, function () { return this; }), _regeneratorDefine2(u, \"toString\", function () { return \"[object Generator]\"; }), (_regenerator = function _regenerator() { return { w: i, m: f }; })(); }\nfunction _regeneratorDefine2(e, r, n, t) { var i = Object.defineProperty; try { i({}, \"\", {}); } catch (e) { i = 0; } _regeneratorDefine2 = function _regeneratorDefine(e, r, n, t) { function o(r, n) { _regeneratorDefine2(e, r, function (e) { return this._invoke(r, n, e); }); } r ? i ? i(e, r, { value: n, enumerable: !t, configurable: !t, writable: !t }) : e[r] = n : (o(\"next\", 0), o(\"throw\", 1), o(\"return\", 2)); }, _regeneratorDefine2(e, r, n, t); }\n\n\n\n\n\n// ------ Helpers: Leaflet loaders ------\nvar leafletLoaderPromise = null;\nfunction loadLeaflet() {\n  if (window.L) return Promise.resolve(window.L);\n  if (leafletLoaderPromise) return leafletLoaderPromise;\n  leafletLoaderPromise = new Promise(function (resolve, reject) {\n    var link = document.createElement('link');\n    link.rel = 'stylesheet';\n    link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';\n    document.head.appendChild(link);\n    var script = document.createElement('script');\n    script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';\n    script.async = true;\n    script.defer = true;\n    script.onload = function () {\n      return resolve(window.L);\n    };\n    script.onerror = function () {\n      return reject(new Error('Failed to load Leaflet'));\n    };\n    document.body.appendChild(script);\n  });\n  return leafletLoaderPromise;\n}\nvar markerClusterLoaderPromise = null;\nfunction loadMarkerCluster() {\n  if (window.L && window.L.markerClusterGroup) return Promise.resolve(true);\n  if (markerClusterLoaderPromise) return markerClusterLoaderPromise;\n  markerClusterLoaderPromise = new Promise(function (resolve, reject) {\n    var link1 = document.createElement('link');\n    link1.rel = 'stylesheet';\n    link1.href = 'https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css';\n    document.head.appendChild(link1);\n    var link2 = document.createElement('link');\n    link2.rel = 'stylesheet';\n    link2.href = 'https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css';\n    document.head.appendChild(link2);\n    var script = document.createElement('script');\n    script.src = 'https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js';\n    script.async = true;\n    script.defer = true;\n    script.onload = function () {\n      return resolve(true);\n    };\n    script.onerror = function () {\n      return reject(new Error('Failed to load MarkerCluster'));\n    };\n    document.body.appendChild(script);\n  });\n  return markerClusterLoaderPromise;\n}\n\n// ------ Helper: html2canvas loader ------\nvar html2canvasLoaderPromise = null;\nfunction loadHtml2Canvas() {\n  if (window.html2canvas) return Promise.resolve(window.html2canvas);\n  if (html2canvasLoaderPromise) return html2canvasLoaderPromise;\n  html2canvasLoaderPromise = new Promise(function (resolve, reject) {\n    var script = document.createElement('script');\n    script.src = 'https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js';\n    script.async = true;\n    script.defer = true;\n    script.onload = function () {\n      return resolve(window.html2canvas);\n    };\n    script.onerror = function () {\n      return reject(new Error('Failed to load html2canvas'));\n    };\n    document.body.appendChild(script);\n  });\n  return html2canvasLoaderPromise;\n}\nfunction uid() {\n  return Math.random().toString(36).slice(2, 9);\n}\nvar DEFAULT_CENTER = {\n  lat: 39.9042,\n  lng: 116.4074\n};\nfunction hasTdtToken() {\n  return !!(typeof window !== 'undefined' && window.CONFIG && window.CONFIG.TIANDITU_TOKEN);\n}\nfunction getNowDateTime() {\n  var now = new Date();\n  var p = function p(n) {\n    return n < 10 ? '0' + n : '' + n;\n  };\n  return {\n    date: \"\".concat(now.getFullYear(), \"-\").concat(p(now.getMonth() + 1), \"-\").concat(p(now.getDate())),\n    time: \"\".concat(p(now.getHours()), \":\").concat(p(now.getMinutes()))\n  };\n}\nfunction getRuntimeMapConfig() {\n  var c = typeof window !== 'undefined' && window.CONFIG ? window.CONFIG : {};\n  return {\n    initialZoom: typeof c.MAP_INITIAL_ZOOM === 'number' ? c.MAP_INITIAL_ZOOM : 11,\n    customTile: {\n      url: c.MAP_TILE_URL || '',\n      attribution: c.MAP_ATTRIBUTION || '',\n      subdomains: c.MAP_SUBDOMAINS || undefined\n    }\n  };\n}\n\n// distance helpers\nfunction toRad(v) {\n  return v * Math.PI / 180;\n}\nfunction haversineKm(aLat, aLng, bLat, bLng) {\n  var R = 6371;\n  var dLat = toRad(bLat - aLat);\n  var dLng = toRad(bLng - aLng);\n  var la1 = toRad(aLat),\n    la2 = toRad(bLat);\n  var h = Math.pow(Math.sin(dLat / 2), 2) + Math.cos(la1) * Math.cos(la2) * Math.pow(Math.sin(dLng / 2), 2);\n  return 2 * R * Math.asin(Math.min(1, Math.sqrt(h)));\n}\nfunction formatCnDate(iso) {\n  if (!iso) return '';\n  var _iso$split = iso.split('-'),\n    _iso$split2 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_iso$split, 3),\n    y = _iso$split2[0],\n    m = _iso$split2[1],\n    d = _iso$split2[2];\n  return (m ? String(parseInt(m, 10)) : '') + '月' + (d ? String(parseInt(d, 10)) : '') + '日';\n}\nfunction sameCityOrProvince(a, b) {\n  if (!a || !b) return false;\n  var ac = a.city || a.county || a.district || a.province || a.state;\n  var bc = b.city || b.county || b.district || b.province || b.state;\n  if (ac && bc && ac === bc) return true;\n  var ap = a.province || a.state;\n  var bp = b.province || b.state;\n  if (ap && bp && ap === bp) return true;\n  return false;\n}\nfunction recommendTransport(km) {\n  var fromItem = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : null;\n  var toItem = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : null;\n  if (!isFinite(km)) return '步行';\n  var intraCity = sameCityOrProvince(fromItem, toItem);\n  if (intraCity) {\n    if (km < 1.2) return '步行';\n    if (km < 8) return '地铁/公交';\n    if (km < 25) return '打车/网约车';\n    if (km < 60) return '城际快线/高铁';\n    return '高铁/飞机';\n  } else {\n    if (km < 3) return '打车/公交';\n    if (km < 50) return '大巴/自驾';\n    if (km < 300) return '高铁/动车';\n    if (km < 800) return '高铁/飞机';\n    return '飞机';\n  }\n}\nfunction formatCnAddress(addr, displayName) {\n  if (!addr) return displayName || '';\n  var p = [];\n  var province = addr.state || addr.province || '';\n  var city = addr.city || addr.town || addr.village || '';\n  var district = addr.city_district || addr.district || addr.county || '';\n  var road = addr.road || addr.residential || addr.neighbourhood || '';\n  var house = addr.house_number || '';\n  var poi = addr.amenity || addr.tourism || addr.building || addr.hotel || addr.shop || '';\n  if (province) p.push(province);\n  if (city && !p.includes(city)) p.push(city);\n  if (district) p.push(district);\n  if (road) p.push(road + (house ? house : ''));\n  if (poi) p.push(poi);\n  var s = p.join('');\n  return s || displayName || '';\n}\n\n// ------ China coordinate conversions (GCJ-02 <-> WGS84) for AMap/Tencent results ------\nvar PI = Math.PI;\nfunction outOfChina(lng, lat) {\n  return lng < 72.004 || lng > 137.8347 || lat < 0.8293 || lat > 55.8271;\n}\nfunction transformLat(x, y) {\n  var ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));\n  ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;\n  ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;\n  ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;\n  return ret;\n}\nfunction transformLon(x, y) {\n  var ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));\n  ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;\n  ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;\n  ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;\n  return ret;\n}\nfunction wgs84ToGcj02(lng, lat) {\n  if (outOfChina(lng, lat)) return [lng, lat];\n  var a = 6378245.0;\n  var ee = 0.00669342162296594323;\n  var dLat = transformLat(lng - 105.0, lat - 35.0);\n  var dLon = transformLon(lng - 105.0, lat - 35.0);\n  var radLat = lat / 180.0 * PI;\n  var magic = Math.sin(radLat);\n  magic = 1 - ee * magic * magic;\n  var sqrtMagic = Math.sqrt(magic);\n  dLat = dLat * 180.0 / (a * (1 - ee) / (magic * sqrtMagic) * PI);\n  dLon = dLon * 180.0 / (a / sqrtMagic * Math.cos(radLat) * PI);\n  var mgLat = lat + dLat;\n  var mgLon = lng + dLon;\n  return [mgLon, mgLat];\n}\nfunction gcj02ToWgs84(lng, lat) {\n  if (outOfChina(lng, lat)) return [lng, lat];\n  var _wgs84ToGcj = wgs84ToGcj02(lng, lat),\n    _wgs84ToGcj2 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_wgs84ToGcj, 2),\n    mgLng = _wgs84ToGcj2[0],\n    mgLat = _wgs84ToGcj2[1];\n  var dLng = mgLng - lng;\n  var dLat = mgLat - lat;\n  return [lng - dLng, lat - dLat];\n}\nfunction getAmapKey() {\n  try {\n    return window && window.CONFIG && window.CONFIG.AMAP_KEY ? String(window.CONFIG.AMAP_KEY) : '';\n  } catch (_) {\n    return '';\n  }\n}\n\n// ------ Fallback helpers: extract city token and find city center ------\nfunction extractCityFromQuery(q) {\n  var s = String(q || '');\n  var common = ['北京', '上海', '广州', '深圳', '武汉', '杭州', '南京', '成都', '重庆', '西安', '苏州', '天津', '郑州', '青岛', '长沙', '合肥', '福州', '厦门', '无锡', '宁波', '沈阳', '大连', '济南', '南昌', '昆明'];\n  for (var _i = 0, _common = common; _i < _common.length; _i++) {\n    var w = _common[_i];\n    if (s.includes(w)) return w;\n  }\n  var m = s.match(/([\\u4e00-\\u9fa5]{2,9})(?:市|州|盟|区|县)/);\n  if (m) return m[1];\n  return '';\n}\nfunction geocodeCityCenter(_x) {\n  return _geocodeCityCenter.apply(this, arguments);\n} // ------ Address-like handling: prioritize road match + nearby POI ------\nfunction _geocodeCityCenter() {\n  _geocodeCityCenter = (0,_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_4__[\"default\"])(/*#__PURE__*/_regenerator().m(function _callee18(name) {\n    var om, r, res, arr, _t23, _t24;\n    return _regenerator().w(function (_context20) {\n      while (1) switch (_context20.p = _context20.n) {\n        case 0:\n          if (name) {\n            _context20.n = 1;\n            break;\n          }\n          return _context20.a(2, null);\n        case 1:\n          _context20.p = 1;\n          _context20.n = 2;\n          return axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].get('https://geocoding-api.open-meteo.com/v1/search', {\n            params: {\n              name: name,\n              count: 1,\n              language: 'zh',\n              format: 'json'\n            },\n            timeout: 5000\n          });\n        case 2:\n          om = _context20.v;\n          r = om.data && om.data.results && om.data.results[0];\n          if (!r) {\n            _context20.n = 3;\n            break;\n          }\n          return _context20.a(2, {\n            lat: r.latitude,\n            lng: r.longitude\n          });\n        case 3:\n          _context20.n = 5;\n          break;\n        case 4:\n          _context20.p = 4;\n          _t23 = _context20.v;\n        case 5:\n          _context20.p = 5;\n          _context20.n = 6;\n          return axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].get('https://nominatim.openstreetmap.org/search', {\n            params: {\n              format: 'jsonv2',\n              q: name,\n              limit: 1,\n              addressdetails: 0,\n              'accept-language': 'zh-CN'\n            },\n            timeout: 4000\n          });\n        case 6:\n          res = _context20.v;\n          arr = Array.isArray(res.data) ? res.data : [];\n          if (!arr[0]) {\n            _context20.n = 7;\n            break;\n          }\n          return _context20.a(2, {\n            lat: parseFloat(arr[0].lat),\n            lng: parseFloat(arr[0].lon)\n          });\n        case 7:\n          _context20.n = 9;\n          break;\n        case 8:\n          _context20.p = 8;\n          _t24 = _context20.v;\n        case 9:\n          return _context20.a(2, null);\n      }\n    }, _callee18, null, [[5, 8], [1, 4]]);\n  }));\n  return _geocodeCityCenter.apply(this, arguments);\n}\nfunction parseAddressLikeQuery(q) {\n  var s = String(q || '').trim();\n  if (!s) return null;\n  // Heuristics: must contain a road token and/or a house number token\n  var roadRe = /([\\u4e00-\\u9fa5A-Za-z0-9·\\-]{2,20})(大道|大街|路|街|巷|弄|环路|快速路|高架|公路)/;\n  var numRe = /(\\d+|[Xx]{1,3})\\s*号?/; // allow xx/XX placeholders commonly used\n  var hasRoad = roadRe.test(s);\n  var hasNum = numRe.test(s);\n  if (!hasRoad && !hasNum) return null;\n  var roadM = s.match(roadRe);\n  var street = roadM ? roadM[1] + roadM[2] : '';\n  // Try to extract poi keyword after street/number tokens\n  var poiKeyword = '';\n  if (roadM) {\n    var after = s.slice(roadM.index + roadM[0].length).replace(/[，,。\\s]+/g, ' ').trim();\n    // common poi type words to keep\n    var keepTokens = ['酒店', '宾馆', '广场', '中心', '大厦', '公寓', '写字楼', '商场', '购物中心', '地铁站', '火车站'];\n    if (after) {\n      // If includes known type words, keep full; else if long, take last token\n      if (keepTokens.some(function (k) {\n        return after.includes(k);\n      })) poiKeyword = after;else {\n        var parts = after.split(/\\s+/);\n        poiKeyword = parts[parts.length - 1] || '';\n      }\n    }\n  }\n  var cityToken = extractCityFromQuery(s);\n  return {\n    street: street,\n    hasNum: hasNum,\n    poiKeyword: poiKeyword,\n    cityToken: cityToken\n  };\n}\nfunction searchAddressAssist(_x2, _x3, _x4, _x5) {\n  return _searchAddressAssist.apply(this, arguments);\n} // ------ Concurrency & retry helpers ------\nfunction _searchAddressAssist() {\n  _searchAddressAssist = (0,_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_4__[\"default\"])(/*#__PURE__*/_regenerator().m(function _callee19(query, mapRef, useMapBounds, cancelToken) {\n    var parsed, street, poiKeyword, cityToken, escapeRegex, overpassBBox, center, b, west, east, north, south, c, roadPoint, roadQL, res, els, el, lat, lon, nearby, key, resp, pois, around, q, ov, r, _els, _t25, _t26, _t27, _t28;\n    return _regenerator().w(function (_context21) {\n      while (1) switch (_context21.p = _context21.n) {\n        case 0:\n          parsed = parseAddressLikeQuery(query);\n          if (parsed) {\n            _context21.n = 1;\n            break;\n          }\n          return _context21.a(2, []);\n        case 1:\n          street = parsed.street, poiKeyword = parsed.poiKeyword, cityToken = parsed.cityToken;\n          escapeRegex = function escapeRegex(t) {\n            return String(t || '').replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n          }; // Determine bbox or fallback center\n          overpassBBox = '';\n          center = null;\n          try {\n            if (useMapBounds && mapRef.current) {\n              b = mapRef.current.getBounds();\n              west = b.getWest().toFixed(3), east = b.getEast().toFixed(3), north = b.getNorth().toFixed(3), south = b.getSouth().toFixed(3);\n              overpassBBox = \"\".concat(south, \",\").concat(west, \",\").concat(north, \",\").concat(east);\n            }\n            if (mapRef.current) center = mapRef.current.getCenter();\n          } catch (_) {}\n          if (!(!center && cityToken)) {\n            _context21.n = 5;\n            break;\n          }\n          _context21.p = 2;\n          _context21.n = 3;\n          return geocodeCityCenter(cityToken);\n        case 3:\n          c = _context21.v;\n          if (c) center = {\n            lat: c.lat,\n            lng: c.lng\n          };\n          _context21.n = 5;\n          break;\n        case 4:\n          _context21.p = 4;\n          _t25 = _context21.v;\n        case 5:\n          // Step 1: find the road line near bbox/city using Overpass\n          roadPoint = null;\n          _context21.p = 6;\n          roadQL = overpassBBox ? \"[out:json][timeout:10];\\n( way[\\\"highway\\\"][\\\"name:zh\\\"~\\\"\".concat(escapeRegex(street), \"\\\",i](\").concat(overpassBBox, \");\\n  way[\\\"highway\\\"][\\\"name\\\"~\\\"\").concat(escapeRegex(street), \"\\\",i](\").concat(overpassBBox, \");\\n  relation[\\\"route\\\"=\\\"road\\\"][\\\"name\\\"~\\\"\").concat(escapeRegex(street), \"\\\",i](\").concat(overpassBBox, \");\\n); out center 10;\") : center ? \"[out:json][timeout:10];\\n( way(around:4000,\".concat(center.lat, \",\").concat(center.lng, \")[\\\"highway\\\"][\\\"name:zh\\\"~\\\"\").concat(escapeRegex(street), \"\\\",i];\\n  way(around:4000,\").concat(center.lat, \",\").concat(center.lng, \")[\\\"highway\\\"][\\\"name\\\"~\\\"\").concat(escapeRegex(street), \"\\\",i];\\n); out center 10;\") : '';\n          if (!roadQL) {\n            _context21.n = 8;\n            break;\n          }\n          _context21.n = 7;\n          return axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].post('https://overpass-api.de/api/interpreter', \"data=\".concat(encodeURIComponent(roadQL)), {\n            headers: {\n              'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'\n            },\n            timeout: 7000,\n            cancelToken: cancelToken\n          });\n        case 7:\n          res = _context21.v;\n          els = res.data && res.data.elements || [];\n          if (els[0]) {\n            el = els[0];\n            lat = el.center && el.center.lat || el.lat;\n            lon = el.center && el.center.lon || el.lon;\n            if (isFinite(lat) && isFinite(lon)) roadPoint = {\n              lat: lat,\n              lon: lon\n            };\n          }\n        case 8:\n          _context21.n = 10;\n          break;\n        case 9:\n          _context21.p = 9;\n          _t26 = _context21.v;\n        case 10:\n          if (!roadPoint && center) {\n            roadPoint = {\n              lat: center.lat,\n              lon: center.lng\n            };\n          }\n          if (roadPoint) {\n            _context21.n = 11;\n            break;\n          }\n          return _context21.a(2, []);\n        case 11:\n          // If we have a poi keyword, try to find nearby POIs first (AMap preferred)\n          nearby = [];\n          if (!poiKeyword) {\n            _context21.n = 19;\n            break;\n          }\n          key = getAmapKey();\n          if (!key) {\n            _context21.n = 15;\n            break;\n          }\n          _context21.p = 12;\n          _context21.n = 13;\n          return axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].get('https://restapi.amap.com/v5/place/text', {\n            params: {\n              key: key,\n              keywords: poiKeyword,\n              page_size: 6,\n              page_num: 1,\n              location: \"\".concat(roadPoint.lon, \",\").concat(roadPoint.lat)\n            },\n            timeout: 5000,\n            cancelToken: cancelToken\n          });\n        case 13:\n          resp = _context21.v;\n          pois = resp.data && resp.data.pois || [];\n          nearby = pois.map(function (p) {\n            var lat = 0,\n              lon = 0;\n            if (p.location) {\n              var _String$split5 = String(p.location).split(','),\n                _String$split6 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_String$split5, 2),\n                x = _String$split6[0],\n                y = _String$split6[1];\n              lon = parseFloat(x);\n              lat = parseFloat(y);\n              var _gcj02ToWgs5 = gcj02ToWgs84(lon, lat),\n                _gcj02ToWgs6 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_gcj02ToWgs5, 2),\n                wgsLon = _gcj02ToWgs6[0],\n                wgsLat = _gcj02ToWgs6[1];\n              lon = wgsLon;\n              lat = wgsLat;\n            }\n            var title = p.name || poiKeyword;\n            var ad = [p.cityname || '', p.adname || '', p.address || ''].filter(Boolean).join(' ');\n            return {\n              place_id: String(p.id || ''),\n              osm_id: null,\n              display_name: ad ? \"\".concat(title, \" \\xB7 \").concat(ad) : title,\n              lat: String(lat),\n              lon: String(lon)\n            };\n          }).filter(function (d) {\n            return d.lat && d.lon;\n          });\n          _context21.n = 15;\n          break;\n        case 14:\n          _context21.p = 14;\n          _t27 = _context21.v;\n        case 15:\n          if (nearby.length) {\n            _context21.n = 19;\n            break;\n          }\n          _context21.p = 16;\n          around = 1800;\n          q = escapeRegex(poiKeyword);\n          ov = \"[out:json][timeout:12];\\n( node(around:\".concat(around, \",\").concat(roadPoint.lat, \",\").concat(roadPoint.lon, \")[\\\"name:zh\\\"~\\\"\").concat(q, \"\\\",i];\\n  way(around:\").concat(around, \",\").concat(roadPoint.lat, \",\").concat(roadPoint.lon, \")[\\\"name:zh\\\"~\\\"\").concat(q, \"\\\",i];\\n  relation(around:\").concat(around, \",\").concat(roadPoint.lat, \",\").concat(roadPoint.lon, \")[\\\"name:zh\\\"~\\\"\").concat(q, \"\\\",i];\\n  node(around:\").concat(around, \",\").concat(roadPoint.lat, \",\").concat(roadPoint.lon, \")[\\\"name\\\"~\\\"\").concat(q, \"\\\",i];\\n  way(around:\").concat(around, \",\").concat(roadPoint.lat, \",\").concat(roadPoint.lon, \")[\\\"name\\\"~\\\"\").concat(q, \"\\\",i];\\n  relation(around:\").concat(around, \",\").concat(roadPoint.lat, \",\").concat(roadPoint.lon, \")[\\\"name\\\"~\\\"\").concat(q, \"\\\",i];\\n); out center 20;\");\n          _context21.n = 17;\n          return axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].post('https://overpass-api.de/api/interpreter', \"data=\".concat(encodeURIComponent(ov)), {\n            headers: {\n              'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'\n            },\n            timeout: 9000,\n            cancelToken: cancelToken\n          });\n        case 17:\n          r = _context21.v;\n          _els = r.data && r.data.elements || [];\n          nearby = _els.slice(0, 12).map(function (el) {\n            var tags = el.tags || {};\n            var nameZh = tags['name:zh'];\n            var name = tags.name || nameZh || poiKeyword;\n            var lat = el.lat != null ? el.lat : el.center && el.center.lat;\n            var lon = el.lon != null ? el.lon : el.center && el.center.lon;\n            return {\n              place_id: String(el.id),\n              osm_id: el.id,\n              display_name: name,\n              lat: String(lat || ''),\n              lon: String(lon || '')\n            };\n          }).filter(function (d) {\n            return d.lat && d.lon;\n          });\n          _context21.n = 19;\n          break;\n        case 18:\n          _context21.p = 18;\n          _t28 = _context21.v;\n        case 19:\n          if (!nearby.length) {\n            _context21.n = 20;\n            break;\n          }\n          return _context21.a(2, nearby);\n        case 20:\n          return _context21.a(2, [{\n            place_id: null,\n            osm_id: null,\n            display_name: \"\".concat(street, \" \\u9644\\u8FD1\\uFF08\\u6309\\u9053\\u8DEF\\u5B9A\\u4F4D\\uFF09\"),\n            lat: String(roadPoint.lat),\n            lon: String(roadPoint.lon),\n            __approx: true\n          }]);\n      }\n    }, _callee19, null, [[16, 18], [12, 14], [6, 9], [2, 4]]);\n  }));\n  return _searchAddressAssist.apply(this, arguments);\n}\nfunction makeGate() {\n  var max = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 2;\n  var queue = [];\n  var running = 0;\n  var next = function next() {\n    var r = queue.shift();\n    if (r) r();\n  };\n  return /*#__PURE__*/function () {\n    var _run = (0,_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_4__[\"default\"])(/*#__PURE__*/_regenerator().m(function _callee(fn) {\n      return _regenerator().w(function (_context) {\n        while (1) switch (_context.p = _context.n) {\n          case 0:\n            if (!(running >= max)) {\n              _context.n = 1;\n              break;\n            }\n            _context.n = 1;\n            return new Promise(function (res) {\n              return queue.push(res);\n            });\n          case 1:\n            running++;\n            _context.p = 2;\n            _context.n = 3;\n            return fn();\n          case 3:\n            return _context.a(2, _context.v);\n          case 4:\n            _context.p = 4;\n            running--;\n            next();\n            return _context.f(4);\n          case 5:\n            return _context.a(2);\n        }\n      }, _callee, null, [[2,, 4, 5]]);\n    }));\n    function run(_x6) {\n      return _run.apply(this, arguments);\n    }\n    return run;\n  }();\n}\nfunction withRetry(_x7) {\n  return _withRetry.apply(this, arguments);\n}\nfunction _withRetry() {\n  _withRetry = (0,_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_4__[\"default\"])(/*#__PURE__*/_regenerator().m(function _callee20(task) {\n    var _ref24,\n      _ref24$retries,\n      retries,\n      _ref24$baseDelay,\n      baseDelay,\n      attempt,\n      _loop4,\n      _ret2,\n      _args23 = arguments;\n    return _regenerator().w(function (_context23) {\n      while (1) switch (_context23.n) {\n        case 0:\n          _ref24 = _args23.length > 1 && _args23[1] !== undefined ? _args23[1] : {}, _ref24$retries = _ref24.retries, retries = _ref24$retries === void 0 ? 2 : _ref24$retries, _ref24$baseDelay = _ref24.baseDelay, baseDelay = _ref24$baseDelay === void 0 ? 500 : _ref24$baseDelay;\n          attempt = 0; // eslint-disable-next-line no-constant-condition\n          _loop4 = /*#__PURE__*/_regenerator().m(function _loop4() {\n            var status, retriable, jitter, delay, _t29, _t30;\n            return _regenerator().w(function (_context22) {\n              while (1) switch (_context22.p = _context22.n) {\n                case 0:\n                  _context22.p = 0;\n                  _context22.n = 1;\n                  return task();\n                case 1:\n                  _t29 = _context22.v;\n                  return _context22.a(2, {\n                    v: _t29\n                  });\n                case 2:\n                  _context22.p = 2;\n                  _t30 = _context22.v;\n                  attempt++;\n                  status = _t30 && _t30.response && _t30.response.status; // 对 429/5xx/网络错误进行重试；其它 4xx 不重试\n                  retriable = !status || status >= 500 || status === 429;\n                  if (!(attempt > retries || !retriable)) {\n                    _context22.n = 3;\n                    break;\n                  }\n                  throw _t30;\n                case 3:\n                  jitter = 1 + Math.random() * 0.2;\n                  delay = Math.round(baseDelay * Math.pow(2, attempt - 1) * jitter);\n                  _context22.n = 4;\n                  return new Promise(function (r) {\n                    return setTimeout(r, delay);\n                  });\n                case 4:\n                  return _context22.a(2);\n              }\n            }, _loop4, null, [[0, 2]]);\n          });\n        case 1:\n          if (false) // removed by dead control flow\n{}\n          return _context23.d(_regeneratorValues(_loop4()), 2);\n        case 2:\n          _ret2 = _context23.v;\n          if (!_ret2) {\n            _context23.n = 3;\n            break;\n          }\n          return _context23.a(2, _ret2.v);\n        case 3:\n          _context23.n = 1;\n          break;\n        case 4:\n          return _context23.a(2);\n      }\n    }, _callee20);\n  }));\n  return _withRetry.apply(this, arguments);\n}\nvar gateNominatim = makeGate(2); // 搜索\nvar gateReverse = makeGate(2); // 逆地理\n\nvar searchCache = new Map();\nvar reverseCache = new Map();\nvar reverseCacheEn = new Map();\nvar MAX_SEARCH_CACHE = 200;\nfunction lruSet(map, key, val) {\n  var max = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : MAX_SEARCH_CACHE;\n  if (map.has(key)) map[\"delete\"](key);\n  map.set(key, val);\n  if (map.size > max) {\n    var firstKey = map.keys().next().value;\n    map[\"delete\"](firstKey);\n  }\n}\nfunction JihuaPlanner() {\n  var containerRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)(null);\n  var headerRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)(null);\n  var mapRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)(null);\n  var tileLayerRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)(null);\n  var clusterGroupRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)(null);\n  var polylineGroupRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)(null);\n  var markersRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)({});\n  var locTopCountRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)(10);\n  var adjustLocCount = function adjustLocCount(latencyMs, failCount) {\n    if (latencyMs > 1200 || failCount > 3) locTopCountRef.current = 5;else if (latencyMs < 500 && failCount === 0) locTopCountRef.current = 10;\n  };\n  var _useState = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(false),\n    _useState2 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState, 2),\n    mapReady = _useState2[0],\n    setMapReady = _useState2[1];\n  var _useState3 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)('我的旅行计划'),\n    _useState4 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState3, 2),\n    planName = _useState4[0],\n    setPlanName = _useState4[1];\n  var _useState5 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(null),\n    _useState6 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState5, 2),\n    planId = _useState6[0],\n    setPlanId = _useState6[1];\n  var _useState7 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)([]),\n    _useState8 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState7, 2),\n    items = _useState8[0],\n    setItems = _useState8[1];\n  var _useState9 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(''),\n    _useState0 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState9, 2),\n    error = _useState0[0],\n    setError = _useState0[1];\n  var _useState1 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(null),\n    _useState10 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState1, 2),\n    dragIndex = _useState10[0],\n    setDragIndex = _useState10[1];\n  var _useState11 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(''),\n    _useState12 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState11, 2),\n    searchQuery = _useState12[0],\n    setSearchQuery = _useState12[1];\n  var _useState13 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(true),\n    _useState14 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState13, 2),\n    useMapBounds = _useState14[0],\n    setUseMapBounds = _useState14[1];\n  var _useState15 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)('list'),\n    _useState16 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState15, 2),\n    viewMode = _useState16[0],\n    setViewMode = _useState16[1];\n  var _useState17 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(function () {\n      try {\n        var v = localStorage.getItem('jihua_show_extra');\n        return v === '1';\n      } catch (_) {\n        return false;\n      }\n    }),\n    _useState18 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState17, 2),\n    showExtra = _useState18[0],\n    setShowExtra = _useState18[1];\n  var _useState19 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(Math.round(window.innerHeight * 0.46)),\n    _useState20 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState19, 2),\n    mapHeight = _useState20[0],\n    setMapHeight = _useState20[1];\n  var draggingRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)(false);\n  var startYRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)(0);\n  var startHRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)(0);\n  var _useState21 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(false),\n    _useState22 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState21, 2),\n    timelineManualOrder = _useState22[0],\n    setTimelineManualOrder = _useState22[1];\n  var _useState23 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(null),\n    _useState24 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState23, 2),\n    timelineDragIndex = _useState24[0],\n    setTimelineDragIndex = _useState24[1];\n  var tileErrorCountRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)(0);\n  var fallbackAppliedRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)(false);\n  // Supplies: my templates (local)\n  var revDelayRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)(140);\n  var suggestionsRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)([]);\n  (0,react__WEBPACK_IMPORTED_MODULE_6__.useEffect)(function () {\n    suggestionsRef.current = suggestions;\n  }, [suggestions]);\n  var lastAdminRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)({\n    tag: '',\n    lat: null,\n    lng: null,\n    t: 0\n  });\n  var sleep = function sleep(ms) {\n    return new Promise(function (r) {\n      return setTimeout(r, ms);\n    });\n  };\n  var _useState25 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(function () {\n      try {\n        var s = localStorage.getItem('jihua_supplies_templates');\n        var arr = s ? JSON.parse(s) : [];\n        return Array.isArray(arr) ? arr : [];\n      } catch (_) {\n        return [];\n      }\n    }),\n    _useState26 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState25, 2),\n    myTemplates = _useState26[0],\n    setMyTemplates = _useState26[1];\n  var _useState27 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(''),\n    _useState28 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState27, 2),\n    selectedTplName = _useState28[0],\n    setSelectedTplName = _useState28[1];\n  // Suggestions UI state\n  var _useState29 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)([]),\n    _useState30 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState29, 2),\n    suggestions = _useState30[0],\n    setSuggestions = _useState30[1];\n  // Suggestions visible count (user configurable)\n  var _useState31 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(function () {\n      try {\n        var n = parseInt(localStorage.getItem('jihua_sugg_max') || '5', 10);\n        return [3, 5, 8].includes(n) ? n : 5;\n      } catch (_) {\n        return 5;\n      }\n    }),\n    _useState32 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState31, 2),\n    suggMax = _useState32[0],\n    setSuggMax = _useState32[1];\n  (0,react__WEBPACK_IMPORTED_MODULE_6__.useEffect)(function () {\n    try {\n      localStorage.setItem('jihua_sugg_max', String(suggMax));\n    } catch (_) {}\n  }, [suggMax]);\n  // Context menu state/refs\n  var _useState33 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)({\n      show: false,\n      x: 0,\n      y: 0,\n      itemId: null\n    }),\n    _useState34 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState33, 2),\n    menu = _useState34[0],\n    setMenu = _useState34[1];\n  var lpTimerRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)(null);\n  var chipLpTimerRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)(null);\n  // Map tiles state/refs\n  var _useState35 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)('amap'),\n    _useState36 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState35, 2),\n    tileKey = _useState36[0],\n    setTileKey = _useState36[1];\n  var fallbackStageRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)(0);\n  // Supplies modal state\n  var _useState37 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(false),\n    _useState38 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState37, 2),\n    showSupplies = _useState38[0],\n    setShowSupplies = _useState38[1];\n  var _useState39 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(''),\n    _useState40 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState39, 2),\n    suppliesText = _useState40[0],\n    setSuppliesText = _useState40[1];\n  var suppliesDebounceRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)(null);\n  // Fill geo names state\n  var _useState41 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(false),\n    _useState42 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState41, 2),\n    fillGeoBusy = _useState42[0],\n    setFillGeoBusy = _useState42[1];\n  var _useState43 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)({\n      done: 0,\n      total: 0\n    }),\n    _useState44 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState43, 2),\n    fillProgress = _useState44[0],\n    setFillProgress = _useState44[1];\n  // Routing distance state/refs\n  var _useState45 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(false),\n    _useState46 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState45, 2),\n    useRouteDistance = _useState46[0],\n    setUseRouteDistance = _useState46[1];\n  var _useState47 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)([]),\n    _useState48 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState47, 2),\n    routeDistances = _useState48[0],\n    setRouteDistances = _useState48[1];\n  var routeCacheRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)(new Map());\n  var _useState49 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(''),\n    _useState50 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState49, 2),\n    osrmWarn = _useState50[0],\n    setOsrmWarn = _useState50[1];\n  var _useState51 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(false),\n    _useState52 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState51, 2),\n    showActionMore = _useState52[0],\n    setShowActionMore = _useState52[1];\n  // Import-from-text (Beta)\n  var _useState53 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(false),\n    _useState54 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState53, 2),\n    showImport = _useState54[0],\n    setShowImport = _useState54[1];\n  var _useState55 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(''),\n    _useState56 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState55, 2),\n    importText = _useState56[0],\n    setImportText = _useState56[1];\n  var _useState57 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(function () {\n      return getNowDateTime().date;\n    }),\n    _useState58 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState57, 2),\n    importDay1Date = _useState58[0],\n    setImportDay1Date = _useState58[1];\n  var _useState59 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)([]),\n    _useState60 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState59, 2),\n    importPreview = _useState60[0],\n    setImportPreview = _useState60[1]; // { name, time, notes, dayIndex, candidates?, selectedIdx? }\n  var _useState61 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(false),\n    _useState62 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState61, 2),\n    importParsing = _useState62[0],\n    setImportParsing = _useState62[1];\n  var _useState63 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(false),\n    _useState64 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState63, 2),\n    importGeocoding = _useState64[0],\n    setImportGeocoding = _useState64[1];\n  // Place-on-map mode for unlocated items: holds itemId to place on next map click\n  var placingRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)(null);\n  // Circuit breaker: temporarily disable Nominatim after repeated timeouts\n  var nomiBlockedUntilRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)(0);\n\n  // Geocoding mode: 'stable' (Photon + BigDataCloud only), 'auto' (Nominatim + Photon; reverse prefers Nominatim), 'nominatim'\n  var getGeoMode = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(function () {\n    try {\n      var cfg = window && window.CONFIG ? window.CONFIG : {};\n      var ls = localStorage.getItem('jihua_geo_mode') || '';\n      var v = String(ls || cfg.GEO_MODE || 'stable').toLowerCase(); // default to 'stable' to avoid frequent timeouts\n      if (v === 'stable' || v === 'auto' || v === 'nominatim') return v;\n      return 'stable';\n    } catch (_) {\n      return 'stable';\n    }\n  }, []);\n  var dispatch = (0,react_redux__WEBPACK_IMPORTED_MODULE_8__.useDispatch)();\n  var _useSelector = (0,react_redux__WEBPACK_IMPORTED_MODULE_8__.useSelector)(function (state) {\n      return {\n        travelPlans: state.travelPlans,\n        travelPlansLoading: state.travelPlansLoading,\n        travelPlansError: state.travelPlansError,\n        currentPlan: state.currentPlan,\n        planSaving: state.planSaving,\n        planSaveError: state.planSaveError,\n        planDeleting: state.planDeleting,\n        planDeleteError: state.planDeleteError,\n        currentPlanError: state.currentPlanError\n      };\n    }),\n    travelPlans = _useSelector.travelPlans,\n    travelPlansLoading = _useSelector.travelPlansLoading,\n    travelPlansError = _useSelector.travelPlansError,\n    currentPlan = _useSelector.currentPlan,\n    planSaving = _useSelector.planSaving,\n    planSaveError = _useSelector.planSaveError,\n    planDeleting = _useSelector.planDeleting,\n    planDeleteError = _useSelector.planDeleteError,\n    currentPlanError = _useSelector.currentPlanError;\n\n  // ---- Map init ----\n  (0,react__WEBPACK_IMPORTED_MODULE_6__.useEffect)(function () {\n    var canceled = false;\n    loadLeaflet().then(function () {\n      if (canceled) return;\n      var initialZoom = getRuntimeMapConfig().initialZoom;\n      var L = window.L;\n      var map = L.map(containerRef.current, {\n        zoomAnimation: false,\n        markerZoomAnimation: false,\n        scrollWheelZoom: true\n      }).setView([DEFAULT_CENTER.lat, DEFAULT_CENTER.lng], initialZoom);\n      var applyTile = function applyTile(key) {\n        var defaultTile = {\n          url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',\n          attribution: '&copy; OpenStreetMap contributors',\n          subdomains: ['a', 'b', 'c']\n        };\n        var builtInTiles = {\n          \"default\": defaultTile,\n          amap: {\n            url: 'https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=7&x={x}&y={y}&z={z}',\n            attribution: '© 高德地图(仅供开发调试)',\n            subdomains: ['1', '2', '3', '4']\n          },\n          geoqBlue: {\n            url: 'https://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineStreetPurplishBlue/MapServer/tile/{z}/{y}/{x}',\n            attribution: '© GeoQ'\n          },\n          geoqGray: {\n            url: 'https://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineStreetGray/MapServer/tile/{z}/{y}/{x}',\n            attribution: '© GeoQ'\n          },\n          geoqWarm: {\n            url: 'https://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineStreetWarm/MapServer/tile/{z}/{y}/{x}',\n            attribution: '© GeoQ'\n          },\n          esriStreet: {\n            url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}',\n            attribution: '© Esri'\n          },\n          esriImagery: {\n            url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',\n            attribution: '© Esri'\n          },\n          tdtVec: hasTdtToken() ? {\n            compose: [{\n              url: 'https://t{s}.tianditu.gov.cn/vec_w/wmts?service=wmts&request=GetTile&version=1.0.0&layer=vec&tilematrixSet=w&TileMatrix={z}&TileRow={y}&TileCol={x}&style=default&format=tiles&tk=' + window.CONFIG.TIANDITU_TOKEN,\n              subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']\n            }, {\n              url: 'https://t{s}.tianditu.gov.cn/cva_w/wmts?service=wmts&request=GetTile&version=1.0.0&layer=cva&tilematrixSet=w&TileMatrix={z}&TileRow={y}&TileCol={x}&style=default&format=tiles&tk=' + window.CONFIG.TIANDITU_TOKEN,\n              subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']\n            }],\n            attribution: '© 天地图'\n          } : undefined,\n          tdtImg: hasTdtToken() ? {\n            compose: [{\n              url: 'https://t{s}.tianditu.gov.cn/img_w/wmts?service=wmts&request=GetTile&version=1.0.0&layer=img&tilematrixSet=w&TileMatrix={z}&TileRow={y}&TileCol={x}&style=default&format=tiles&tk=' + window.CONFIG.TIANDITU_TOKEN,\n              subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']\n            }, {\n              url: 'https://t{s}.tianditu.gov.cn/cia_w/wmts?service=wmts&request=GetTile&version=1.0.0&layer=cia&tilematrixSet=w&TileMatrix={z}&TileRow={y}&TileCol={x}&style=default&format=tiles&tk=' + window.CONFIG.TIANDITU_TOKEN,\n              subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']\n            }],\n            attribution: '© 天地图'\n          } : undefined\n        };\n        var chooseFallback = function chooseFallback() {\n          var stage = fallbackStageRef.current;\n          fallbackStageRef.current = stage + 1;\n          if (stage === 0) return 'amap';\n          if (stage === 1 && hasTdtToken()) return 'tdtVec';\n          if (stage === 1 && !hasTdtToken()) return 'esriStreet';\n          if (stage === 2) return 'esriStreet';\n          if (stage === 3) return 'esriImagery';\n          return 'default';\n        };\n        var _getRuntimeMapConfig = getRuntimeMapConfig(),\n          customTile = _getRuntimeMapConfig.customTile;\n        var conf = defaultTile;\n        if (key in builtInTiles && builtInTiles[key]) conf = builtInTiles[key];else if (key === 'custom' && customTile.url) {\n          conf = {\n            url: customTile.url,\n            attribution: customTile.attribution || defaultTile.attribution,\n            subdomains: customTile.subdomains || defaultTile.subdomains\n          };\n        }\n        if (tileLayerRef.current) {\n          try {\n            tileLayerRef.current.remove();\n          } catch (e) {}\n          tileLayerRef.current = null;\n        }\n        // 切换源时重置计数与回退阶段\n        tileErrorCountRef.current = 0;\n        fallbackAppliedRef.current = false;\n        fallbackStageRef.current = 0;\n        if (conf && conf.compose && Array.isArray(conf.compose)) {\n          var layers = conf.compose.map(function (c) {\n            var opts = {\n              attribution: conf.attribution || c.attribution,\n              maxZoom: 19,\n              crossOrigin: true,\n              updateWhenIdle: true\n            };\n            if (c.subdomains) opts.subdomains = c.subdomains;\n            var lyr = L.tileLayer(c.url, opts);\n            lyr.on('tileerror', function () {\n              if (fallbackAppliedRef.current) return;\n              if (++tileErrorCountRef.current >= 2) {\n                fallbackAppliedRef.current = true;\n                setTileKey(chooseFallback());\n              }\n            });\n            return lyr;\n          });\n          tileLayerRef.current = L.layerGroup(layers).addTo(map);\n        } else {\n          var opts = {\n            attribution: conf.attribution,\n            maxZoom: 19,\n            crossOrigin: true,\n            updateWhenIdle: true\n          };\n          if (conf.subdomains) opts.subdomains = conf.subdomains;\n          var layer = L.tileLayer(conf.url, opts);\n          layer.on('tileerror', function () {\n            if (fallbackAppliedRef.current) return;\n            if (++tileErrorCountRef.current >= 2) {\n              fallbackAppliedRef.current = true;\n              setTileKey(chooseFallback());\n            }\n          });\n          tileLayerRef.current = layer.addTo(map);\n        }\n      };\n      applyTile(tileKey);\n      mapRef.current = map;\n      setMapReady(true);\n      map.on('click', /*#__PURE__*/function () {\n        var _ref = (0,_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_4__[\"default\"])(/*#__PURE__*/_regenerator().m(function _callee2(e) {\n          var lat, lng, now, targetId, base, info, tempItem, _info, _t, _t2;\n          return _regenerator().w(function (_context2) {\n            while (1) switch (_context2.p = _context2.n) {\n              case 0:\n                lat = e.latlng.lat;\n                lng = e.latlng.lng;\n                now = getNowDateTime(); // If we're placing an existing unlocated item, consume this click\n                if (!placingRef.current) {\n                  _context2.n = 5;\n                  break;\n                }\n                targetId = placingRef.current;\n                placingRef.current = null;\n                // ensure marker added and coords set for that item\n                base = null;\n                setItems(function (prev) {\n                  var next = prev.map(function (it) {\n                    if (it.id === targetId) {\n                      base = _objectSpread(_objectSpread({}, it), {}, {\n                        lat: lat,\n                        lng: lng,\n                        unlocated: false\n                      });\n                      return base;\n                    }\n                    return it;\n                  });\n                  return next;\n                });\n                if (!base) {\n                  _context2.n = 4;\n                  break;\n                }\n                try {\n                  addMarkerForItem(base);\n                } catch (_) {}\n                _context2.p = 1;\n                _context2.n = 2;\n                return reverseGeocodeMultiDetailed(lat, lng);\n              case 2:\n                info = _context2.v;\n                setItems(function (prev) {\n                  return prev.map(function (it) {\n                    return it.id === base.id ? _objectSpread(_objectSpread({}, it), {}, {\n                      name: info.cn || it.name,\n                      nameLocal: info.local || '',\n                      city: info.city || '',\n                      province: info.province || '',\n                      country: info.country || ''\n                    }) : it;\n                  });\n                });\n                _context2.n = 4;\n                break;\n              case 3:\n                _context2.p = 3;\n                _t = _context2.v;\n              case 4:\n                return _context2.a(2);\n              case 5:\n                if (window.confirm('在此位置添加标记点并加入行程？')) {\n                  _context2.n = 6;\n                  break;\n                }\n                return _context2.a(2);\n              case 6:\n                tempItem = {\n                  id: uid(),\n                  placeId: '',\n                  name: '标记点',\n                  lat: lat,\n                  lng: lng,\n                  date: now.date,\n                  time: now.time,\n                  notes: '',\n                  nameLocal: '',\n                  city: '',\n                  province: '',\n                  country: ''\n                };\n                addMarkerForItem(tempItem);\n                setItems(function (prev) {\n                  return [].concat((0,_babel_runtime_helpers_toConsumableArray__WEBPACK_IMPORTED_MODULE_2__[\"default\"])(prev), [tempItem]);\n                });\n                _context2.p = 7;\n                _context2.n = 8;\n                return reverseGeocodeMultiDetailed(lat, lng);\n              case 8:\n                _info = _context2.v;\n                setItems(function (prev) {\n                  return prev.map(function (it) {\n                    return it.id === tempItem.id ? _objectSpread(_objectSpread({}, it), {}, {\n                      name: _info.cn || it.name,\n                      nameLocal: _info.local || '',\n                      city: _info.city || '',\n                      province: _info.province || '',\n                      country: _info.country || ''\n                    }) : it;\n                  });\n                });\n                _context2.n = 10;\n                break;\n              case 9:\n                _context2.p = 9;\n                _t2 = _context2.v;\n              case 10:\n                return _context2.a(2);\n            }\n          }, _callee2, null, [[7, 9], [1, 3]]);\n        }));\n        return function (_x8) {\n          return _ref.apply(this, arguments);\n        };\n      }());\n\n      // lazy cluster\n      loadMarkerCluster().then(function () {\n        if (!window.L || !mapRef.current) return;\n        var group = window.L.markerClusterGroup({\n          showCoverageOnHover: false,\n          spiderfyOnMaxZoom: true,\n          chunkedLoading: true,\n          removeOutsideVisibleBounds: true\n        });\n        clusterGroupRef.current = group;\n        map.addLayer(group);\n        Object.values(markersRef.current).forEach(function (m) {\n          try {\n            group.addLayer(m);\n          } catch (_) {}\n        });\n      })[\"catch\"](function () {});\n\n      // polylines group\n      try {\n        polylineGroupRef.current = window.L.layerGroup().addTo(map);\n      } catch (_) {\n        polylineGroupRef.current = null;\n      }\n    })[\"catch\"](function (e) {\n      return setError(e.message);\n    });\n    return function () {\n      canceled = true;\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  // Switch tiles at runtime\n  (0,react__WEBPACK_IMPORTED_MODULE_6__.useEffect)(function () {\n    if (!mapRef.current || !window.L) return;\n    var L = window.L;\n    var defaultTile = {\n      url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',\n      attribution: '&copy; OpenStreetMap contributors',\n      subdomains: ['a', 'b', 'c']\n    };\n    var builtInTiles = {\n      \"default\": defaultTile,\n      amap: {\n        url: 'https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=7&x={x}&y={y}&z={z}',\n        attribution: '© 高德地图(仅供开发调试)',\n        subdomains: ['1', '2', '3', '4']\n      },\n      geoqBlue: {\n        url: 'https://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineStreetPurplishBlue/MapServer/tile/{z}/{y}/{x}',\n        attribution: '© GeoQ'\n      },\n      geoqGray: {\n        url: 'https://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineStreetGray/MapServer/tile/{z}/{y}/{x}',\n        attribution: '© GeoQ'\n      },\n      geoqWarm: {\n        url: 'https://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineStreetWarm/MapServer/tile/{z}/{y}/{x}',\n        attribution: '© GeoQ'\n      },\n      esriStreet: {\n        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}',\n        attribution: '© Esri'\n      },\n      esriImagery: {\n        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',\n        attribution: '© Esri'\n      },\n      tdtVec: hasTdtToken() ? {\n        compose: [{\n          url: 'https://t{s}.tianditu.gov.cn/vec_w/wmts?service=wmts&request=GetTile&version=1.0.0&layer=vec&tilematrixSet=w&TileMatrix={z}&TileRow={y}&TileCol={x}&style=default&format=tiles&tk=' + window.CONFIG.TIANDITU_TOKEN,\n          subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']\n        }, {\n          url: 'https://t{s}.tianditu.gov.cn/cva_w/wmts?service=wmts&request=GetTile&version=1.0.0&layer=cva&tilematrixSet=w&TileMatrix={z}&TileRow={y}&TileCol={x}&style=default&format=tiles&tk=' + window.CONFIG.TIANDITU_TOKEN,\n          subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']\n        }],\n        attribution: '© 天地图'\n      } : undefined,\n      tdtImg: hasTdtToken() ? {\n        compose: [{\n          url: 'https://t{s}.tianditu.gov.cn/img_w/wmts?service=wmts&request=GetTile&version=1.0.0&layer=img&tilematrixSet=w&TileMatrix={z}&TileRow={y}&TileCol={x}&style=default&format=tiles&tk=' + window.CONFIG.TIANDITU_TOKEN,\n          subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']\n        }, {\n          url: 'https://t{s}.tianditu.gov.cn/cia_w/wmts?service=wmts&request=GetTile&version=1.0.0&layer=cia&tilematrixSet=w&TileMatrix={z}&TileRow={y}&TileCol={x}&style=default&format=tiles&tk=' + window.CONFIG.TIANDITU_TOKEN,\n          subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']\n        }],\n        attribution: '© 天地图'\n      } : undefined\n    };\n    var _getRuntimeMapConfig2 = getRuntimeMapConfig(),\n      customTile = _getRuntimeMapConfig2.customTile;\n    var conf = defaultTile;\n    if (tileKey in builtInTiles && builtInTiles[tileKey]) conf = builtInTiles[tileKey];else if (tileKey === 'custom' && customTile.url) {\n      conf = {\n        url: customTile.url,\n        attribution: customTile.attribution || defaultTile.attribution,\n        subdomains: customTile.subdomains || defaultTile.subdomains\n      };\n    }\n    if (tileLayerRef.current) {\n      try {\n        tileLayerRef.current.remove();\n      } catch (_) {}\n      tileLayerRef.current = null;\n    }\n    // 切换源时重置计数与回退阶段\n    tileErrorCountRef.current = 0;\n    fallbackAppliedRef.current = false;\n    fallbackStageRef.current = 0;\n    var chooseFallback = function chooseFallback() {\n      var stage = fallbackStageRef.current;\n      fallbackStageRef.current = stage + 1;\n      if (stage === 0) return 'amap';\n      if (stage === 1 && hasTdtToken()) return 'tdtVec';\n      if (stage === 1 && !hasTdtToken()) return 'esriStreet';\n      if (stage === 2) return 'esriStreet';\n      if (stage === 3) return 'esriImagery';\n      return 'default';\n    };\n    if (conf && conf.compose && Array.isArray(conf.compose)) {\n      var layers = conf.compose.map(function (c) {\n        var opts = {\n          attribution: conf.attribution || c.attribution,\n          maxZoom: 19,\n          crossOrigin: true,\n          updateWhenIdle: true\n        };\n        if (c.subdomains) opts.subdomains = c.subdomains;\n        var lyr = L.tileLayer(c.url, opts);\n        lyr.on('tileerror', function () {\n          if (fallbackAppliedRef.current) return;\n          if (++tileErrorCountRef.current >= 2) {\n            fallbackAppliedRef.current = true;\n            setTileKey(chooseFallback());\n          }\n        });\n        return lyr;\n      });\n      tileLayerRef.current = L.layerGroup(layers).addTo(mapRef.current);\n    } else {\n      var opts = {\n        attribution: conf.attribution,\n        maxZoom: 19,\n        crossOrigin: true,\n        updateWhenIdle: true\n      };\n      if (conf.subdomains) opts.subdomains = conf.subdomains;\n      var layer = L.tileLayer(conf.url, opts);\n      layer.on('tileerror', function () {\n        if (fallbackAppliedRef.current) return;\n        if (++tileErrorCountRef.current >= 2) {\n          fallbackAppliedRef.current = true;\n          setTileKey(chooseFallback());\n        }\n      });\n      tileLayerRef.current = layer.addTo(mapRef.current);\n    }\n  }, [tileKey]);\n  var addMarkerForItem = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(function (item) {\n    if (!mapRef.current || !window.L) return;\n    var marker = window.L.marker([item.lat, item.lng], {\n      draggable: true\n    });\n    if (clusterGroupRef.current && clusterGroupRef.current.addLayer) {\n      try {\n        clusterGroupRef.current.addLayer(marker);\n      } catch (_) {\n        marker.addTo(mapRef.current);\n      }\n    } else {\n      marker.addTo(mapRef.current);\n    }\n    marker.on('dragend', /*#__PURE__*/function () {\n      var _ref2 = (0,_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_4__[\"default\"])(/*#__PURE__*/_regenerator().m(function _callee3(e) {\n        var latlng, info, _t3;\n        return _regenerator().w(function (_context3) {\n          while (1) switch (_context3.p = _context3.n) {\n            case 0:\n              latlng = e.target.getLatLng();\n              setItems(function (prev) {\n                return prev.map(function (it) {\n                  return it.id === item.id ? _objectSpread(_objectSpread({}, it), {}, {\n                    lat: latlng.lat,\n                    lng: latlng.lng\n                  }) : it;\n                });\n              });\n              _context3.p = 1;\n              _context3.n = 2;\n              return reverseGeocodeMultiDetailed(latlng.lat, latlng.lng);\n            case 2:\n              info = _context3.v;\n              setItems(function (prev) {\n                return prev.map(function (it) {\n                  return it.id === item.id ? _objectSpread(_objectSpread({}, it), {}, {\n                    name: info.cn || it.name,\n                    nameLocal: info.local || '',\n                    city: info.city || '',\n                    province: info.province || '',\n                    country: info.country || ''\n                  }) : it;\n                });\n              });\n              _context3.n = 4;\n              break;\n            case 3:\n              _context3.p = 3;\n              _t3 = _context3.v;\n            case 4:\n              return _context3.a(2);\n          }\n        }, _callee3, null, [[1, 3]]);\n      }));\n      return function (_x9) {\n        return _ref2.apply(this, arguments);\n      };\n    }());\n    markersRef.current[item.id] = marker;\n  }, []);\n  (0,react__WEBPACK_IMPORTED_MODULE_6__.useEffect)(function () {\n    if (!window.L) return;\n    items.forEach(function (it, idx) {\n      var m = markersRef.current[it.id];\n      if (!m) return;\n      var icon = window.L && window.L.divIcon ? window.L.divIcon({\n        className: 'marker-index-icon',\n        html: \"<div>\".concat(idx + 1, \"</div>\"),\n        iconSize: [24, 24],\n        iconAnchor: [12, 12]\n      }) : undefined;\n      if (icon) m.setIcon(icon);\n    });\n  }, [items]);\n  var removeItem = function removeItem(id) {\n    setItems(function (prev) {\n      return prev.filter(function (it) {\n        return it.id !== id;\n      });\n    });\n    var m = markersRef.current[id];\n    if (m) {\n      if (clusterGroupRef.current && clusterGroupRef.current.removeLayer) {\n        try {\n          clusterGroupRef.current.removeLayer(m);\n        } catch (_) {\n          try {\n            m.remove();\n          } catch (_) {}\n        }\n      } else {\n        try {\n          m.remove();\n        } catch (_) {}\n      }\n      delete markersRef.current[id];\n    }\n  };\n  var moveItem = function moveItem(index, dir) {\n    setItems(function (prev) {\n      var next = prev.slice();\n      var ni = index + dir;\n      if (ni < 0 || ni >= next.length) return prev;\n      var _next$splice = next.splice(index, 1),\n        _next$splice2 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_next$splice, 1),\n        moved = _next$splice2[0];\n      next.splice(ni, 0, moved);\n      return next;\n    });\n  };\n  var reorder = function reorder(from, to) {\n    if (from == null || to == null || from === to) return;\n    setItems(function (prev) {\n      var next = prev.slice();\n      if (from < 0 || from >= next.length || to < 0 || to >= next.length) return prev;\n      var _next$splice3 = next.splice(from, 1),\n        _next$splice4 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_next$splice3, 1),\n        m = _next$splice4[0];\n      next.splice(to, 0, m);\n      return next;\n    });\n  };\n  var updateItemField = function updateItemField(id, field, value) {\n    setItems(function (prev) {\n      return prev.map(function (it) {\n        return it.id === id ? _objectSpread(_objectSpread({}, it), {}, (0,_babel_runtime_helpers_defineProperty__WEBPACK_IMPORTED_MODULE_3__[\"default\"])({}, field, value)) : it;\n      });\n    });\n  };\n\n  // quick set transport mode into notes\n  var applyTransportMode = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(function (id, mode) {\n    setItems(function (prev) {\n      var idx = prev.findIndex(function (it) {\n        return it.id === id;\n      });\n      if (idx < 0) return prev;\n      var it = prev[idx];\n      var notes = String(it.notes || '');\n      var re = /(交通：)([^。；;，,\\n]*)/;\n      if (re.test(notes)) {\n        notes = notes.replace(re, function (_, p1) {\n          return \"\".concat(p1).concat(mode);\n        });\n      } else if (notes.trim()) {\n        notes = notes + \" \\xB7 \\u4EA4\\u901A\\uFF1A\".concat(mode);\n      } else {\n        notes = \"\\u4EA4\\u901A\\uFF1A\".concat(mode);\n      }\n      var next = prev.slice();\n      next[idx] = _objectSpread(_objectSpread({}, it), {}, {\n        notes: notes\n      });\n      return next;\n    });\n  }, []);\n  var reverseGeocode = /*#__PURE__*/function () {\n    var _ref3 = (0,_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_4__[\"default\"])(/*#__PURE__*/_regenerator().m(function _callee4(lat, lng) {\n      var key, mode, bdc, d, city, province, country, name, nomi, _name, _bdc, _d, _city, _province, _country, _name2, _t4, _t5, _t6;\n      return _regenerator().w(function (_context4) {\n        while (1) switch (_context4.p = _context4.n) {\n          case 0:\n            key = lat.toFixed(5) + ',' + lng.toFixed(5);\n            if (!reverseCache.has(key)) {\n              _context4.n = 1;\n              break;\n            }\n            return _context4.a(2, reverseCache.get(key));\n          case 1:\n            mode = getGeoMode();\n            if (!(mode === 'stable')) {\n              _context4.n = 6;\n              break;\n            }\n            _context4.p = 2;\n            _context4.n = 3;\n            return gateReverse(function () {\n              return withRetry(function () {\n                return axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].get('https://api.bigdatacloud.net/data/reverse-geocode-client', {\n                  params: {\n                    latitude: lat,\n                    longitude: lng,\n                    localityLanguage: 'zh'\n                  },\n                  timeout: 5000\n                });\n              }, {\n                retries: 1,\n                baseDelay: 500\n              });\n            });\n          case 3:\n            bdc = _context4.v;\n            d = bdc.data || {};\n            city = d.locality || d.city || '';\n            province = d.principalSubdivision || '';\n            country = d.countryName || '';\n            name = [city, province, country].filter(Boolean).join(' · ') || country || province || city || '';\n            if (!name) {\n              _context4.n = 4;\n              break;\n            }\n            reverseCache.set(key, name);\n            return _context4.a(2, name);\n          case 4:\n            return _context4.a(2, '');\n          case 5:\n            _context4.p = 5;\n            _t4 = _context4.v;\n            return _context4.a(2, '');\n          case 6:\n            // Use Nominatim reverse geocoding primarily (Photon reverse has CORS/404 issues); fallback to BigDataCloud\n            nomi = gateReverse(function () {\n              return withRetry(function () {\n                return axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].get('https://nominatim.openstreetmap.org/reverse', {\n                  params: {\n                    format: 'jsonv2',\n                    lat: lat,\n                    lon: lng,\n                    addressdetails: 1\n                  },\n                  headers: {\n                    'Accept': 'application/json',\n                    'Accept-Language': 'zh-CN'\n                  },\n                  timeout: 6000\n                });\n              }, {\n                retries: 1,\n                baseDelay: 600\n              });\n            }).then(function (res) {\n              var d = res.data || {};\n              var addr = d.address || null;\n              var disp = d.display_name || '';\n              return formatCnAddress(addr, disp);\n            });\n            _context4.p = 7;\n            _context4.n = 8;\n            return nomi;\n          case 8:\n            _name = _context4.v;\n            reverseCache.set(key, _name);\n            return _context4.a(2, _name);\n          case 9:\n            _context4.p = 9;\n            _t5 = _context4.v;\n            _context4.p = 10;\n            _context4.n = 11;\n            return gateReverse(function () {\n              return withRetry(function () {\n                return axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].get('https://api.bigdatacloud.net/data/reverse-geocode-client', {\n                  params: {\n                    latitude: lat,\n                    longitude: lng,\n                    localityLanguage: 'zh'\n                  },\n                  timeout: 5000\n                });\n              }, {\n                retries: 1,\n                baseDelay: 500\n              });\n            });\n          case 11:\n            _bdc = _context4.v;\n            _d = _bdc.data || {};\n            _city = _d.locality || _d.city || '';\n            _province = _d.principalSubdivision || '';\n            _country = _d.countryName || '';\n            _name2 = [_city, _province, _country].filter(Boolean).join(' · ') || _country || _province || _city || '';\n            if (!_name2) {\n              _context4.n = 12;\n              break;\n            }\n            reverseCache.set(key, _name2);\n            return _context4.a(2, _name2);\n          case 12:\n            _context4.n = 14;\n            break;\n          case 13:\n            _context4.p = 13;\n            _t6 = _context4.v;\n          case 14:\n            return _context4.a(2, '');\n        }\n      }, _callee4, null, [[10, 13], [7, 9], [2, 5]]);\n    }));\n    return function reverseGeocode(_x0, _x1) {\n      return _ref3.apply(this, arguments);\n    };\n  }();\n\n  // Enhanced reverse geocode with bilingual details and city/province\n  var reverseGeocodeMultiDetailed = /*#__PURE__*/function () {\n    var _ref4 = (0,_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_4__[\"default\"])(/*#__PURE__*/_regenerator().m(function _callee5(lat, lng) {\n      var key, cn, en, meta, mode, bdc, d, city, province, country, _cn, local, _meta, nomi, _bdc2, _d2, _city2, _province2, _country2, _cn2, _local, _meta2, _t7, _t8, _t9;\n      return _regenerator().w(function (_context5) {\n        while (1) switch (_context5.p = _context5.n) {\n          case 0:\n            key = lat.toFixed(5) + ',' + lng.toFixed(5);\n            if (!(reverseCache.has('cn:' + key) && reverseCacheEn.has('en:' + key))) {\n              _context5.n = 1;\n              break;\n            }\n            cn = reverseCache.get('cn:' + key);\n            en = reverseCacheEn.get('en:' + key);\n            meta = reverseCache.get('meta:' + key) || {};\n            return _context5.a(2, _objectSpread({\n              cn: cn,\n              local: en\n            }, meta));\n          case 1:\n            mode = getGeoMode();\n            if (!(mode === 'stable')) {\n              _context5.n = 5;\n              break;\n            }\n            _context5.p = 2;\n            _context5.n = 3;\n            return gateReverse(function () {\n              return withRetry(function () {\n                return axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].get('https://api.bigdatacloud.net/data/reverse-geocode-client', {\n                  params: {\n                    latitude: lat,\n                    longitude: lng,\n                    localityLanguage: 'zh'\n                  },\n                  timeout: 6000\n                });\n              }, {\n                retries: 1,\n                baseDelay: 600\n              });\n            });\n          case 3:\n            bdc = _context5.v;\n            d = bdc.data || {};\n            city = d.locality || d.city || d.localityInfo && d.localityInfo.locality && d.localityInfo.locality.name || '';\n            province = d.principalSubdivision || '';\n            country = d.countryName || '';\n            _cn = [city, province, country].filter(Boolean).join(' · ') || country || province || city || '';\n            local = _cn;\n            _meta = {\n              city: city || '',\n              province: province || '',\n              country: country || ''\n            };\n            reverseCache.set('cn:' + key, _cn);\n            reverseCacheEn.set('en:' + key, local);\n            reverseCache.set('meta:' + key, _meta);\n            return _context5.a(2, _objectSpread({\n              cn: _cn,\n              local: local\n            }, _meta));\n          case 4:\n            _context5.p = 4;\n            _t7 = _context5.v;\n            return _context5.a(2, {\n              cn: '',\n              local: '',\n              city: '',\n              province: '',\n              country: ''\n            });\n          case 5:\n            nomi = gateReverse(function () {\n              return withRetry(function () {\n                return axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].get('https://nominatim.openstreetmap.org/reverse', {\n                  params: {\n                    format: 'jsonv2',\n                    lat: lat,\n                    lon: lng,\n                    addressdetails: 1,\n                    namedetails: 1\n                  },\n                  headers: {\n                    'Accept': 'application/json',\n                    'Accept-Language': 'zh-CN'\n                  },\n                  timeout: 7000\n                });\n              }, {\n                retries: 1,\n                baseDelay: 700\n              });\n            }).then(function (res) {\n              var d = res.data || {};\n              var addr = d.address || {};\n              var cn = formatCnAddress(addr, d.display_name || '');\n              var named = d.namedetails || {};\n              // prefer local/native name from namedetails\n              var local = named['name:zh'] || named['name:zh-CN'] || named['name:en'] || named.name || d.display_name || '';\n              var meta = {\n                city: addr.city || addr.town || addr.village || addr.county || addr.city_district || '',\n                province: addr.state || addr.province || '',\n                country: addr.country || ''\n              };\n              reverseCache.set('cn:' + key, cn);\n              reverseCacheEn.set('en:' + key, local);\n              reverseCache.set('meta:' + key, meta);\n              return _objectSpread({\n                cn: cn,\n                local: local\n              }, meta);\n            });\n            _context5.p = 6;\n            _context5.n = 7;\n            return nomi;\n          case 7:\n            return _context5.a(2, _context5.v);\n          case 8:\n            _context5.p = 8;\n            _t8 = _context5.v;\n            _context5.p = 9;\n            _context5.n = 10;\n            return gateReverse(function () {\n              return withRetry(function () {\n                return axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].get('https://api.bigdatacloud.net/data/reverse-geocode-client', {\n                  params: {\n                    latitude: lat,\n                    longitude: lng,\n                    localityLanguage: 'zh'\n                  },\n                  timeout: 6000\n                });\n              }, {\n                retries: 1,\n                baseDelay: 600\n              });\n            });\n          case 10:\n            _bdc2 = _context5.v;\n            _d2 = _bdc2.data || {};\n            _city2 = _d2.locality || _d2.city || _d2.localityInfo && _d2.localityInfo.locality && _d2.localityInfo.locality.name || '';\n            _province2 = _d2.principalSubdivision || '';\n            _country2 = _d2.countryName || '';\n            _cn2 = [_city2, _province2, _country2].filter(Boolean).join(' · ') || _country2 || _province2 || _city2 || '';\n            _local = _cn2; // 没有英文名时，退化为中文\n            _meta2 = {\n              city: _city2 || '',\n              province: _province2 || '',\n              country: _country2 || ''\n            };\n            reverseCache.set('cn:' + key, _cn2);\n            reverseCacheEn.set('en:' + key, _local);\n            reverseCache.set('meta:' + key, _meta2);\n            return _context5.a(2, _objectSpread({\n              cn: _cn2,\n              local: _local\n            }, _meta2));\n          case 11:\n            _context5.p = 11;\n            _t9 = _context5.v;\n            return _context5.a(2, {\n              cn: '',\n              local: '',\n              city: '',\n              province: '',\n              country: ''\n            });\n        }\n      }, _callee5, null, [[9, 11], [6, 8], [2, 4]]);\n    }));\n    return function reverseGeocodeMultiDetailed(_x10, _x11) {\n      return _ref4.apply(this, arguments);\n    };\n  }();\n\n  // ---- Sagas integration ----\n  var loadPlans = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(function () {\n    dispatch({\n      type: 'TRAVEL_PLANS_FETCH_REQUEST'\n    });\n  }, [dispatch]);\n  var loadPlanDetail = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(function (id) {\n    if (!id) return;\n    dispatch({\n      type: 'TRAVEL_PLAN_FETCH_REQUEST',\n      payload: id\n    });\n  }, [dispatch]);\n  var savePlan = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(function () {\n    if (!planName.trim()) {\n      setError('请输入计划名称');\n      return;\n    }\n    setError('');\n    dispatch({\n      type: 'TRAVEL_PLAN_SAVE_REQUEST',\n      payload: {\n        id: planId,\n        name: planName.trim(),\n        items: items\n      }\n    });\n  }, [dispatch, planId, planName, items]);\n  var newPlan = function newPlan() {\n    setPlanId(null);\n    setPlanName('我的旅行计划');\n    setItems([]);\n    if (clusterGroupRef.current && clusterGroupRef.current.clearLayers) {\n      try {\n        clusterGroupRef.current.clearLayers();\n      } catch (_) {}\n    }\n    Object.values(markersRef.current).forEach(function (m) {\n      try {\n        m.remove();\n      } catch (_) {}\n    });\n    markersRef.current = {};\n  };\n  var deletePlan = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(function () {\n    if (!planId) return newPlan();\n    dispatch({\n      type: 'TRAVEL_PLAN_DELETE_REQUEST',\n      payload: planId\n    });\n  }, [dispatch, planId]);\n  var confirmDeletePlan = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(function () {\n    if (!planId) return newPlan();\n    if (!window.confirm('确认删除该计划？')) return;\n    if (!window.confirm('再次确认：删除后无法恢复，确定吗？')) return;\n    dispatch({\n      type: 'TRAVEL_PLAN_DELETE_REQUEST',\n      payload: planId\n    });\n  }, [dispatch, planId]);\n  var confirmDeleteItem = function confirmDeleteItem(id) {\n    if (!window.confirm('确认删除该地点？')) return;\n    if (!window.confirm('再次确认：删除后无法恢复，确定吗？')) return;\n    removeItem(id);\n  };\n  var confirmNewPlan = function confirmNewPlan() {\n    if (!items.length) {\n      newPlan();\n      return;\n    }\n    if (!window.confirm('确认新建并清空当前编辑内容？')) return;\n    newPlan();\n  };\n\n  // long-press context menu helpers\n  var openContextMenu = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(function (x, y, itemId) {\n    setMenu({\n      show: true,\n      x: x,\n      y: y,\n      itemId: itemId\n    });\n  }, []);\n  var closeContextMenu = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(function () {\n    setMenu({\n      show: false,\n      x: 0,\n      y: 0,\n      itemId: null\n    });\n  }, []);\n  var bindLongPress = function bindLongPress(itemId) {\n    return {\n      onMouseDown: function onMouseDown(e) {\n        if (lpTimerRef.current) clearTimeout(lpTimerRef.current);\n        var clientX = e.clientX,\n          clientY = e.clientY;\n        lpTimerRef.current = setTimeout(function () {\n          return openContextMenu(clientX, clientY, itemId);\n        }, 550);\n      },\n      onMouseUp: function onMouseUp() {\n        if (lpTimerRef.current) clearTimeout(lpTimerRef.current);\n      },\n      onMouseLeave: function onMouseLeave() {\n        if (lpTimerRef.current) clearTimeout(lpTimerRef.current);\n      },\n      onTouchStart: function onTouchStart(e) {\n        if (lpTimerRef.current) clearTimeout(lpTimerRef.current);\n        var t = e.touches && e.touches[0];\n        var cx = t ? t.clientX : 0;\n        var cy = t ? t.clientY : 0;\n        lpTimerRef.current = setTimeout(function () {\n          return openContextMenu(cx, cy, itemId);\n        }, 550);\n      },\n      onTouchEnd: function onTouchEnd() {\n        if (lpTimerRef.current) clearTimeout(lpTimerRef.current);\n      },\n      onTouchMove: function onTouchMove() {\n        if (lpTimerRef.current) clearTimeout(lpTimerRef.current);\n      }\n    };\n  };\n  (0,react__WEBPACK_IMPORTED_MODULE_6__.useEffect)(function () {\n    if (!currentPlan) return;\n    if (clusterGroupRef.current && clusterGroupRef.current.clearLayers) {\n      try {\n        clusterGroupRef.current.clearLayers();\n      } catch (_) {}\n    }\n    Object.values(markersRef.current).forEach(function (m) {\n      try {\n        m.remove();\n      } catch (_) {}\n    });\n    markersRef.current = {};\n    setPlanId(currentPlan.id || null);\n    setPlanName(currentPlan.name || '未命名计划');\n    var list = Array.isArray(currentPlan.items) ? currentPlan.items : [];\n    setItems(list);\n    setTimeout(function () {\n      list.forEach(function (it) {\n        return addMarkerForItem(it);\n      });\n      if (list[0] && mapRef.current) mapRef.current.setView([list[0].lat, list[0].lng], getRuntimeMapConfig().initialZoom);\n    }, 0);\n  }, [currentPlan, addMarkerForItem]);\n\n  // remember showExtra preference\n  (0,react__WEBPACK_IMPORTED_MODULE_6__.useEffect)(function () {\n    try {\n      localStorage.setItem('jihua_show_extra', showExtra ? '1' : '0');\n    } catch (_) {}\n  }, [showExtra]);\n\n  // supplies memo: load/save from localStorage per plan\n  (0,react__WEBPACK_IMPORTED_MODULE_6__.useEffect)(function () {\n    var key = 'jihua_supplies_' + (planId || '__temp');\n    var saved = localStorage.getItem(key);\n    if (saved != null) {\n      setSuppliesText(saved);\n    } else {\n      setSuppliesText(defaultSuppliesTemplate());\n    }\n    return function () {};\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [planId]);\n  (0,react__WEBPACK_IMPORTED_MODULE_6__.useEffect)(function () {\n    if (!showSupplies) return; // save on typing when modal open\n    if (suppliesDebounceRef.current) clearTimeout(suppliesDebounceRef.current);\n    suppliesDebounceRef.current = setTimeout(function () {\n      try {\n        localStorage.setItem('jihua_supplies_' + (planId || '__temp'), suppliesText);\n      } catch (_) {}\n    }, 400);\n  }, [suppliesText, showSupplies, planId]);\n  // persist my templates\n  (0,react__WEBPACK_IMPORTED_MODULE_6__.useEffect)(function () {\n    try {\n      localStorage.setItem('jihua_supplies_templates', JSON.stringify(myTemplates.slice(0, 100)));\n    } catch (_) {}\n  }, [myTemplates]);\n  function defaultSuppliesTemplate() {\n    return ['证件：身份证/护照/签证', '电子：手机/充电宝/充电器/数据线', '衣物：外套/换洗衣物/雨具', '洗护：牙刷牙膏/洗面奶/毛巾', '药品：感冒药/肠胃药/创可贴', '其他：水杯/太阳镜/防晒/伞'].map(function (s) {\n      return '- ' + s;\n    }).join('\\n');\n  }\n  function getSuppliesTemplate(type) {\n    switch (type) {\n      case 'domestic':\n        return ['证件：身份证/驾驶证', '交通：机票/火车票/公交卡', '支付：现金/银行卡/移动支付', '衣物：换洗衣物/外套/雨具', '洗护：牙刷牙膏/洗面奶/毛巾/护肤', '药品：感冒药/肠胃药/晕车药/创可贴', '电子：手机/充电宝/充电器/耳机', '其他：水杯/太阳镜/防晒/伞/口罩'].map(function (s) {\n          return '- ' + s;\n        }).join('\\n');\n      case 'abroad':\n        return ['证件：护照/签证/行程单/保险', '支付：双币信用卡/部分现金', '通讯：境外流量卡/随身WiFi', '电源：万能转换插头/排插', '语言：常用语/离线地图', '衣物：换洗衣物/外套/雨具', '洗护：牙刷牙膏/洗面奶/毛巾', '药品：感冒药/肠胃药/创可贴/常备药', '其他：水杯/太阳镜/防晒/伞'].map(function (s) {\n          return '- ' + s;\n        }).join('\\n');\n      case 'hiking':\n        return ['背包/登山杖/头灯', '保暖：速干衣/抓绒/冲锋衣', '鞋袜：登山鞋/备用袜子/护膝', '饮食：水/能量棒/压缩饼干', '导航：离线地图/GPS/指南针', '防晒/防蚊', '简易医药包', '应急：太空毯/哨子/打火机'].map(function (s) {\n          return '- ' + s;\n        }).join('\\n');\n      case 'camp':\n        return ['帐篷/防潮垫/睡袋', '照明：营灯/头灯', '炊具：炉头/气罐/打火机/锅具', '食品：即食/调料/水', '工具：小刀/胶带/绳子', '卫生：纸巾/湿巾/垃圾袋', '保暖：外套/毛毯', '其他：驱蚊/防晒/药品'].map(function (s) {\n          return '- ' + s;\n        }).join('\\n');\n      default:\n        return defaultSuppliesTemplate();\n    }\n  }\n\n  // Supplies: my templates actions\n  var saveSuppliesAsTemplate = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(function () {\n    var name = window.prompt('输入模板名称', selectedTplName || planName || '我的模板');\n    if (!name) return;\n    name = name.trim();\n    if (!name) return;\n    if (myTemplates.some(function (t) {\n      return t.name === name;\n    })) {\n      if (!window.confirm('同名模板已存在，是否覆盖？')) return;\n    }\n    var payload = {\n      name: name,\n      text: suppliesText\n    };\n    setMyTemplates(function (prev) {\n      var filtered = prev.filter(function (t) {\n        return t.name !== name;\n      });\n      var next = [].concat((0,_babel_runtime_helpers_toConsumableArray__WEBPACK_IMPORTED_MODULE_2__[\"default\"])(filtered), [payload]).sort(function (a, b) {\n        return a.name.localeCompare(b.name);\n      });\n      return next;\n    });\n    setSelectedTplName(name);\n  }, [myTemplates, suppliesText, selectedTplName, planName]);\n  var deleteSelectedTemplate = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(function () {\n    if (!selectedTplName) return;\n    if (!window.confirm(\"\\u5220\\u9664\\u6A21\\u677F \\\"\".concat(selectedTplName, \"\\\"\\uFF1F\"))) return;\n    setMyTemplates(function (prev) {\n      return prev.filter(function (t) {\n        return t.name !== selectedTplName;\n      });\n    });\n    setSelectedTplName('');\n  }, [selectedTplName]);\n\n  // per-day exports\n  var exportDayGeoJSON = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(function (day) {\n    var group = items.filter(function (it) {\n      return (it.date || '') === day;\n    });\n    var features = group.map(function (it, idx) {\n      return {\n        type: 'Feature',\n        properties: {\n          index: idx + 1,\n          name: it.name,\n          nameLocal: it.nameLocal || '',\n          time: (it.date || '') + ' ' + (it.time || '')\n        },\n        geometry: {\n          type: 'Point',\n          coordinates: [it.lng, it.lat]\n        }\n      };\n    });\n    // line\n    if (group.length >= 2) {\n      features.push({\n        type: 'Feature',\n        properties: {\n          name: 'Path'\n        },\n        geometry: {\n          type: 'LineString',\n          coordinates: group.map(function (it) {\n            return [it.lng, it.lat];\n          })\n        }\n      });\n    }\n    var geo = {\n      type: 'FeatureCollection',\n      features: features\n    };\n    var blob = new Blob([JSON.stringify(geo, null, 2)], {\n      type: 'application/geo+json'\n    });\n    var url = URL.createObjectURL(blob);\n    var a = document.createElement('a');\n    a.href = url;\n    a.download = \"\".concat((planName || '计划').replace(/[\\\\/:*?\"<>|]/g, '_'), \"-\").concat(day, \".geojson\");\n    a.click();\n    URL.revokeObjectURL(url);\n  }, [items, planName]);\n  var exportDayGPX = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(function (day) {\n    var group = items.filter(function (it) {\n      return (it.date || '') === day;\n    });\n    var nameSafe = (planName || '计划').replace(/[\\\\/:*?\"<>|]/g, '_');\n    var header = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?><gpx version=\\\"1.1\\\" creator=\\\"JihuaPlanner\\\" xmlns=\\\"http://www.topografix.com/GPX/1/1\\\">\";\n    var wpts = group.map(function (it, idx) {\n      return \"<wpt lat=\\\"\".concat(it.lat, \"\\\" lon=\\\"\").concat(it.lng, \"\\\"><name>\").concat(idx + 1, \". \").concat(escapeXml(it.name || ''), \"</name><desc>\").concat(escapeXml(((it.date || '') + ' ' + (it.time || '')).trim()), \"</desc></wpt>\");\n    }).join('');\n    var trk = group.length ? \"<trk><name>\".concat(escapeXml(nameSafe + ' ' + day), \"</name><trkseg>\").concat(group.map(function (it) {\n      return \"<trkpt lat=\\\"\".concat(it.lat, \"\\\" lon=\\\"\").concat(it.lng, \"\\\"></trkpt>\");\n    }).join(''), \"</trkseg></trk>\") : '';\n    var xml = header + wpts + trk + '</gpx>';\n    var blob = new Blob([xml], {\n      type: 'application/gpx+xml'\n    });\n    var url = URL.createObjectURL(blob);\n    var a = document.createElement('a');\n    a.href = url;\n    a.download = \"\".concat(nameSafe, \"-\").concat(day, \".gpx\");\n    a.click();\n    URL.revokeObjectURL(url);\n  }, [items, planName]);\n  function escapeXml(s) {\n    return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;').replace(/'/g, '&apos;');\n  }\n  var exportDayPNG = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(/*#__PURE__*/function () {\n    var _ref5 = (0,_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_4__[\"default\"])(/*#__PURE__*/_regenerator().m(function _callee6(day) {\n      var h2c, el, canvas, blob, url, a, _t0;\n      return _regenerator().w(function (_context6) {\n        while (1) switch (_context6.p = _context6.n) {\n          case 0:\n            _context6.p = 0;\n            _context6.n = 1;\n            return loadHtml2Canvas();\n          case 1:\n            h2c = _context6.v;\n            el = document.getElementById('day-' + day);\n            if (el) {\n              _context6.n = 2;\n              break;\n            }\n            setError('未找到该天内容');\n            return _context6.a(2);\n          case 2:\n            _context6.n = 3;\n            return h2c(el, {\n              backgroundColor: null,\n              scale: Math.min(2, window.devicePixelRatio || 1),\n              useCORS: true\n            });\n          case 3:\n            canvas = _context6.v;\n            _context6.n = 4;\n            return new Promise(function (res) {\n              return canvas.toBlob(function (b) {\n                return res(b);\n              }, 'image/png');\n            });\n          case 4:\n            blob = _context6.v;\n            url = URL.createObjectURL(blob);\n            a = document.createElement('a');\n            a.href = url;\n            a.download = \"\".concat((planName || '计划').replace(/[\\/:*?\"<>|]/g, '_'), \"-\").concat(day, \".png\");\n            a.click();\n            URL.revokeObjectURL(url);\n            _context6.n = 6;\n            break;\n          case 5:\n            _context6.p = 5;\n            _t0 = _context6.v;\n            setError('导出图片失败：' + (_t0 && _t0.message || _t0));\n          case 6:\n            return _context6.a(2);\n        }\n      }, _callee6, null, [[0, 5]]);\n    }));\n    return function (_x12) {\n      return _ref5.apply(this, arguments);\n    };\n  }(), [planName]);\n  var addQuickDayNote = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(function (day) {\n    var last = items[items.length - 1];\n    var lat = last ? last.lat : mapRef.current ? mapRef.current.getCenter().lat : DEFAULT_CENTER.lat;\n    var lng = last ? last.lng : mapRef.current ? mapRef.current.getCenter().lng : DEFAULT_CENTER.lng;\n    var now = getNowDateTime();\n    var item = {\n      id: uid(),\n      placeId: '',\n      name: '当天备注',\n      nameLocal: '',\n      lat: lat,\n      lng: lng,\n      date: day,\n      time: now.time,\n      notes: '当天备注：'\n    };\n    setItems(function (prev) {\n      return [].concat((0,_babel_runtime_helpers_toConsumableArray__WEBPACK_IMPORTED_MODULE_2__[\"default\"])(prev), [item]);\n    });\n  }, [items]);\n\n  // ---- Search ----\n  var searchCancelRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)(null);\n  var searchReqIdRef = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)(0);\n  var _useState65 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(false),\n    _useState66 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState65, 2),\n    searching = _useState66[0],\n    setSearching = _useState66[1];\n  var _useState67 = (0,react__WEBPACK_IMPORTED_MODULE_6__.useState)(-1),\n    _useState68 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_useState67, 2),\n    suggIndex = _useState68[0],\n    setSuggIndex = _useState68[1];\n  var doSearch = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(/*#__PURE__*/function () {\n    var _ref6 = (0,_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_4__[\"default\"])(/*#__PURE__*/_regenerator().m(function _callee0(q) {\n      var query, hasCJK, qLower, aliasMap, aliases, boundsKey, viewboxParam, photonBBoxParam, overpassBBoxParam, zoomNow, b, west, east, north, south, z, shouldBound, c, latGrid, lngGrid, zoomQ, adminTag, needAdmin, cacheKey, source, reqId, t0, mode, nomiEnabled, promises, jpHint, nomiBase, p1, pAddr, escapeRegex, overpassQL, p2, p3, amapKey, pAmap, aliasQuery, pAlias, pAliasOM, safe, first, center, addrCandidates, cityToken, approx, _t12, _t13;\n      return _regenerator().w(function (_context0) {\n        while (1) switch (_context0.p = _context0.n) {\n          case 0:\n            query = (q || '').trim();\n            if (!(!query || query.length < 2)) {\n              _context0.n = 1;\n              break;\n            }\n            setSuggestions([]);\n            return _context0.a(2);\n          case 1:\n            hasCJK = /[\\u4e00-\\u9fff\\u3040-\\u30ff]/.test(query); // 中文/日文字符\n            qLower = query.toLowerCase(); // 常见中文地名的外文别名（用于排序加权）\n            aliasMap = {\n              '大阪': ['osaka'],\n              '东京': ['tokyo'],\n              '京都': ['kyoto'],\n              '名古屋': ['nagoya'],\n              '札幌': ['sapporo'],\n              '福冈': ['fukuoka'],\n              '横滨': ['yokohama'],\n              '神户': ['kobe'],\n              '冲绳': ['okinawa']\n            };\n            aliases = aliasMap[query] || []; // cache key includes bounds mode\n            boundsKey = 'global';\n            viewboxParam = '';\n            photonBBoxParam = '';\n            overpassBBoxParam = '';\n            zoomNow = null;\n            if (useMapBounds && mapRef.current) {\n              b = mapRef.current.getBounds();\n              west = b.getWest().toFixed(3), east = b.getEast().toFixed(3), north = b.getNorth().toFixed(3), south = b.getSouth().toFixed(3); // 使用 viewbox：仅在放大很深且中文/日文查询时才带 bounded=1；否则不附带 viewbox，避免 Nominatim 连接重置或误判\n              z = mapRef.current.getZoom ? mapRef.current.getZoom() : 0;\n              zoomNow = z;\n              shouldBound = hasCJK && query.length >= 3 && z >= 12;\n              viewboxParam = shouldBound ? \"&viewbox=\".concat(west, \",\").concat(north, \",\").concat(east, \",\").concat(south, \"&bounded=1\") : '';\n              // Photon bbox uses left,bottom,right,top\n              photonBBoxParam = \"\".concat(west, \",\").concat(south, \",\").concat(east, \",\").concat(north);\n              // Overpass 需要 south,west,north,east\n              overpassBBoxParam = \"\".concat(south, \",\").concat(west, \",\").concat(north, \",\").concat(east);\n              c = mapRef.current.getCenter();\n              latGrid = (Math.round(c.lat * 2) / 2).toFixed(1);\n              lngGrid = (Math.round(c.lng * 2) / 2).toFixed(1);\n              zoomQ = Math.round(z);\n              adminTag = lastAdminRef.current && lastAdminRef.current.tag ? \"|adm:\".concat(lastAdminRef.current.tag) : '';\n              boundsKey = \"\".concat(latGrid, \",\").concat(lngGrid, \",z\").concat(zoomQ).concat(adminTag);\n              // 异步刷新 adminTag（2 分钟或位移>0.5° 刷新一次）\n              needAdmin = !lastAdminRef.current.tag || Math.abs((lastAdminRef.current.lat || 0) - c.lat) > 0.5 || Math.abs((lastAdminRef.current.lng || 0) - c.lng) > 0.5 || Date.now() - (lastAdminRef.current.t || 0) > 120000;\n              if (needAdmin) {\n                reverseGeocodeMultiDetailed(c.lat, c.lng).then(function (info) {\n                  var tag = \"\".concat(info.city || '', \"_\").concat(info.province || '').replace(/\\s+/g, '');\n                  lastAdminRef.current = {\n                    tag: tag,\n                    lat: c.lat,\n                    lng: c.lng,\n                    t: Date.now()\n                  };\n                })[\"catch\"](function () {});\n              }\n            }\n            cacheKey = query + '|' + boundsKey;\n            if (!searchCache.has(cacheKey)) {\n              _context0.n = 2;\n              break;\n            }\n            setSuggestions(searchCache.get(cacheKey));\n            return _context0.a(2);\n          case 2:\n            if (searchCancelRef.current) searchCancelRef.current.cancel('cancelled');\n            source = axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].CancelToken.source();\n            searchCancelRef.current = source;\n            setSearching(true);\n            reqId = ++searchReqIdRef.current;\n            t0 = typeof performance !== 'undefined' && performance.now ? performance.now() : Date.now(); // providers in parallel; first fulfilled wins, others merge later\n            mode = getGeoMode();\n            nomiEnabled = mode !== 'stable' && Date.now() > (nomiBlockedUntilRef.current || 0);\n            promises = []; // Nominatim for search (shorter timeout). Disabled in stable mode or when circuit breaker is active.\n            // 对部分常见日文地名（如“大阪”）提示国家为日本，减少误命中\n            jpHint = hasCJK && /大阪|东京|京都|名古屋|札幌|福冈|冲绳|神户|横滨/.test(query) ? '&countrycodes=jp' : '';\n            nomiBase = \"https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=6&accept-language=zh-CN\".concat(jpHint, \"&q=\").concat(encodeURIComponent(query));\n            p1 = nomiEnabled ? gateNominatim(function () {\n              return withRetry(function () {\n                return axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].get(nomiBase + viewboxParam, {\n                  headers: {\n                    'Accept': 'application/json'\n                  },\n                  timeout: 1500,\n                  cancelToken: source.token\n                })[\"catch\"](function () {\n                  return axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].get(nomiBase, {\n                    headers: {\n                      'Accept': 'application/json'\n                    },\n                    timeout: 1500,\n                    cancelToken: source.token\n                  });\n                });\n              }, {\n                retries: 1,\n                baseDelay: 500\n              });\n            }).then(function (res) {\n              return Array.isArray(res.data) ? res.data : [];\n            })[\"catch\"](function (e) {\n              nomiBlockedUntilRef.current = Date.now() + 3 * 60 * 1000;\n              return [];\n            }) : Promise.resolve([]); // Address-like prioritized search (street + nearby POI) — run in parallel and may return early\n            pAddr = searchAddressAssist(query, mapRef, useMapBounds, source.token)[\"catch\"](function () {\n              return [];\n            }); // Overpass API 作为无钥匙回退（基于当前视图），匹配 name:zh 或 name，返回节点/道路/关系的中心点\n            escapeRegex = function escapeRegex(s) {\n              return String(s).replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n            }; // 仅在放大足够且查询较具体时才启用 Overpass，避免拖慢首屏\n            overpassQL = useMapBounds && overpassBBoxParam && zoomNow != null && zoomNow >= 12 && (hasCJK || query.length >= 3) ? \"[out:json][timeout:12];\\n(\\n        node[\\\"name:zh\\\"~\\\"\".concat(escapeRegex(query), \"\\\",i](\").concat(overpassBBoxParam, \");\\n\\n        way[\\\"name:zh\\\"~\\\"\").concat(escapeRegex(query), \"\\\",i](\").concat(overpassBBoxParam, \");\\n\\n        relation[\\\"name:zh\\\"~\\\"\").concat(escapeRegex(query), \"\\\",i](\").concat(overpassBBoxParam, \");\\n\\n        node[\\\"name\\\"~\\\"\").concat(escapeRegex(query), \"\\\",i](\").concat(overpassBBoxParam, \");\\n\\n        way[\\\"name\\\"~\\\"\").concat(escapeRegex(query), \"\\\",i](\").concat(overpassBBoxParam, \");\\n\\n        relation[\\\"name\\\"~\\\"\").concat(escapeRegex(query), \"\\\",i](\").concat(overpassBBoxParam, \");\\n\\n      );\\nout center 30;\") : '';\n            p2 = overpassQL ? axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].post('https://overpass-api.de/api/interpreter', \"data=\".concat(encodeURIComponent(overpassQL)), {\n              headers: {\n                'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'\n              },\n              timeout: 8000,\n              cancelToken: source.token\n            })[\"catch\"](function () {\n              return axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].post('https://overpass.kumi.systems/api/interpreter', \"data=\".concat(encodeURIComponent(overpassQL)), {\n                headers: {\n                  'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'\n                },\n                timeout: 8000,\n                cancelToken: source.token\n              });\n            }).then(function (res) {\n              var els = res.data && res.data.elements || [];\n              return els.slice(0, 30).map(function (el) {\n                var tags = el.tags || {};\n                var nameZh = tags['name:zh'];\n                var name = tags.name || nameZh || '';\n                var lat = el.lat != null ? el.lat : el.center && el.center.lat;\n                var lon = el.lon != null ? el.lon : el.center && el.center.lon;\n                return {\n                  place_id: null,\n                  osm_id: el.id,\n                  display_name: nameZh || name || '未命名',\n                  lat: String(lat || '0'),\n                  lon: String(lon || '0')\n                };\n              }).filter(function (d) {\n                return d.lat !== '0' && d.lon !== '0';\n              });\n            })[\"catch\"](function () {\n              return [];\n            }) : Promise.resolve([]); // Photon provider disabled due to frequent 400 Bad Request for Chinese queries; relying on Nominatim + Open-Meteo\n            // Open-Meteo Geocoding as a no-key fallback (best for cities)\n            p3 = axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].get('https://geocoding-api.open-meteo.com/v1/search', {\n              params: {\n                name: query,\n                count: 8,\n                language: 'zh',\n                format: 'json'\n              },\n              timeout: 5000,\n              cancelToken: source.token\n            }).then(function (res) {\n              var arr = res.data && res.data.results || [];\n              return arr.map(function (r) {\n                return {\n                  place_id: null,\n                  osm_id: null,\n                  display_name: [r.name, r.admin1, r.country].filter(Boolean).join(' · '),\n                  lat: String(r.latitude),\n                  lon: String(r.longitude)\n                };\n              });\n            }); // AMap (Gaode) Place Text API — requires window.CONFIG.AMAP_KEY; returns GCJ-02 which we convert to WGS84\n            amapKey = getAmapKey();\n            pAmap = amapKey ? axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].get('https://restapi.amap.com/v5/place/text', {\n              params: {\n                key: amapKey,\n                keywords: query,\n                types: '',\n                // allow all\n                city: '',\n                // nationwide\n                page_size: 10,\n                page_num: 1\n                // output defaults to JSON\n              },\n              timeout: 5000,\n              cancelToken: source.token\n            }).then(function (res) {\n              var pois = res.data && res.data.pois || [];\n              return pois.map(function (p) {\n                var lat = 0,\n                  lon = 0;\n                if (p.location) {\n                  var _String$split = String(p.location).split(','),\n                    _String$split2 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_String$split, 2),\n                    x = _String$split2[0],\n                    y = _String$split2[1];\n                  lon = parseFloat(x);\n                  lat = parseFloat(y);\n                  // Convert GCJ-02 -> WGS84 for map alignment\n                  var _gcj02ToWgs = gcj02ToWgs84(lon, lat),\n                    _gcj02ToWgs2 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_gcj02ToWgs, 2),\n                    wgsLon = _gcj02ToWgs2[0],\n                    wgsLat = _gcj02ToWgs2[1];\n                  lon = wgsLon;\n                  lat = wgsLat;\n                }\n                var name = p.name || '';\n                var ad = [p.cityname || '', p.adname || '', p.address || ''].filter(Boolean).join(' ');\n                return {\n                  place_id: p.id || null,\n                  osm_id: null,\n                  display_name: ad ? \"\".concat(name, \" \\xB7 \").concat(ad) : name,\n                  lat: String(lat),\n                  lon: String(lon)\n                };\n              }).filter(function (d) {\n                return isFinite(parseFloat(d.lat)) && isFinite(parseFloat(d.lon));\n              });\n            })[\"catch\"](function () {\n              return [];\n            }) : Promise.resolve([]); // 若命中别名（如“大阪”→ osaka），追加一次别名查询提升召回\n            aliasQuery = aliases.length ? aliases[0] : '';\n            pAlias = aliasQuery ? gateNominatim(function () {\n              return withRetry(function () {\n                return axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].get(\"https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=10&accept-language=zh-CN&q=\".concat(encodeURIComponent(aliasQuery)), {\n                  headers: {\n                    'Accept': 'application/json'\n                  },\n                  timeout: 3500,\n                  cancelToken: source.token\n                });\n              }, {\n                retries: 1,\n                baseDelay: 400\n              });\n            }).then(function (res) {\n              return Array.isArray(res.data) ? res.data : [];\n            })[\"catch\"](function () {\n              return [];\n            }) : Promise.resolve([]);\n            pAliasOM = aliasQuery ? axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].get('https://geocoding-api.open-meteo.com/v1/search', {\n              params: {\n                name: aliasQuery,\n                count: 6,\n                language: 'zh',\n                format: 'json'\n              },\n              timeout: 4500,\n              cancelToken: source.token\n            }).then(function (res) {\n              var arr = res.data && res.data.results || [];\n              return arr.map(function (r) {\n                return {\n                  place_id: null,\n                  osm_id: null,\n                  display_name: [r.name, r.admin1, r.country].filter(Boolean).join(' · '),\n                  lat: String(r.latitude),\n                  lon: String(r.longitude)\n                };\n              });\n            })[\"catch\"](function () {\n              return [];\n            }) : Promise.resolve([]); // Use Nominatim + Overpass(若有边界) + Open-Meteo + Alias 扩展（均无需 API Key）\n            promises.push(pAddr, p1, p2, p3, pAlias, pAliasOM, pAmap);\n            _context0.p = 3;\n            safe = function safe(p) {\n              return p.then(function (v) {\n                return v;\n              })[\"catch\"](function () {\n                return [];\n              });\n            };\n            _context0.n = 4;\n            return Promise.race(promises.map(safe));\n          case 4:\n            first = _context0.v;\n            // 立即显示首批结果，不阻塞于反向地理中文本地化\n            center = mapRef.current ? mapRef.current.getCenter() : null;\n            if (center && first.length) {\n              first = first.map(function (d, i) {\n                var name = String(d.display_name || '');\n                var nameL = name.toLowerCase();\n                var matched = name.includes(query) || nameL.includes(qLower) || aliases.some(function (a) {\n                  return nameL.includes(a);\n                });\n                var dist = Math.hypot(parseFloat(d.lat) - center.lat, parseFloat(d.lon) - center.lng);\n                return _objectSpread(_objectSpread({}, d), {}, {\n                  __m: matched ? 1 : 0,\n                  __dist: dist,\n                  __rank: i\n                });\n              }).sort(function (a, b) {\n                return b.__m - a.__m || (a.__dist || 0) - (b.__dist || 0);\n              });\n              first = first.map(function (d, i) {\n                return _objectSpread(_objectSpread({}, d), {}, {\n                  __rank: i\n                });\n              });\n            }\n            if (!(!first || first.length === 0)) {\n              _context0.n = 10;\n              break;\n            }\n            _context0.p = 5;\n            _context0.n = 6;\n            return searchAddressAssist(query, {\n              current: null\n            }, false, source.token);\n          case 6:\n            addrCandidates = _context0.v;\n            if (Array.isArray(addrCandidates) && addrCandidates.length) {\n              first = addrCandidates.slice(0, 1).map(function (d) {\n                return _objectSpread(_objectSpread({}, d), {}, {\n                  __approx: true,\n                  display_name: d.display_name || \"\".concat(query, \"\\uFF08\\u9644\\u8FD1\\u4F4D\\u7F6E\\uFF09\")\n                });\n              });\n            }\n            _context0.n = 8;\n            break;\n          case 7:\n            _context0.p = 7;\n            _t12 = _context0.v;\n          case 8:\n            if (!(!first || first.length === 0)) {\n              _context0.n = 10;\n              break;\n            }\n            cityToken = extractCityFromQuery(query);\n            if (!cityToken) {\n              _context0.n = 10;\n              break;\n            }\n            _context0.n = 9;\n            return geocodeCityCenter(cityToken)[\"catch\"](function () {\n              return null;\n            });\n          case 9:\n            approx = _context0.v;\n            if (approx) {\n              first = [{\n                place_id: null,\n                osm_id: null,\n                display_name: \"\".concat(query, \"\\uFF08\\u9644\\u8FD1\\u4F4D\\u7F6E\\uFF09\"),\n                lat: String(approx.lat),\n                lon: String(approx.lng),\n                __approx: true\n              }];\n            }\n          case 10:\n            if (reqId === searchReqIdRef.current) {\n              lruSet(searchCache, cacheKey, first);\n              setSuggestions(first);\n            }\n            // 在后台对首批少量结果做中文本地化，然后平滑更新\n            (0,_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_4__[\"default\"])(/*#__PURE__*/_regenerator().m(function _callee7() {\n              var tStart, topN, copy, i, info, tEnd, _t1;\n              return _regenerator().w(function (_context7) {\n                while (1) switch (_context7.p = _context7.n) {\n                  case 0:\n                    tStart = typeof performance !== 'undefined' && performance.now ? performance.now() : Date.now();\n                    topN = Math.min(locTopCountRef.current, 6, first.length);\n                    copy = first.slice();\n                    i = 0;\n                  case 1:\n                    if (!(i < topN)) {\n                      _context7.n = 7;\n                      break;\n                    }\n                    _context7.p = 2;\n                    _context7.n = 3;\n                    return reverseGeocodeMultiDetailed(parseFloat(copy[i].lat), parseFloat(copy[i].lon));\n                  case 3:\n                    info = _context7.v;\n                    copy[i] = _objectSpread(_objectSpread({}, copy[i]), {}, {\n                      display_name: info.cn || copy[i].display_name\n                    });\n                    _context7.n = 5;\n                    break;\n                  case 4:\n                    _context7.p = 4;\n                    _t1 = _context7.v;\n                  case 5:\n                    _context7.n = 6;\n                    return sleep(revDelayRef.current);\n                  case 6:\n                    i++;\n                    _context7.n = 1;\n                    break;\n                  case 7:\n                    tEnd = typeof performance !== 'undefined' && performance.now ? performance.now() : Date.now(); // 动态调整 localize 数量（使用者已有函数，但未被调用）\n                    try {\n                      adjustLocCount(tEnd - tStart, 0);\n                    } catch (_) {}\n                    if (reqId === searchReqIdRef.current) {\n                      lruSet(searchCache, cacheKey, copy);\n                      setSuggestions(copy);\n                    }\n                  case 8:\n                    return _context7.a(2);\n                }\n              }, _callee7, null, [[2, 4]]);\n            }))();\n            // try merge the other quietly (no flicker)\n            Promise.allSettled(promises).then(/*#__PURE__*/function () {\n              var _ref8 = (0,_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_4__[\"default\"])(/*#__PURE__*/_regenerator().m(function _callee9(results) {\n                var arr, seen, merged, _iterator, _step, d, k, center2, enriched, rankMap, nextRank, t1, fails, _t11;\n                return _regenerator().w(function (_context9) {\n                  while (1) switch (_context9.p = _context9.n) {\n                    case 0:\n                      if (!(reqId !== searchReqIdRef.current)) {\n                        _context9.n = 1;\n                        break;\n                      }\n                      return _context9.a(2);\n                    case 1:\n                      arr = results.reduce(function (acc, r) {\n                        if (r.status === 'fulfilled' && Array.isArray(r.value)) acc = acc.concat(r.value);\n                        return acc;\n                      }, []); // dedupe by lat/lon/name\n                      seen = new Set();\n                      merged = [];\n                      _iterator = _createForOfIteratorHelper(arr);\n                      _context9.p = 2;\n                      _iterator.s();\n                    case 3:\n                      if ((_step = _iterator.n()).done) {\n                        _context9.n = 6;\n                        break;\n                      }\n                      d = _step.value;\n                      k = \"\".concat(d.lat, \"|\").concat(d.lon, \"|\").concat(d.display_name);\n                      if (!seen.has(k)) {\n                        _context9.n = 4;\n                        break;\n                      }\n                      return _context9.a(3, 5);\n                    case 4:\n                      seen.add(k);\n                      merged.push(d);\n                    case 5:\n                      _context9.n = 3;\n                      break;\n                    case 6:\n                      _context9.n = 8;\n                      break;\n                    case 7:\n                      _context9.p = 7;\n                      _t11 = _context9.v;\n                      _iterator.e(_t11);\n                    case 8:\n                      _context9.p = 8;\n                      _iterator.f();\n                      return _context9.f(8);\n                    case 9:\n                      center2 = mapRef.current ? mapRef.current.getCenter() : null;\n                      enriched = merged.map(function (d) {\n                        var name = String(d.display_name || '');\n                        var nameL = name.toLowerCase();\n                        var matched = name.includes(query) || nameL.includes(qLower) || aliases.some(function (a) {\n                          return nameL.includes(a);\n                        });\n                        return _objectSpread(_objectSpread({}, d), {}, {\n                          __dist: center2 ? Math.hypot(parseFloat(d.lat) - center2.lat, parseFloat(d.lon) - center2.lng) : 0,\n                          __m: matched ? 1 : 0\n                        });\n                      }); // 稳定排序：以现有 suggestions 的顺序为主，新项追加到末尾\n                      rankMap = new Map();\n                      (suggestionsRef.current || []).forEach(function (s, idx) {\n                        var k = \"\".concat(s.lat, \"|\").concat(s.lon);\n                        if (!rankMap.has(k)) rankMap.set(k, idx);\n                      });\n                      nextRank = rankMap.size;\n                      enriched = enriched.map(function (d) {\n                        var k = \"\".concat(d.lat, \"|\").concat(d.lon);\n                        var r = rankMap.has(k) ? rankMap.get(k) : nextRank++;\n                        return _objectSpread(_objectSpread({}, d), {}, {\n                          __rank: r\n                        });\n                      });\n                      enriched.sort(function (a, b) {\n                        return b.__m - a.__m || a.__rank - b.__rank;\n                      });\n                      // 后台中文本地化前 N 条（顺序保持不变）\n                      (0,_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_4__[\"default\"])(/*#__PURE__*/_regenerator().m(function _callee8() {\n                        var topN, i, info, _t10;\n                        return _regenerator().w(function (_context8) {\n                          while (1) switch (_context8.p = _context8.n) {\n                            case 0:\n                              topN = Math.min(locTopCountRef.current, 10, enriched.length);\n                              i = 0;\n                            case 1:\n                              if (!(i < topN)) {\n                                _context8.n = 7;\n                                break;\n                              }\n                              _context8.p = 2;\n                              _context8.n = 3;\n                              return reverseGeocodeMultiDetailed(parseFloat(enriched[i].lat), parseFloat(enriched[i].lon));\n                            case 3:\n                              info = _context8.v;\n                              enriched[i] = _objectSpread(_objectSpread({}, enriched[i]), {}, {\n                                display_name: info.cn || enriched[i].display_name\n                              });\n                              _context8.n = 5;\n                              break;\n                            case 4:\n                              _context8.p = 4;\n                              _t10 = _context8.v;\n                            case 5:\n                              _context8.n = 6;\n                              return sleep(revDelayRef.current);\n                            case 6:\n                              i++;\n                              _context8.n = 1;\n                              break;\n                            case 7:\n                              if (reqId === searchReqIdRef.current) {\n                                lruSet(searchCache, cacheKey, enriched);\n                                setSuggestions(enriched);\n                              }\n                            case 8:\n                              return _context8.a(2);\n                          }\n                        }, _callee8, null, [[2, 4]]);\n                      }))();\n                      lruSet(searchCache, cacheKey, enriched);\n                      setSuggestions(enriched);\n                      // 调整中文化节奏\n                      t1 = typeof performance !== 'undefined' && performance.now ? performance.now() : Date.now();\n                      fails = 0; // 后台阶段不统计失败数量，使用首阶段延时经验\n                      if (t1 - t0 > 1500 || fails > 2) revDelayRef.current = Math.min(500, Math.round(revDelayRef.current * 1.5));else revDelayRef.current = Math.max(100, Math.round(revDelayRef.current * 0.9));\n                    case 10:\n                      return _context9.a(2);\n                  }\n                }, _callee9, null, [[2, 7, 8, 9]]);\n              }));\n              return function (_x14) {\n                return _ref8.apply(this, arguments);\n              };\n            }());\n            _context0.n = 12;\n            break;\n          case 11:\n            _context0.p = 11;\n            _t13 = _context0.v;\n            if (!axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].isCancel(_t13)) {\n              setError('地点搜索失败');\n              setSuggestions([]);\n            }\n          case 12:\n            _context0.p = 12;\n            setSearching(false);\n            return _context0.f(12);\n          case 13:\n            return _context0.a(2);\n        }\n      }, _callee0, null, [[5, 7], [3, 11, 12, 13]]);\n    }));\n    return function (_x13) {\n      return _ref6.apply(this, arguments);\n    };\n  }(), [useMapBounds]);\n  var debounceTimer = (0,react__WEBPACK_IMPORTED_MODULE_6__.useRef)(null);\n  var onSearchInputChange = function onSearchInputChange(val) {\n    setSearchQuery(val);\n    setSuggIndex(-1);\n    if (debounceTimer.current) clearTimeout(debounceTimer.current);\n    debounceTimer.current = setTimeout(function () {\n      return doSearch(val);\n    }, 280);\n  };\n  var chooseSuggestion = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(/*#__PURE__*/function () {\n    var _ref0 = (0,_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_4__[\"default\"])(/*#__PURE__*/_regenerator().m(function _callee1(s) {\n      var lat, lng, now, prev, seg, baseInfo, mode, approxNote, defaultNotes, item;\n      return _regenerator().w(function (_context1) {\n        while (1) switch (_context1.n) {\n          case 0:\n            if (s) {\n              _context1.n = 1;\n              break;\n            }\n            return _context1.a(2);\n          case 1:\n            lat = parseFloat(s.lat), lng = parseFloat(s.lon);\n            now = getNowDateTime();\n            prev = items[items.length - 1];\n            seg = prev ? haversineKm(prev.lat, prev.lng, lat, lng) : 0;\n            _context1.n = 2;\n            return reverseGeocodeMultiDetailed(lat, lng)[\"catch\"](function () {\n              return {\n                cn: s.display_name || '未命名',\n                local: s.display_name || '未命名'\n              };\n            });\n          case 2:\n            baseInfo = _context1.v;\n            mode = prev ? recommendTransport(seg, prev, baseInfo) : '';\n            approxNote = s.__approx ? '（按附近位置定位，建议在地图上精确放置）' : '';\n            defaultNotes = prev ? \"\\u4E0E\\u4E0A\\u4E2A\\u5730\\u70B9\\u76F4\\u7EBF\\u8DDD\\u79BB\\u7EA6 \".concat(seg.toFixed(1), \" km \\xB7 \\u4EA4\\u901A\\uFF1A\\u5EFA\\u8BAE\").concat(mode).concat(approxNote ? ' · ' + approxNote : '') : approxNote;\n            item = {\n              id: uid(),\n              placeId: String(s.place_id || s.osm_id || ''),\n              name: baseInfo.cn || s.display_name || '未命名地点',\n              nameLocal: baseInfo.local || '',\n              city: baseInfo.city || '',\n              province: baseInfo.province || '',\n              country: baseInfo.country || '',\n              lat: lat,\n              lng: lng,\n              date: now.date,\n              time: now.time,\n              notes: defaultNotes,\n              unlocated: !!s.__approx\n            };\n            addMarkerForItem(item);\n            setItems(function (prev) {\n              return [].concat((0,_babel_runtime_helpers_toConsumableArray__WEBPACK_IMPORTED_MODULE_2__[\"default\"])(prev), [item]);\n            });\n            setSuggestions([]);\n            setSearchQuery('');\n            setSuggIndex(-1);\n            if (mapRef.current) mapRef.current.setView([lat, lng], 14);\n          case 3:\n            return _context1.a(2);\n        }\n      }, _callee1);\n    }));\n    return function (_x15) {\n      return _ref0.apply(this, arguments);\n    };\n  }(), [items]);\n  var exportTxt = function exportTxt(name, list) {\n    var lines = [];\n    lines.push('计划名称: ' + (name || '未命名'));\n    lines.push('');\n    list.forEach(function (it, idx) {\n      lines.push(idx + 1 + '. ' + (it.name || '未命名地点'));\n      lines.push(('   时间: ' + (it.date || '') + ' ' + (it.time || '')).trim());\n      lines.push('   坐标: ' + it.lat + ', ' + it.lng);\n      if (it.notes) lines.push('   备注: ' + it.notes);\n    });\n    var blob = new Blob([lines.join('\\n')], {\n      type: 'text/plain;charset=utf-8'\n    });\n    var url = URL.createObjectURL(blob);\n    var a = document.createElement('a');\n    a.href = url;\n    a.download = (name || '旅行计划').replace(/[\\\\/:*?\"<>|]/g, '_') + '.txt';\n    a.click();\n    URL.revokeObjectURL(url);\n  };\n  var exportTxtWithDistances = function exportTxtWithDistances(name, list, distances) {\n    var lines = [];\n    lines.push('计划名称: ' + (name || '未命名'));\n    lines.push('');\n    for (var i = 0; i < list.length; i++) {\n      var it = list[i];\n      lines.push(i + 1 + '. ' + (it.name || '未命名地点'));\n      lines.push(('   时间: ' + (it.date || '') + ' ' + (it.time || '')).trim());\n      lines.push('   坐标: ' + it.lat + ', ' + it.lng);\n      if (i >= 1) {\n        var d = distances && distances[i];\n        if (d) lines.push('   与上个地点距离: ' + d.toFixed(1) + ' km');\n      }\n      if (it.notes) lines.push('   备注: ' + it.notes);\n    }\n    var blob = new Blob([lines.join('\\n')], {\n      type: 'text/plain;charset=utf-8'\n    });\n    var url = URL.createObjectURL(blob);\n    var a = document.createElement('a');\n    a.href = url;\n    a.download = (name || '旅行计划').replace(/[\\\\/:*?\"<>|]/g, '_') + '.txt';\n    a.click();\n    URL.revokeObjectURL(url);\n  };\n  var exportMarkdown = function exportMarkdown(name, groups, distances) {\n    var lines = [];\n    lines.push(\"# \".concat(name || '旅行计划'));\n    lines.push('');\n    groups.forEach(function (g) {\n      lines.push(\"## \".concat(g.day || '未设日期', \"  \\xB7 \\u5F53\\u5929\\u603B\\u8DDD\\u79BB \").concat(g.totalKm.toFixed(1), \" km \\xB7 \\u8D77\\u6B62 \").concat(g.start || '').concat(g.end ? ' - ' + g.end : ''));\n      g.entries.forEach(function (_ref1) {\n        var item = _ref1.item,\n          index = _ref1.index;\n        var d = distances && distances[index];\n        lines.push(\"- \".concat(index + 1, \". \").concat(item.date || '', \" \").concat(item.time || '', \" \\xB7 \").concat(item.name || '').concat(d ? \" \\xB7 \\u8DDD\\u4E0A\\u4E2A \".concat(d.toFixed(1), \" km\") : ''));\n        lines.push(\"  - \\u5750\\u6807: \".concat(item.lat, \", \").concat(item.lng));\n        if (item.notes) lines.push(\"  - \\u5907\\u6CE8: \".concat(item.notes));\n      });\n      lines.push('');\n    });\n    var blob = new Blob([lines.join('\\n')], {\n      type: 'text/markdown;charset=utf-8'\n    });\n    var url = URL.createObjectURL(blob);\n    var a = document.createElement('a');\n    a.href = url;\n    a.download = (name || '旅行计划').replace(/[\\\\/:*?\"<>|]/g, '_') + '.md';\n    a.click();\n    URL.revokeObjectURL(url);\n  };\n  var exportCSV = function exportCSV(name, list, distances) {\n    var rows = [['序号', '日期', '时间', '名称', '纬度', '经度', '距上个(km)', '备注']];\n    for (var i = 0; i < list.length; i++) {\n      var it = list[i];\n      var d = distances && distances[i];\n      rows.push([String(i + 1), it.date || '', it.time || '', (it.name || '').replace(/\\n/g, ' '), String(it.lat), String(it.lng), d ? d.toFixed(1) : '', (it.notes || '').replace(/\\n/g, ' ')]);\n    }\n    var csv = rows.map(function (r) {\n      return r.map(function (v) {\n        return \"\\\"\".concat(String(v).replace(/\"/g, '\"\"'), \"\\\"\");\n      }).join(',');\n    }).join('\\n');\n    var blob = new Blob([csv], {\n      type: 'text/csv;charset=utf-8'\n    });\n    var url = URL.createObjectURL(blob);\n    var a = document.createElement('a');\n    a.href = url;\n    a.download = (name || '旅行计划').replace(/[\\\\/:*?\"<>|]/g, '_') + '.csv';\n    a.click();\n    URL.revokeObjectURL(url);\n  };\n\n  // Narrative export similar to Chinese itinerary text\n  var exportNarrative = function exportNarrative(name, list) {\n    if (!Array.isArray(list) || !list.length) {\n      alert('没有内容可导出');\n      return;\n    }\n    var groups = list.slice().sort(function (a, b) {\n      var ad = a.date || '';\n      var bd = b.date || '';\n      if (ad !== bd) return ad < bd ? -1 : 1;\n      var at = a.time || '';\n      var bt = b.time || '';\n      return at < bt ? -1 : 1;\n    }).reduce(function (m, it) {\n      var d = it.date || '';\n      (m[d] = m[d] || []).push(it);\n      return m;\n    }, {});\n    var cnWeek = ['日', '一', '二', '三', '四', '五', '六'];\n    var fmtHeader = function fmtHeader(d) {\n      if (!d) return '';\n      try {\n        var dt = new Date(d.replace(/-/g, '/'));\n        var m = dt.getMonth() + 1;\n        var dd = dt.getDate();\n        return \"\".concat(m, \"\\u6708\").concat(dd, \"\\u65E5\\u5468\").concat(cnWeek[dt.getDay()]);\n      } catch (_) {\n        return d;\n      }\n    };\n    var toCnTime = function toCnTime(t) {\n      if (!t) return '';\n      var m = t.match(/^(\\d{1,2}):(\\d{2})$/);\n      if (!m) return t;\n      return \"\".concat(parseInt(m[1], 10), \"\\u70B9\").concat(m[2]);\n    };\n    var lines = [];\n    if (name) lines.push(name);\n    Object.keys(groups).sort().forEach(function (d) {\n      lines.push('');\n      lines.push(fmtHeader(d));\n      var idx = 1;\n      var _iterator2 = _createForOfIteratorHelper(groups[d]),\n        _step2;\n      try {\n        for (_iterator2.s(); !(_step2 = _iterator2.n()).done;) {\n          var it = _step2.value;\n          var type = it._type || 'poi';\n          if (type === 'timeEvent') {\n            if (it.notes && /^时间[:：]/.test(String(it.notes))) {\n              lines.push(String(it.notes));\n            } else if (it.time && it.name) {\n              lines.push(\"\\u65F6\\u95F4\\uFF1A\".concat(toCnTime(it.time), \"\\u5230\\u8FBE\").concat(it.name));\n            } else if (it.time) {\n              lines.push(\"\\u65F6\\u95F4\\uFF1A\".concat(toCnTime(it.time)));\n            }\n            if (it.notes && !/^时间[:：]/.test(String(it.notes))) {\n              lines.push(String(it.notes).trim());\n            }\n            continue;\n          }\n          if (!it.name) continue;\n          lines.push(\"\".concat(idx++, \"\\uFF0C\").concat(it.name));\n          if (it.notes) {\n            lines.push(String(it.notes).trim());\n          }\n        }\n      } catch (err) {\n        _iterator2.e(err);\n      } finally {\n        _iterator2.f();\n      }\n    });\n    var blob = new Blob([lines.join('\\n')], {\n      type: 'text/plain;charset=utf-8'\n    });\n    var url = URL.createObjectURL(blob);\n    var a = document.createElement('a');\n    a.href = url;\n    a.download = ((name || '旅行计划') + '-行程文案.txt').replace(/[\\\\/:*?\\\"<>|]/g, '_');\n    a.click();\n    URL.revokeObjectURL(url);\n  };\n\n  // Heuristic plan name from text and items\n  var derivePlanName = /*#__PURE__*/function () {\n    var _ref10 = (0,_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_4__[\"default\"])(/*#__PURE__*/_regenerator().m(function _callee10(rawText, items) {\n      var text, hasChangsha, hasYueyang, first, info, _t14;\n      return _regenerator().w(function (_context10) {\n        while (1) switch (_context10.p = _context10.n) {\n          case 0:\n            text = String(rawText || '');\n            hasChangsha = /长沙/.test(text) || items.some(function (it) {\n              return /长沙/.test(it.name || '');\n            });\n            hasYueyang = /岳阳/.test(text) || items.some(function (it) {\n              return /岳阳|君山|洞庭/.test(it.name || '');\n            });\n            if (!(hasChangsha && hasYueyang)) {\n              _context10.n = 1;\n              break;\n            }\n            return _context10.a(2, '长沙到岳阳旅行计划');\n          case 1:\n            _context10.p = 1;\n            first = items[0];\n            if (!first) {\n              _context10.n = 3;\n              break;\n            }\n            _context10.n = 2;\n            return reverseGeocodeMultiDetailed(first.lat, first.lng);\n          case 2:\n            info = _context10.v;\n            if (!(info && info.city)) {\n              _context10.n = 3;\n              break;\n            }\n            return _context10.a(2, \"\".concat(info.city, \"\\u65C5\\u884C\\u8BA1\\u5212\"));\n          case 3:\n            _context10.n = 5;\n            break;\n          case 4:\n            _context10.p = 4;\n            _t14 = _context10.v;\n          case 5:\n            return _context10.a(2, '我的旅行计划');\n        }\n      }, _callee10, null, [[1, 4]]);\n    }));\n    return function derivePlanName(_x16, _x17) {\n      return _ref10.apply(this, arguments);\n    };\n  }();\n\n  // Parse Chinese itinerary text into entries: { name, time, notes, dateStr | dayIndex }\n  var parseChineseItinerary = function parseChineseItinerary(text) {\n    var linesSrc = String(text || '').split(/\\r?\\n/);\n    var lines = [];\n    var _iterator3 = _createForOfIteratorHelper(linesSrc),\n      _step3;\n    try {\n      for (_iterator3.s(); !(_step3 = _iterator3.n()).done;) {\n        var s = _step3.value;\n        s = s.trim();\n        if (!s) {\n          lines.push('');\n          continue;\n        }\n        if (s === '↓') {\n          lines.push('');\n          continue;\n        } // treat arrow as separator\n        lines.push(s);\n      }\n    } catch (err) {\n      _iterator3.e(err);\n    } finally {\n      _iterator3.f();\n    }\n    var entries = [];\n    var dayHeaderRe = /^(?:\\d{1,2})月(?:\\d{1,2})日(?:周[一二三四五六日天])?$/;\n    var datePickRe = /(\\d{1,2})月(\\d{1,2})日/;\n    var timeLineRe = /^时间[:：]\\s*(.+)$/;\n    var numberedRe = /^(\\d{1,2})[，,、.]+\\s*(.+)$/;\n    var to24h = function to24h(s) {\n      if (!s) return '';\n      var m = s.match(/(上|下|中)?午?\\s*(\\d{1,2})\\s*点(?:\\s*(\\d{1,2}))?(?:\\s*半)?/);\n      if (m) {\n        var h = parseInt(m[2], 10) || 0;\n        var mm = parseInt(m[3] || '0', 10) || 0;\n        if (/下/.test(m[1] || '') && h < 12) h += 12; /* '中午' 不强制调整 */\n        var p = function p(n) {\n          return n < 10 ? '0' + n : '' + n;\n        };\n        return \"\".concat(p(h), \":\").concat(p(mm));\n      }\n      var m2 = s.match(/(\\d{1,2})[:：](\\d{2})/);\n      if (m2) {\n        var _p = function _p(n) {\n          return n < 10 ? '0' + n : '' + n;\n        };\n        return \"\".concat(_p(parseInt(m2[1], 10)), \":\").concat(_p(parseInt(m2[2], 10)));\n      }\n      return '';\n    };\n    var currentDateStr = '';\n    var pending = null; // {name,time,notes,dateStr,_type}\n    var stashNotes = '';\n    var pushPending = function pushPending() {\n      if (pending && pending.name) {\n        entries.push(_objectSpread({}, pending));\n      }\n      pending = null;\n    };\n    for (var _i2 = 0, _lines = lines; _i2 < _lines.length; _i2++) {\n      var raw = _lines[_i2];\n      if (!raw) {\n        pushPending();\n        continue;\n      }\n      if (dayHeaderRe.test(raw)) {\n        pushPending();\n        var m = raw.match(datePickRe);\n        if (m) {\n          var Y = new Date().getFullYear();\n          var mm = ('0' + parseInt(m[1], 10)).slice(-2);\n          var dd = ('0' + parseInt(m[2], 10)).slice(-2);\n          currentDateStr = \"\".concat(Y, \"-\").concat(mm, \"-\").concat(dd);\n        } else {\n          currentDateStr = '';\n        }\n        continue;\n      }\n      var tline = raw.match(timeLineRe);\n      if (tline) {\n        // e.g. 时间：13点40到达岳阳楼附近\n        var body = tline[1];\n        var t = to24h(body);\n        var nameMatch = body.match(/到达\\s*([^，。,\\s]+)/) || body.match(/到\\s*([^，。,\\s]+)/);\n        var place = nameMatch ? nameMatch[1] : '';\n        if (/^\\d/.test(place)) place = ''; // ignore pure time as place, e.g., 到12点\n        pushPending();\n        pending = {\n          name: place || '',\n          time: t || '',\n          notes: raw,\n          dateStr: currentDateStr || '',\n          _type: 'timeEvent'\n        };\n        continue;\n      }\n      var num = raw.match(numberedRe);\n      if (num) {\n        pushPending();\n        pending = {\n          name: (num[2] || '').trim(),\n          time: '',\n          notes: stashNotes || '',\n          dateStr: currentDateStr || '',\n          _type: 'poi'\n        };\n        stashNotes = '';\n        continue;\n      }\n      // other lines are notes for current item; if no pending, stash for next poi\n      if (!pending) {\n        stashNotes = (stashNotes ? stashNotes + '\\n' : '') + raw;\n        continue;\n      }\n      pending.notes = (pending.notes ? pending.notes + '\\n' : '') + raw;\n    }\n    pushPending();\n    // remove empty\n    return entries.filter(function (e) {\n      return e.name && e.name.trim() || e._type === 'timeEvent';\n    }).map(function (e) {\n      return _objectSpread(_objectSpread({}, e), {}, {\n        name: (e.name || '').replace(/^(周[一二三四五六日天])?/, '').trim()\n      });\n    });\n  };\n\n  // Sanitize name for geocoding\n  var sanitizePlaceName = function sanitizePlaceName(s) {\n    if (!s) return '';\n    var t = String(s).trim();\n    t = t.replace(/[，。、“”‘’\\(\\)（）]/g, ' ');\n    t = t.replace(/附近|周边|左右|大约|约/g, '').trim();\n    if (/^行程事件$/.test(t)) return '';\n    return t;\n  };\n\n  // Search places with Nominatim first; fall back to Overpass (within bounds) and Open-Meteo (cities); bias to map bounds; no custom headers to avoid preflight\n  var searchPlaces = /*#__PURE__*/function () {\n    var _ref11 = (0,_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_4__[\"default\"])(/*#__PURE__*/_regenerator().m(function _callee11(q) {\n      var name, params, overpassBBox, z, b, west, east, north, south, mode, nomiEnabled, res, arr, out, escapeRegex, qstr, overpassQL, resp, els, _out, om, _arr, _out2, key, _resp, pois, mapped, _t15, _t16, _t17, _t18;\n      return _regenerator().w(function (_context11) {\n        while (1) switch (_context11.p = _context11.n) {\n          case 0:\n            name = sanitizePlaceName(q);\n            if (name) {\n              _context11.n = 1;\n              break;\n            }\n            return _context11.a(2, []);\n          case 1:\n            params = {\n              format: 'jsonv2',\n              q: name,\n              limit: 5,\n              addressdetails: 1,\n              namedetails: 1,\n              'accept-language': 'zh-CN',\n              countrycodes: 'cn'\n            }; // bias by current bounds if available\n            overpassBBox = '';\n            if (mapRef.current) {\n              try {\n                z = mapRef.current.getZoom ? mapRef.current.getZoom() : 0;\n                if (z >= 9) {\n                  b = mapRef.current.getBounds();\n                  west = b.getWest().toFixed(3), east = b.getEast().toFixed(3), north = b.getNorth().toFixed(3), south = b.getSouth().toFixed(3);\n                  params.viewbox = \"\".concat(west, \",\").concat(north, \",\").concat(east, \",\").concat(south);\n                  params.bounded = 1;\n                  // overpass bbox: south,west,north,east\n                  overpassBBox = \"\".concat(south, \",\").concat(west, \",\").concat(north, \",\").concat(east);\n                }\n              } catch (_) {}\n            }\n            // try Nominatim (skip in stable mode or when blocked)\n            _context11.p = 2;\n            mode = getGeoMode();\n            nomiEnabled = mode !== 'stable' && Date.now() > (nomiBlockedUntilRef.current || 0);\n            if (!nomiEnabled) {\n              _context11.n = 4;\n              break;\n            }\n            _context11.n = 3;\n            return gateNominatim(function () {\n              return withRetry(function () {\n                return axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].get('https://nominatim.openstreetmap.org/search', {\n                  params: params,\n                  timeout: 1500\n                });\n              }, {\n                retries: 1,\n                baseDelay: 600\n              });\n            });\n          case 3:\n            res = _context11.v;\n            arr = Array.isArray(res && res.data) ? res.data : [];\n            if (!arr.length) {\n              _context11.n = 4;\n              break;\n            }\n            out = arr.slice(0, 5).map(function (d) {\n              return {\n                source: 'nominatim',\n                place_id: String(d.place_id || ''),\n                display_name: d.display_name || name,\n                lat: d.lat,\n                lon: d.lon\n              };\n            });\n            return _context11.a(2, out);\n          case 4:\n            _context11.n = 6;\n            break;\n          case 5:\n            _context11.p = 5;\n            _t15 = _context11.v;\n            nomiBlockedUntilRef.current = Date.now() + 10 * 60 * 1000; /* fallback below */\n          case 6:\n            if (!overpassBBox) {\n              _context11.n = 11;\n              break;\n            }\n            _context11.p = 7;\n            escapeRegex = function escapeRegex(s) {\n              return String(s).replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n            };\n            qstr = escapeRegex(name);\n            overpassQL = \" [out:json][timeout:12];\\n( node[\\\"name:zh\\\"~\\\"\".concat(qstr, \"\\\",i](\").concat(overpassBBox, \");\\n  way[\\\"name:zh\\\"~\\\"\").concat(qstr, \"\\\",i](\").concat(overpassBBox, \");\\n  relation[\\\"name:zh\\\"~\\\"\").concat(qstr, \"\\\",i](\").concat(overpassBBox, \");\\n  node[\\\"name\\\"~\\\"\").concat(qstr, \"\\\",i](\").concat(overpassBBox, \");\\n  way[\\\"name\\\"~\\\"\").concat(qstr, \"\\\",i](\").concat(overpassBBox, \");\\n  relation[\\\"name\\\"~\\\"\").concat(qstr, \"\\\",i](\").concat(overpassBBox, \");\\n); out center 20;\");\n            _context11.n = 8;\n            return axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].post('https://overpass-api.de/api/interpreter', \"data=\".concat(encodeURIComponent(overpassQL)), {\n              headers: {\n                'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'\n              },\n              timeout: 8000\n            });\n          case 8:\n            resp = _context11.v;\n            els = resp.data && resp.data.elements || [];\n            _out = els.slice(0, 10).map(function (el) {\n              var tags = el.tags || {};\n              var nameZh = tags['name:zh'];\n              var nameN = tags.name || nameZh || '未命名';\n              var lat = el.lat != null ? el.lat : el.center && el.center.lat;\n              var lon = el.lon != null ? el.lon : el.center && el.center.lon;\n              return {\n                source: 'overpass',\n                place_id: String(el.id),\n                display_name: nameZh || nameN,\n                lat: String(lat || ''),\n                lon: String(lon || '')\n              };\n            }).filter(function (d) {\n              return d.lat && d.lon;\n            });\n            if (!_out.length) {\n              _context11.n = 9;\n              break;\n            }\n            return _context11.a(2, _out);\n          case 9:\n            _context11.n = 11;\n            break;\n          case 10:\n            _context11.p = 10;\n            _t16 = _context11.v;\n          case 11:\n            _context11.p = 11;\n            _context11.n = 12;\n            return axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].get('https://geocoding-api.open-meteo.com/v1/search', {\n              params: {\n                name: name,\n                count: 6,\n                language: 'zh',\n                format: 'json'\n              },\n              timeout: 5000\n            });\n          case 12:\n            om = _context11.v;\n            _arr = om.data && om.data.results || [];\n            _out2 = _arr.slice(0, 6).map(function (r) {\n              return {\n                source: 'openmeteo',\n                place_id: String(r.id || ''),\n                display_name: [r.name, r.admin1, r.country].filter(Boolean).join(' · '),\n                lat: String(r.latitude),\n                lon: String(r.longitude)\n              };\n            });\n            if (!_out2.length) {\n              _context11.n = 13;\n              break;\n            }\n            return _context11.a(2, _out2);\n          case 13:\n            _context11.n = 15;\n            break;\n          case 14:\n            _context11.p = 14;\n            _t17 = _context11.v;\n          case 15:\n            _context11.p = 15;\n            key = getAmapKey();\n            if (!key) {\n              _context11.n = 17;\n              break;\n            }\n            _context11.n = 16;\n            return axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].get('https://restapi.amap.com/v5/place/text', {\n              params: {\n                key: key,\n                keywords: name,\n                page_size: 8,\n                page_num: 1\n              },\n              timeout: 5000\n            });\n          case 16:\n            _resp = _context11.v;\n            pois = _resp.data && _resp.data.pois || [];\n            mapped = pois.map(function (p) {\n              var lat = 0,\n                lon = 0;\n              if (p.location) {\n                var _String$split3 = String(p.location).split(','),\n                  _String$split4 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_String$split3, 2),\n                  x = _String$split4[0],\n                  y = _String$split4[1];\n                lon = parseFloat(x);\n                lat = parseFloat(y);\n                var _gcj02ToWgs3 = gcj02ToWgs84(lon, lat),\n                  _gcj02ToWgs4 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_gcj02ToWgs3, 2),\n                  wgsLon = _gcj02ToWgs4[0],\n                  wgsLat = _gcj02ToWgs4[1];\n                lon = wgsLon;\n                lat = wgsLat;\n              }\n              var title = p.name || '';\n              var ad = [p.cityname || '', p.adname || '', p.address || ''].filter(Boolean).join(' ');\n              return {\n                source: 'amap',\n                place_id: String(p.id || ''),\n                display_name: ad ? \"\".concat(title, \" \\xB7 \").concat(ad) : title,\n                lat: String(lat),\n                lon: String(lon)\n              };\n            }).filter(function (d) {\n              return d.lat && d.lon;\n            });\n            if (!mapped.length) {\n              _context11.n = 17;\n              break;\n            }\n            return _context11.a(2, mapped);\n          case 17:\n            _context11.n = 19;\n            break;\n          case 18:\n            _context11.p = 18;\n            _t18 = _context11.v;\n          case 19:\n            return _context11.a(2, []);\n        }\n      }, _callee11, null, [[15, 18], [11, 14], [7, 10], [2, 5]]);\n    }));\n    return function searchPlaces(_x18) {\n      return _ref11.apply(this, arguments);\n    };\n  }();\n  var parseTimeVal = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(function (it) {\n    var d = it.date || '';\n    var t = it.time || '';\n    var ts = (d + ' ' + t).trim();\n    return ts ? Date.parse(ts.replace(/-/g, '/')) || Number.MAX_SAFE_INTEGER : Number.MAX_SAFE_INTEGER;\n  }, []);\n  var sortItemsForTimeline = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(function (list) {\n    if (timelineManualOrder) return list.slice();\n    var withIndex = list.map(function (it, i) {\n      return _objectSpread(_objectSpread({}, it), {}, {\n        __idx: i\n      });\n    });\n    return withIndex.slice().sort(function (a, b) {\n      var av = parseTimeVal(a),\n        bv = parseTimeVal(b);\n      if (av === bv) return a.__idx - b.__idx;\n      return av - bv;\n    });\n  }, [timelineManualOrder, parseTimeVal]);\n  var timelineItems = (0,react__WEBPACK_IMPORTED_MODULE_6__.useMemo)(function () {\n    return sortItemsForTimeline(items);\n  }, [items, sortItemsForTimeline]);\n  var resetTimelineAuto = function resetTimelineAuto() {\n    setItems(function (prev) {\n      return sortItemsForTimeline(prev);\n    });\n    setTimelineManualOrder(false);\n  };\n\n  // compute segment distances and update polylines\n  var segmentDistances = (0,react__WEBPACK_IMPORTED_MODULE_6__.useMemo)(function () {\n    var arr = items.map(function () {\n      return null;\n    });\n    for (var i = 1; i < items.length; i++) {\n      var a = items[i - 1],\n        b = items[i];\n      if (!a || !b || a.unlocated || b.unlocated) {\n        arr[i] = null;\n        continue;\n      }\n      if (!isFinite(a.lat) || !isFinite(a.lng) || !isFinite(b.lat) || !isFinite(b.lng)) {\n        arr[i] = null;\n        continue;\n      }\n      arr[i] = haversineKm(a.lat, a.lng, b.lat, b.lng);\n    }\n    return arr; // index i: distance from i-1 to i\n  }, [items]);\n  var distanceStats = (0,react__WEBPACK_IMPORTED_MODULE_6__.useMemo)(function () {\n    var total = 0;\n    var perDay = {};\n    for (var i = 1; i < items.length; i++) {\n      var d = segmentDistances[i];\n      if (!d) continue;\n      total += d;\n      var day = items[i].date || '';\n      if (!perDay[day]) perDay[day] = 0;\n      perDay[day] += d;\n    }\n    return {\n      total: total,\n      perDay: perDay\n    };\n  }, [items, segmentDistances]);\n\n  // OSRM 路线型距离（可选）\n  (0,react__WEBPACK_IMPORTED_MODULE_6__.useEffect)(function () {\n    var canceled = false;\n    if (!useRouteDistance) {\n      setRouteDistances([]);\n      return;\n    }\n    var run = /*#__PURE__*/function () {\n      var _ref12 = (0,_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_4__[\"default\"])(/*#__PURE__*/_regenerator().m(function _callee12() {\n        var results, tasks, fail, totalReq, _loop, _ret, i;\n        return _regenerator().w(function (_context13) {\n          while (1) switch (_context13.n) {\n            case 0:\n              setOsrmWarn('');\n              results = new Array(items.length).fill(null);\n              tasks = [];\n              fail = 0;\n              totalReq = 0;\n              _loop = /*#__PURE__*/_regenerator().m(function _loop(i) {\n                var a, b, key, cached, url;\n                return _regenerator().w(function (_context12) {\n                  while (1) switch (_context12.n) {\n                    case 0:\n                      a = items[i - 1], b = items[i];\n                      if (!(a.unlocated || b.unlocated)) {\n                        _context12.n = 1;\n                        break;\n                      }\n                      return _context12.a(2, 0);\n                    case 1:\n                      if (!(!isFinite(a.lat) || !isFinite(a.lng) || !isFinite(b.lat) || !isFinite(b.lng))) {\n                        _context12.n = 2;\n                        break;\n                      }\n                      return _context12.a(2, 0);\n                    case 2:\n                      key = \"\".concat(a.lat.toFixed(5), \",\").concat(a.lng.toFixed(5), \"|\").concat(b.lat.toFixed(5), \",\").concat(b.lng.toFixed(5));\n                      cached = routeCacheRef.current.get(key);\n                      if (!cached) {\n                        _context12.n = 3;\n                        break;\n                      }\n                      results[i] = cached;\n                      return _context12.a(2, 0);\n                    case 3:\n                      url = \"https://router.project-osrm.org/route/v1/driving/\".concat(a.lng, \",\").concat(a.lat, \";\").concat(b.lng, \",\").concat(b.lat, \"?overview=false&alternatives=false&steps=false\");\n                      totalReq++;\n                      tasks.push(axios__WEBPACK_IMPORTED_MODULE_7__[\"default\"].get(url, {\n                        timeout: 8000\n                      }).then(function (res) {\n                        var routes = res.data && res.data.routes;\n                        var meters = routes && routes[0] && routes[0].distance;\n                        var km = meters ? meters / 1000 : null;\n                        if (km) {\n                          routeCacheRef.current.set(key, km);\n                          results[i] = km;\n                        }\n                      })[\"catch\"](function () {\n                        fail++;\n                      }));\n                    case 4:\n                      return _context12.a(2);\n                  }\n                }, _loop);\n              });\n              i = 1;\n            case 1:\n              if (!(i < items.length)) {\n                _context13.n = 4;\n                break;\n              }\n              return _context13.d(_regeneratorValues(_loop(i)), 2);\n            case 2:\n              _ret = _context13.v;\n              if (!(_ret === 0)) {\n                _context13.n = 3;\n                break;\n              }\n              return _context13.a(3, 3);\n            case 3:\n              i++;\n              _context13.n = 1;\n              break;\n            case 4:\n              _context13.n = 5;\n              return Promise.allSettled(tasks);\n            case 5:\n              if (!canceled) {\n                setRouteDistances(results);\n                if (totalReq > 0 && fail / totalReq >= 0.5) {\n                  setOsrmWarn('OSRM 路线服务当前不可用，已自动降级为直线距离');\n                  setUseRouteDistance(false);\n                } else if (fail > 0) {\n                  setOsrmWarn('部分路线计算失败，已使用直线距离降级');\n                }\n              }\n            case 6:\n              return _context13.a(2);\n          }\n        }, _callee12);\n      }));\n      return function run() {\n        return _ref12.apply(this, arguments);\n      };\n    }();\n    run();\n    return function () {\n      canceled = true;\n    };\n  }, [items, useRouteDistance]);\n\n  // 根据路线/直线选择最终展示距离\n  var finalDistances = (0,react__WEBPACK_IMPORTED_MODULE_6__.useMemo)(function () {\n    var arr = items.map(function () {\n      return null;\n    });\n    for (var i = 1; i < items.length; i++) {\n      var r = routeDistances[i];\n      var s = segmentDistances[i];\n      arr[i] = useRouteDistance && isFinite(r) && r > 0 ? r : s;\n    }\n    return arr;\n  }, [items, routeDistances, segmentDistances, useRouteDistance]);\n  var distanceStatsFinal = (0,react__WEBPACK_IMPORTED_MODULE_6__.useMemo)(function () {\n    var total = 0;\n    var perDay = {};\n    for (var i = 1; i < items.length; i++) {\n      var d = finalDistances[i];\n      if (!d) continue;\n      total += d;\n      var day = items[i].date || '';\n      if (!perDay[day]) perDay[day] = 0;\n      perDay[day] += d;\n    }\n    return {\n      total: total,\n      perDay: perDay\n    };\n  }, [items, finalDistances]);\n\n  // 分天分组\n  var dayGroups = (0,react__WEBPACK_IMPORTED_MODULE_6__.useMemo)(function () {\n    var map = new Map();\n    items.forEach(function (it, index) {\n      var day = it.date || '未设日期';\n      if (!map.has(day)) map.set(day, []);\n      map.get(day).push({\n        item: it,\n        index: index\n      });\n    });\n    var res = [];\n    var _iterator4 = _createForOfIteratorHelper(map.entries()),\n      _step4;\n    try {\n      var _loop2 = function _loop2() {\n        var _step4$value = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_step4.value, 2),\n          day = _step4$value[0],\n          entries = _step4$value[1];\n        var total = 0;\n        entries.forEach(function (_ref13) {\n          var index = _ref13.index;\n          if (index >= 1 && items[index].date === day) {\n            var d = finalDistances[index];\n            if (d) total += d;\n          }\n        });\n        var times = entries.map(function (_ref14) {\n          var item = _ref14.item;\n          return item.time;\n        }).filter(Boolean).sort();\n        var start = times[0] || '';\n        var end = times[times.length - 1] || '';\n        res.push({\n          day: day,\n          entries: entries,\n          totalKm: total,\n          start: start,\n          end: end\n        });\n      };\n      for (_iterator4.s(); !(_step4 = _iterator4.n()).done;) {\n        _loop2();\n      }\n    } catch (err) {\n      _iterator4.e(err);\n    } finally {\n      _iterator4.f();\n    }\n    res.sort(function (a, b) {\n      return (a.day || '').localeCompare(b.day || '');\n    });\n    return res;\n  }, [items, finalDistances]);\n\n  // 工具：按日期时间排序\n  var sortByDateTime = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(function () {\n    setItems(function (prev) {\n      return prev.slice().sort(function (a, b) {\n        var av = parseTimeVal(a);\n        var bv = parseTimeVal(b);\n        return av - bv;\n      });\n    });\n    setViewMode('day');\n  }, [parseTimeVal]);\n\n  // 备注增强：快速设置耗时\n  var applyDuration = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(function (id, duration) {\n    setItems(function (prev) {\n      var idx = prev.findIndex(function (it) {\n        return it.id === id;\n      });\n      if (idx < 0) return prev;\n      var it = prev[idx];\n      var notes = String(it.notes || '');\n      var re = /(耗时：)([^。；;，,\\n]*)/;\n      if (re.test(notes)) {\n        notes = notes.replace(re, function (_, p1) {\n          return \"\".concat(p1).concat(duration);\n        });\n      } else if (notes.trim()) {\n        notes = notes + \" \\xB7 \\u8017\\u65F6\\uFF1A\".concat(duration);\n      } else {\n        notes = \"\\u8017\\u65F6\\uFF1A\".concat(duration);\n      }\n      var next = prev.slice();\n      next[idx] = _objectSpread(_objectSpread({}, it), {}, {\n        notes: notes\n      });\n      return next;\n    });\n  }, []);\n\n  // 起点/终点标记\n  var setStartOfDay = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(function (day, id) {\n    setItems(function (prev) {\n      return prev.map(function (it) {\n        return it.date === day ? _objectSpread(_objectSpread({}, it), {}, {\n          startOfDay: it.id === id\n        }) : it;\n      });\n    });\n  }, []);\n  var setEndOfDay = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(function (day, id) {\n    setItems(function (prev) {\n      return prev.map(function (it) {\n        return it.date === day ? _objectSpread(_objectSpread({}, it), {}, {\n          endOfDay: it.id === id\n        }) : it;\n      });\n    });\n  }, []);\n  (0,react__WEBPACK_IMPORTED_MODULE_6__.useEffect)(function () {\n    if (!mapRef.current || !window.L) return;\n    if (!polylineGroupRef.current) return;\n    try {\n      polylineGroupRef.current.clearLayers();\n    } catch (_) {}\n    for (var i = 1; i < items.length; i++) {\n      var a = items[i - 1],\n        b = items[i];\n      if (a && b && !a.unlocated && !b.unlocated && isFinite(a.lat) && isFinite(a.lng) && isFinite(b.lat) && isFinite(b.lng)) {\n        try {\n          var pl = window.L.polyline([[a.lat, a.lng], [b.lat, b.lng]], {\n            color: '#2952ff',\n            weight: 2,\n            opacity: 0.9,\n            dashArray: '6,6'\n          });\n          polylineGroupRef.current.addLayer(pl);\n        } catch (_) {}\n      }\n    }\n  }, [items]);\n\n  // templates for notes\n  var applyNoteTemplate = (0,react__WEBPACK_IMPORTED_MODULE_6__.useCallback)(function (id, type) {\n    setItems(function (prev) {\n      var idx = prev.findIndex(function (it) {\n        return it.id === id;\n      });\n      if (idx < 0) return prev;\n      var it = prev[idx];\n      var prevIt = idx > 0 ? prev[idx - 1] : null;\n      var dt = formatCnDate(it.date || '');\n      var dist = prevIt ? haversineKm(prevIt.lat, prevIt.lng, it.lat, it.lng) : 0;\n      var text = it.notes || '';\n      var distStr = prevIt ? \"\\u4E0E\\u4E0A\\u4E2A\\u5730\\u70B9\\u76F4\\u7EBF\\u8DDD\\u79BB\\u7EA6 \".concat(dist.toFixed(1), \" km\\u3002\") : '';\n      if (type === 'play') {\n        text = \"\".concat(dt, \" \\u5728\\u300C\").concat(it.name || '此地', \"\\u300D\\u73A9\\u4EC0\\u4E48\\u9879\\u76EE\\uFF0C\\u9884\\u8BA1\\u6D88\\u8D39 XXX \\u5143\\u3002\");\n      } else if (type === 'move') {\n        text = \"\".concat(dt, \" \\u4ECE\\u300C\").concat(prevIt && prevIt.name || '上个地点', \"\\u300D\\u5230\\u300C\").concat(it.name || '此地', \"\\u300D\\uFF0C\\u76F4\\u7EBF\\u8DDD\\u79BB\\u7EA6 \").concat(dist.toFixed(1), \" km\\u3002\\u4EA4\\u901A\\uFF1A \\uFF0C\\u8017\\u65F6\\uFF1A \\uFF0C\\u9884\\u8BA1\\u6D88\\u8D39 XXX \\u5143\\u3002\");\n      } else if (type === 'stay') {\n        text = \"\".concat(dt, \" \\u5728\\u300C\").concat(it.name || '此地', \"\\u300D\\u5165\\u4F4F\\u9152\\u5E97\\uFF08\\u540D\\u79F0\\uFF1A \\uFF09\\uFF0C\\u9884\\u8BA1\\u6D88\\u8D39 XXX \\u5143\\u3002\");\n      }\n      // write back\n      var next = prev.slice();\n      next[idx] = _objectSpread(_objectSpread({}, it), {}, {\n        notes: text\n      });\n      return next;\n    });\n  }, []);\n  return /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"jihua-page\"\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"header\", {\n    className: \"jihua-header\"\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"controls-primary\"\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"brand\"\n  }, \"\\u65C5\\u884C\\u8BA1\\u5212\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"icon-btn \".concat(useMapBounds ? 'active' : ''),\n    title: \"\\u5C31\\u8FD1\\u4F18\\u5148\\uFF08\\u6309\\u5F53\\u524D\\u5730\\u56FE\\u8303\\u56F4\\u641C\\u7D22\\uFF09\",\n    onClick: function onClick() {\n      return setUseMapBounds(function (v) {\n        return !v;\n      });\n    }\n  }, useMapBounds ? '就近' : '全局'), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"select\", {\n    className: \"tile-select\",\n    \"aria-label\": \"\\u74E6\\u7247\\u6E90\",\n    value: tileKey,\n    onChange: function onChange(e) {\n      return setTileKey(e.target.value);\n    },\n    disabled: !mapReady\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n    value: \"amap\"\n  }, \"\\u9AD8\\u5FB7(\\u9053\\u8DEF-\\u6DF1\\u8272)\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n    value: \"esriStreet\"\n  }, \"Esri\\u8857\\u9053\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n    value: \"esriImagery\"\n  }, \"Esri\\u5F71\\u50CF\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n    value: \"default\"\n  }, \"OSM\"), hasTdtToken() ? /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n    value: \"tdtVec\"\n  }, \"\\u5929\\u5730\\u56FE-\\u77E2\\u91CF\") : null, hasTdtToken() ? /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n    value: \"tdtImg\"\n  }, \"\\u5929\\u5730\\u56FE-\\u5F71\\u50CF\") : null, getRuntimeMapConfig().customTile.url ? /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n    value: \"custom\"\n  }, \"\\u81EA\\u5B9A\\u4E49\\u74E6\\u7247\") : null), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"search-wrap\",\n    style: {\n      position: 'relative',\n      minWidth: 220,\n      flex: '0 1 340px'\n    }\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"input\", {\n    disabled: !mapReady,\n    className: \"search-input\",\n    style: {\n      width: '100%'\n    },\n    placeholder: \"\\u641C\\u7D22\\u5730\\u70B9\\uFF08\\u8F93\\u5165\\u22652\\u4E2A\\u5B57\\uFF09\\u56DE\\u8F66\\u6216\\u505C\\u987F\\u89E6\\u53D1\",\n    \"aria-label\": \"\\u641C\\u7D22\\u5730\\u70B9\",\n    value: searchQuery,\n    onChange: function onChange(e) {\n      return onSearchInputChange(e.target.value);\n    },\n    onKeyDown: function onKeyDown(e) {\n      var visLen = Math.min(suggestions.length, suggMax);\n      if (e.key === 'ArrowDown') {\n        e.preventDefault();\n        if (visLen) {\n          setSuggIndex(function (i) {\n            return Math.min(i + 1, visLen - 1);\n          });\n        }\n        return;\n      }\n      if (e.key === 'ArrowUp') {\n        e.preventDefault();\n        if (visLen) {\n          setSuggIndex(function (i) {\n            return Math.max(i - 1, 0);\n          });\n        }\n        return;\n      }\n      if (e.key === 'Enter') {\n        e.preventDefault();\n        if (suggIndex >= 0 && suggIndex < visLen) {\n          chooseSuggestion(suggestions[suggIndex]);\n        } else {\n          doSearch(searchQuery);\n        }\n        return;\n      }\n      if (e.key === 'Escape') {\n        setSuggestions([]);\n        setSuggIndex(-1);\n        return;\n      }\n    }\n  }), String(searchQuery || '').trim().length >= 2 && /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"suggestions\",\n    role: \"listbox\",\n    \"aria-label\": \"\\u641C\\u7D22\\u5EFA\\u8BAE\\u5217\\u8868\",\n    style: {\n      position: 'absolute',\n      top: 'calc(100% + 4px)',\n      left: 0,\n      right: 0,\n      zIndex: 4000,\n      maxHeight: '40vh',\n      overflowY: 'auto'\n    }\n  }, searching && /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"suggestion-item\"\n  }, \"\\u641C\\u7D22\\u4E2D\\u2026\"), suggestions.slice(0, suggMax).map(function (s, idx) {\n    return /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      key: (s.place_id || s.osm_id || \"\".concat(s.lat, \",\").concat(s.lon, \",\").concat(s.display_name || '')) + \"#\".concat(idx),\n      className: \"suggestion-item \".concat(idx === suggIndex ? 'selected' : ''),\n      role: \"option\",\n      \"aria-selected\": idx === suggIndex,\n      onClick: /*#__PURE__*/(0,_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_4__[\"default\"])(/*#__PURE__*/_regenerator().m(function _callee13() {\n        return _regenerator().w(function (_context14) {\n          while (1) switch (_context14.n) {\n            case 0:\n              _context14.n = 1;\n              return chooseSuggestion(s);\n            case 1:\n              return _context14.a(2);\n          }\n        }, _callee13);\n      }))\n    }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      className: \"sugg-title\"\n    }, s.display_name), mapRef.current ? /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      className: \"sugg-meta\"\n    }, function () {\n      try {\n        var c = mapRef.current.getCenter();\n        var dy = parseFloat(s.lat) - c.lat;\n        var dx = parseFloat(s.lon) - c.lng;\n        var dist = Math.sqrt(dx * dx + dy * dy) * 111;\n        return \"\".concat(dist.toFixed(1), \" km\");\n      } catch (_) {\n        return '';\n      }\n    }()) : null);\n  }), !searching && suggestions.length === 0 && /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"suggestion-item\"\n  }, \"\\u65E0\\u641C\\u7D22\\u7ED3\\u679C\"))), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"icon-btn\",\n    style: {\n      position: 'relative',\n      zIndex: 5001\n    },\n    title: \"\\u5B9A\\u4F4D\\u5F53\\u524D\\u4F4D\\u7F6E\",\n    onClick: function onClick() {\n      // 关闭下拉建议，避免遮挡点击\n      setSuggestions([]);\n      if (!navigator.geolocation) {\n        setError('当前浏览器不支持定位');\n        return;\n      }\n      navigator.geolocation.getCurrentPosition(function (pos) {\n        var _pos$coords = pos.coords,\n          latitude = _pos$coords.latitude,\n          longitude = _pos$coords.longitude;\n        if (mapRef.current) mapRef.current.setView([latitude, longitude], 14);\n      }, function () {\n        return setError('定位失败，请检查权限');\n      });\n    }\n  }, \"\\u5B9A\\u4F4D\\u5F53\\u524D\\u4F4D\\u7F6E\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"span\", {\n    className: \"spacer\"\n  }), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    \"aria-label\": \"\\u66F4\\u591A\",\n    className: \"icon-btn\",\n    onClick: function onClick() {\n      return setShowExtra(function (v) {\n        return !v;\n      });\n    }\n  }, showExtra ? '收起' : '更多')), showExtra && /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"controls-more\"\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"controls-col\"\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"view-toggle\"\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"icon-btn \".concat(viewMode === 'list' ? 'active' : ''),\n    onClick: function onClick() {\n      return setViewMode('list');\n    }\n  }, \"\\u5217\\u8868\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"icon-btn \".concat(viewMode === 'timeline' ? 'active' : ''),\n    onClick: function onClick() {\n      return setViewMode('timeline');\n    }\n  }, \"\\u65F6\\u95F4\\u8F74\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"icon-btn \".concat(viewMode === 'day' ? 'active' : ''),\n    onClick: function onClick() {\n      return setViewMode('day');\n    }\n  }, \"\\u6309\\u5929\"), viewMode === 'timeline' ? /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"icon-btn\",\n    onClick: resetTimelineAuto,\n    title: \"\\u6309\\u65F6\\u95F4\\u6392\\u5E8F\"\n  }, \"\\u6309\\u65F6\\u95F4\\u6392\\u5E8F\") : null, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"icon-btn\",\n    onClick: sortByDateTime,\n    title: \"\\u6309\\u65E5\\u671F\\u65F6\\u95F4\\u6392\\u5E8F\\u5E76\\u5207\\u6362\\u6309\\u5929\\u89C6\\u56FE\"\n  }, \"\\u6309\\u65E5\\u671F\\u6392\\u5E8F\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"icon-btn \".concat(useRouteDistance ? 'active' : ''),\n    onClick: function onClick() {\n      return setUseRouteDistance(function (v) {\n        return !v;\n      });\n    },\n    title: \"\\u8DEF\\u7EBF\\u578B\\u8DDD\\u79BB\\uFF08OSRM\\uFF09\"\n  }, \"\\u8DEF\\u7EBF\\u8DDD\\u79BB\")), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    style: {\n      display: 'flex',\n      alignItems: 'center',\n      gap: 8\n    }\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"span\", {\n    style: {\n      color: '#6b7280'\n    }\n  }, \"\\u5730\\u56FE\\u9AD8\\u5EA6\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"input\", {\n    type: \"range\",\n    min: 200,\n    max: Math.round(window.innerHeight * 0.8),\n    value: mapHeight,\n    onChange: function onChange(e) {\n      return setMapHeight(parseInt(e.target.value || '0', 10) || mapHeight);\n    }\n  }), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"span\", {\n    style: {\n      minWidth: 36,\n      textAlign: 'right'\n    }\n  }, Math.round(mapHeight), \"px\")), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    style: {\n      display: 'flex',\n      alignItems: 'center',\n      gap: 8\n    }\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"span\", {\n    style: {\n      color: '#6b7280'\n    }\n  }, \"\\u5EFA\\u8BAE\\u6761\\u6570\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"select\", {\n    value: suggMax,\n    onChange: function onChange(e) {\n      var v = parseInt(e.target.value || '5', 10);\n      setSuggMax([3, 5, 8].includes(v) ? v : 5);\n    }\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n    value: 3\n  }, \"3\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n    value: 5\n  }, \"5\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n    value: 8\n  }, \"8\")))))), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"map-container\",\n    ref: containerRef,\n    \"aria-label\": \"\\u5730\\u56FE\"\n  }), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"splitter\",\n    onPointerDown: function onPointerDown(e) {\n      draggingRef.current = true;\n      startYRef.current = e.clientY || 0;\n      startHRef.current = mapHeight;\n      document.body.style.userSelect = 'none';\n      try {\n        e.currentTarget.setPointerCapture && e.currentTarget.setPointerCapture(e.pointerId);\n      } catch (_) {}\n      var onMove = function onMove(ev) {\n        if (!draggingRef.current) return;\n        var dy = (ev.clientY || 0) - startYRef.current;\n        var h = startHRef.current + dy;\n        var minH = 120;\n        var minSheet = 220;\n        var maxH = Math.max(minH, window.innerHeight - minSheet);\n        if (h < minH) h = minH;\n        if (h > maxH) h = maxH;\n        setMapHeight(h);\n        if (mapRef.current) mapRef.current.invalidateSize();\n      };\n      var _onUp = function onUp() {\n        draggingRef.current = false;\n        document.body.style.userSelect = '';\n        window.removeEventListener('pointermove', onMove, true);\n        window.removeEventListener('pointerup', _onUp, true);\n        if (mapRef.current) setTimeout(function () {\n          return mapRef.current.invalidateSize();\n        }, 50);\n      };\n      window.addEventListener('pointermove', onMove, true);\n      window.addEventListener('pointerup', _onUp, true);\n    },\n    title: \"\\u62D6\\u52A8\\u8C03\\u6574\\u5730\\u56FE\\u9AD8\\u5EA6\"\n  }), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"section\", {\n    className: \"sheet paper\"\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"sheet-header\"\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"input\", {\n    className: \"plan-name\",\n    value: planName,\n    onChange: function onChange(e) {\n      return setPlanName(e.target.value);\n    },\n    placeholder: \"\\u8BA1\\u5212\\u540D\\u79F0\"\n  }), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"actions\",\n    style: {\n      display: 'flex',\n      gap: 8,\n      alignItems: 'center',\n      flexWrap: 'wrap'\n    }\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"btn\",\n    onClick: confirmNewPlan\n  }, \"\\u65B0\\u5EFA\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"btn\",\n    onClick: savePlan,\n    disabled: planSaving\n  }, planSaving ? '保存中…' : '保存'), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"btn\",\n    onClick: function onClick() {\n      return setShowSupplies(true);\n    }\n  }, \"\\u7269\\u8D44\\u6E05\\u5355\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"icon-btn\",\n    onClick: function onClick() {\n      return setShowActionMore(function (v) {\n        return !v;\n      });\n    },\n    \"aria-expanded\": showActionMore\n  }, showActionMore ? '收起' : '更多'), showActionMore && /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(react__WEBPACK_IMPORTED_MODULE_6__.Fragment, null, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"btn danger\",\n    onClick: confirmDeletePlan,\n    disabled: planDeleting\n  }, planDeleting ? '删除中…' : '删除'), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"btn\",\n    onClick: function onClick() {\n      return exportTxtWithDistances(planName, items, finalDistances);\n    }\n  }, \"\\u5BFC\\u51FATXT\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"btn\",\n    onClick: function onClick() {\n      return exportMarkdown(planName, dayGroups, finalDistances);\n    }\n  }, \"\\u5BFC\\u51FAMD\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"btn\",\n    onClick: function onClick() {\n      return exportCSV(planName, items, finalDistances);\n    }\n  }, \"\\u5BFC\\u51FACSV\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"btn\",\n    onClick: function onClick() {\n      return exportNarrative(planName, items);\n    }\n  }, \"\\u5BFC\\u51FA\\u884C\\u7A0B\\u6587\\u6848\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"btn\",\n    onClick: function onClick() {\n      return setShowImport(true);\n    }\n  }, \"\\u4ECE\\u6587\\u672C\\u5BFC\\u5165(Beta)\")))), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"plans-bar\",\n    style: {\n      display: 'flex',\n      gap: 8,\n      alignItems: 'center'\n    }\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"btn\",\n    onClick: loadPlans,\n    disabled: travelPlansLoading\n  }, travelPlansLoading ? '加载中…' : '刷新计划'), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"select\", {\n    className: \"plan-select\",\n    onChange: function onChange(e) {\n      return loadPlanDetail(e.target.value);\n    },\n    value: planId || ''\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n    value: \"\",\n    disabled: true\n  }, \"\\u9009\\u62E9\\u5DF2\\u6709\\u8BA1\\u5212\"), (travelPlans || []).map(function (p) {\n    return /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n      key: p.id,\n      value: p.id\n    }, p.name);\n  })), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    style: {\n      marginLeft: 'auto',\n      display: 'flex',\n      gap: 8\n    }\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"btn\",\n    disabled: fillGeoBusy,\n    onClick: /*#__PURE__*/(0,_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_4__[\"default\"])(/*#__PURE__*/_regenerator().m(function _callee14() {\n      var _loop3, i;\n      return _regenerator().w(function (_context16) {\n        while (1) switch (_context16.p = _context16.n) {\n          case 0:\n            setFillGeoBusy(true);\n            setFillProgress({\n              done: 0,\n              total: items.length\n            });\n            _context16.p = 1;\n            _loop3 = /*#__PURE__*/_regenerator().m(function _loop3() {\n              var it, info, _t19;\n              return _regenerator().w(function (_context15) {\n                while (1) switch (_context15.p = _context15.n) {\n                  case 0:\n                    it = items[i];\n                    if (!(it && (!it.city || !it.province || !it.nameLocal))) {\n                      _context15.n = 5;\n                      break;\n                    }\n                    _context15.p = 1;\n                    _context15.n = 2;\n                    return reverseGeocodeMultiDetailed(it.lat, it.lng);\n                  case 2:\n                    info = _context15.v;\n                    setItems(function (prev) {\n                      return prev.map(function (p) {\n                        return p.id === it.id ? _objectSpread(_objectSpread({}, p), {}, {\n                          name: info.cn || p.name,\n                          nameLocal: info.local || p.nameLocal || '',\n                          city: info.city || p.city || '',\n                          province: info.province || p.province || '',\n                          country: info.country || p.country || ''\n                        }) : p;\n                      });\n                    });\n                    _context15.n = 4;\n                    break;\n                  case 3:\n                    _context15.p = 3;\n                    _t19 = _context15.v;\n                  case 4:\n                    _context15.n = 5;\n                    return new Promise(function (r) {\n                      return setTimeout(r, 380);\n                    });\n                  case 5:\n                    setFillProgress({\n                      done: i + 1,\n                      total: items.length\n                    });\n                  case 6:\n                    return _context15.a(2);\n                }\n              }, _loop3, null, [[1, 3]]);\n            });\n            i = 0;\n          case 2:\n            if (!(i < items.length)) {\n              _context16.n = 4;\n              break;\n            }\n            return _context16.d(_regeneratorValues(_loop3()), 3);\n          case 3:\n            i++;\n            _context16.n = 2;\n            break;\n          case 4:\n            _context16.p = 4;\n            setFillGeoBusy(false);\n            return _context16.f(4);\n          case 5:\n            return _context16.a(2);\n        }\n      }, _callee14, null, [[1,, 4, 5]]);\n    }))\n  }, fillGeoBusy ? \"\\u8865\\u5168\\u4E2D \".concat(fillProgress.done, \"/\").concat(fillProgress.total) : '一键补全地名'))), showExtra && /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"plans-bar\"\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    style: {\n      display: 'flex',\n      gap: 8,\n      flexWrap: 'wrap',\n      width: '100%'\n    }\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    style: {\n      display: 'flex',\n      alignItems: 'center',\n      gap: 6\n    }\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"span\", {\n    style: {\n      color: '#6b7280'\n    }\n  }, \"\\u5730\\u56FE\\u9AD8\\u5EA6\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"input\", {\n    type: \"range\",\n    min: 200,\n    max: Math.round(window.innerHeight * 0.8),\n    value: mapHeight,\n    onChange: function onChange(e) {\n      return setMapHeight(parseInt(e.target.value || '0', 10) || mapHeight);\n    }\n  }), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"span\", {\n    style: {\n      minWidth: 36,\n      textAlign: 'right'\n    }\n  }, Math.round(mapHeight), \"px\")), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    style: {\n      marginLeft: 'auto'\n    }\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"icon-btn \".concat(useMapBounds ? 'active' : ''),\n    title: \"\\u5C31\\u8FD1\\u4F18\\u5148\\uFF08\\u6309\\u5F53\\u524D\\u5730\\u56FE\\u8303\\u56F4\\u641C\\u7D22\\uFF09\",\n    onClick: function onClick() {\n      return setUseMapBounds(function (v) {\n        return !v;\n      });\n    }\n  }, useMapBounds ? '就近' : '全局'), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"icon-btn \".concat(useRouteDistance ? 'active' : ''),\n    onClick: function onClick() {\n      return setUseRouteDistance(function (v) {\n        return !v;\n      });\n    },\n    title: \"\\u8DEF\\u7EBF\\u578B\\u8DDD\\u79BB\\uFF08OSRM\\uFF09\"\n  }, \"\\u8DEF\\u7EBF\\u8DDD\\u79BB\")))), error ? /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"error\"\n  }, error) : null, travelPlansError ? /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"error\"\n  }, travelPlansError) : null, currentPlanError ? /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"error\"\n  }, currentPlanError) : null, planSaveError ? /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"error\"\n  }, planSaveError) : null, planDeleteError ? /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"error\"\n  }, planDeleteError) : null, viewMode === 'list' ? /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"ul\", {\n    className: \"item-list\"\n  }, items.map(function (it, idx) {\n    return /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"li\", {\n      className: \"item\",\n      key: it.id,\n      draggable: true,\n      onDragStart: function onDragStart() {\n        return setDragIndex(idx);\n      },\n      onDragOver: function onDragOver(e) {\n        return e.preventDefault();\n      },\n      onDrop: function onDrop() {\n        reorder(dragIndex, idx);\n        setDragIndex(null);\n      }\n    }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      className: \"item-line\"\n    }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      className: \"index\"\n    }, idx + 1), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n      className: \"icon-btn\",\n      title: it.fav ? '取消收藏' : '收藏',\n      onClick: function onClick() {\n        return updateItemField(it.id, 'fav', !it.fav);\n      }\n    }, it.fav ? '★' : '☆'), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"input\", {\n      className: \"item-name\",\n      value: it.name,\n      onChange: function onChange(e) {\n        return updateItemField(it.id, 'name', e.target.value);\n      },\n      placeholder: \"\\u5730\\u70B9\\u540D\\u79F0/\\u5907\\u6CE8\"\n    }), it.nameLocal && /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"span\", {\n      style: {\n        color: '#6b7280',\n        fontSize: 12,\n        marginLeft: 6\n      }\n    }, \"(\", it.nameLocal, \")\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"select\", {\n      className: \"icon-btn\",\n      onChange: function onChange(e) {\n        return applyNoteTemplate(it.id, e.target.value);\n      },\n      defaultValue: \"\"\n    }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n      value: \"\",\n      disabled: true\n    }, \"\\u5907\\u6CE8\\u6A21\\u677F\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n      value: \"play\"\n    }, \"\\u6E38\\u73A9\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n      value: \"move\"\n    }, \"\\u79FB\\u52A8\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n      value: \"stay\"\n    }, \"\\u4F4F\\u5BBF\")), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"select\", {\n      className: \"icon-btn\",\n      onChange: function onChange(e) {\n        var val = e.target.value;\n        if (!val) return;\n        applyDuration(it.id, val);\n        e.target.value = '';\n      },\n      defaultValue: \"\"\n    }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n      value: \"\",\n      disabled: true\n    }, \"\\u9884\\u8BA1\\u65F6\\u957F\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n      value: \"30\\u5206\\u949F\"\n    }, \"30\\u5206\\u949F\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n      value: \"1\\u5C0F\\u65F6\"\n    }, \"1\\u5C0F\\u65F6\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n      value: \"2\\u5C0F\\u65F6\"\n    }, \"2\\u5C0F\\u65F6\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n      value: \"\\u534A\\u5929\"\n    }, \"\\u534A\\u5929\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n      value: \"\\u5168\\u5929\"\n    }, \"\\u5168\\u5929\")), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      className: \"move\"\n    }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n      className: \"icon-btn\",\n      onClick: function onClick() {\n        return moveItem(idx, -1);\n      },\n      disabled: idx === 0\n    }, \"\\u2191\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n      className: \"icon-btn\",\n      onClick: function onClick() {\n        return moveItem(idx, +1);\n      },\n      disabled: idx === items.length - 1\n    }, \"\\u2193\")), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n      className: \"icon-btn danger\",\n      onClick: function onClick() {\n        return confirmDeleteItem(it.id);\n      }\n    }, \"\\u2715\")), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      className: \"item-line\"\n    }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"input\", {\n      type: \"date\",\n      className: \"date-input\",\n      value: it.date || '',\n      onChange: function onChange(e) {\n        return updateItemField(it.id, 'date', e.target.value);\n      }\n    }), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"input\", {\n      type: \"time\",\n      className: \"time-input\",\n      value: it.time || '',\n      onChange: function onChange(e) {\n        return updateItemField(it.id, 'time', e.target.value);\n      }\n    }), it.unlocated ? /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      className: \"coords\",\n      style: {\n        color: '#ef4444'\n      }\n    }, \"\\u672A\\u5B9A\\u4F4D\", /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n      className: \"icon-btn\",\n      style: {\n        marginLeft: 8\n      },\n      onClick: function onClick() {\n        placingRef.current = it.id;\n        alert('请在地图上点选一个位置，来放置：' + (it.name || '此条目'));\n      }\n    }, \"\\u5728\\u5730\\u56FE\\u4E0A\\u653E\\u7F6E\")) : /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      className: \"coords\"\n    }, isFinite(it.lat) && isFinite(it.lng) ? \"\".concat(it.lat.toFixed(5), \", \").concat(it.lng.toFixed(5)) : '', finalDistances[idx] ? \" \\xB7 \\u8DDD\\u4E0A\\u4E2A \".concat(finalDistances[idx].toFixed(1), \" km \\xB7 \\u5EFA\\u8BAE\\uFF1A\").concat(recommendTransport(finalDistances[idx], items[idx - 1], it)) : '')), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"textarea\", (0,_babel_runtime_helpers_extends__WEBPACK_IMPORTED_MODULE_1__[\"default\"])({\n      className: \"notes\",\n      rows: 2,\n      value: it.notes || '',\n      onChange: function onChange(e) {\n        return updateItemField(it.id, 'notes', e.target.value);\n      },\n      placeholder: \"\\u5907\\u6CE8\"\n    }, bindLongPress(it.id))));\n  })) : viewMode === 'timeline' ? /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"timeline\"\n  }, timelineItems.map(function (it, idx) {\n    return /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      key: it.id,\n      className: \"timeline-item\",\n      draggable: true,\n      onDragStart: function onDragStart() {\n        return setTimelineDragIndex(idx);\n      },\n      onDragOver: function onDragOver(e) {\n        return e.preventDefault();\n      },\n      onDrop: function onDrop() {\n        if (timelineDragIndex == null) return;\n        setItems(function (prev) {\n          var currentTimeline = sortItemsForTimeline(prev);\n          var ids = currentTimeline.map(function (x) {\n            return x.id;\n          });\n          var from = timelineDragIndex;\n          var to = idx;\n          if (from < 0 || from >= ids.length || to < 0 || to >= ids.length) return prev;\n          var _ids$splice = ids.splice(from, 1),\n            _ids$splice2 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_ids$splice, 1),\n            movedId = _ids$splice2[0];\n          ids.splice(to, 0, movedId);\n          var idToItem = new Map(prev.map(function (p) {\n            return [p.id, p];\n          }));\n          var next = ids.map(function (id) {\n            return idToItem.get(id);\n          }).filter(Boolean);\n          return next;\n        });\n        setTimelineManualOrder(true);\n        setTimelineDragIndex(null);\n      }\n    }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      className: \"timeline-left\"\n    }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      className: \"timeline-dot\"\n    }), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      className: \"timeline-line\"\n    })), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      className: \"timeline-content\"\n    }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      className: \"timeline-title\"\n    }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"span\", {\n      className: \"index\"\n    }, idx + 1), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"input\", {\n      className: \"item-name\",\n      value: it.name,\n      onChange: function onChange(e) {\n        return updateItemField(it.id, 'name', e.target.value);\n      }\n    }), it.nameLocal && /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"span\", {\n      style: {\n        color: '#6b7280',\n        fontSize: 12,\n        marginLeft: 6\n      }\n    }, \"(\", it.nameLocal, \")\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      className: \"move\"\n    }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n      className: \"icon-btn\",\n      onClick: function onClick() {\n        setItems(function (prev) {\n          var currentTimeline = sortItemsForTimeline(prev);\n          var ids = currentTimeline.map(function (x) {\n            return x.id;\n          });\n          var from = idx;\n          var to = idx - 1;\n          if (from <= 0) return prev;\n          var _ids$splice3 = ids.splice(from, 1),\n            _ids$splice4 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_ids$splice3, 1),\n            movedId = _ids$splice4[0];\n          ids.splice(to, 0, movedId);\n          var idToItem = new Map(prev.map(function (p) {\n            return [p.id, p];\n          }));\n          var next = ids.map(function (id) {\n            return idToItem.get(id);\n          }).filter(Boolean);\n          return next;\n        });\n        setTimelineManualOrder(true);\n      },\n      disabled: idx === 0\n    }, \"\\u2191\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n      className: \"icon-btn\",\n      onClick: function onClick() {\n        setItems(function (prev) {\n          var currentTimeline = sortItemsForTimeline(prev);\n          var ids = currentTimeline.map(function (x) {\n            return x.id;\n          });\n          var from = idx;\n          var to = idx + 1;\n          if (from >= ids.length - 1) return prev;\n          var _ids$splice5 = ids.splice(from, 1),\n            _ids$splice6 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_ids$splice5, 1),\n            movedId = _ids$splice6[0];\n          ids.splice(to, 0, movedId);\n          var idToItem = new Map(prev.map(function (p) {\n            return [p.id, p];\n          }));\n          var next = ids.map(function (id) {\n            return idToItem.get(id);\n          }).filter(Boolean);\n          return next;\n        });\n        setTimelineManualOrder(true);\n      },\n      disabled: idx === timelineItems.length - 1\n    }, \"\\u2193\")), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n      className: \"icon-btn danger\",\n      onClick: function onClick() {\n        return confirmDeleteItem(it.id);\n      }\n    }, \"\\u2715\")), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      className: \"timeline-meta\"\n    }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"input\", {\n      type: \"date\",\n      className: \"date-input\",\n      value: it.date || '',\n      onChange: function onChange(e) {\n        return updateItemField(it.id, 'date', e.target.value);\n      }\n    }), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"input\", {\n      type: \"time\",\n      className: \"time-input\",\n      value: it.time || '',\n      onChange: function onChange(e) {\n        return updateItemField(it.id, 'time', e.target.value);\n      }\n    }), it.unlocated ? /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"span\", {\n      className: \"coords\",\n      style: {\n        color: '#ef4444'\n      }\n    }, \"\\u672A\\u5B9A\\u4F4D\", /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n      className: \"icon-btn\",\n      style: {\n        marginLeft: 8\n      },\n      onClick: function onClick() {\n        placingRef.current = it.id;\n        alert('请在地图上点选一个位置，来放置：' + (it.name || '此条目'));\n      }\n    }, \"\\u5728\\u5730\\u56FE\\u4E0A\\u653E\\u7F6E\")) : /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"span\", {\n      className: \"coords\"\n    }, isFinite(it.lat) && isFinite(it.lng) ? \"\".concat(it.lat.toFixed(5), \", \").concat(it.lng.toFixed(5)) : '', finalDistances[items.indexOf(it)] ? \" \\xB7 \\u8DDD\\u4E0A\\u4E2A \".concat(finalDistances[items.indexOf(it)].toFixed(1), \" km \\xB7 \\u5EFA\\u8BAE\\uFF1A\").concat(recommendTransport(finalDistances[items.indexOf(it)], items[items.indexOf(it) - 1], it)) : '')), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"textarea\", (0,_babel_runtime_helpers_extends__WEBPACK_IMPORTED_MODULE_1__[\"default\"])({\n      className: \"notes\",\n      rows: 2,\n      value: it.notes || '',\n      onChange: function onChange(e) {\n        return updateItemField(it.id, 'notes', e.target.value);\n      },\n      placeholder: \"\\u5907\\u6CE8\"\n    }, bindLongPress(it.id)))));\n  })) : /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"day-groups\"\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"day-picker\"\n  }, dayGroups.map(function (g) {\n    var today = getNowDateTime().date;\n    var isToday = g.day === today;\n    var hasFav = g.entries.some(function (_ref17) {\n      var item = _ref17.item;\n      return !!item.fav;\n    });\n    return /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n      key: g.day,\n      className: \"day-chip \".concat(isToday ? 'today' : '', \" \").concat(hasFav ? 'hasFav' : ''),\n      onClick: function onClick() {\n        var el = document.getElementById('day-' + g.day);\n        if (el) el.scrollIntoView({\n          behavior: 'smooth',\n          block: 'start',\n          inline: 'nearest'\n        });\n      },\n      onMouseDown: function onMouseDown() {\n        if (chipLpTimerRef.current) clearTimeout(chipLpTimerRef.current);\n        chipLpTimerRef.current = setTimeout(function () {\n          return addQuickDayNote(g.day);\n        }, 600);\n      },\n      onMouseUp: function onMouseUp() {\n        if (chipLpTimerRef.current) clearTimeout(chipLpTimerRef.current);\n      },\n      onMouseLeave: function onMouseLeave() {\n        if (chipLpTimerRef.current) clearTimeout(chipLpTimerRef.current);\n      },\n      onTouchStart: function onTouchStart() {\n        if (chipLpTimerRef.current) clearTimeout(chipLpTimerRef.current);\n        chipLpTimerRef.current = setTimeout(function () {\n          return addQuickDayNote(g.day);\n        }, 600);\n      },\n      onTouchEnd: function onTouchEnd() {\n        if (chipLpTimerRef.current) clearTimeout(chipLpTimerRef.current);\n      },\n      onTouchMove: function onTouchMove() {\n        if (chipLpTimerRef.current) clearTimeout(chipLpTimerRef.current);\n      }\n    }, g.day, hasFav ? /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"span\", {\n      className: \"badge\",\n      \"aria-hidden\": \"true\"\n    }) : null);\n  })), dayGroups.map(function (group) {\n    return /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      key: group.day,\n      className: \"day-section\",\n      id: 'day-' + group.day\n    }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      className: \"item-line\",\n      style: {\n        fontWeight: 600\n      }\n    }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      className: \"index\"\n    }, group.day), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      style: {\n        marginLeft: 8\n      }\n    }, \"\\u5F53\\u5929\\u603B\\u8DDD\\u79BB\\uFF1A\", group.totalKm.toFixed(1), \" km\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      style: {\n        marginLeft: 'auto'\n      }\n    }, \"\\u8D77\\u6B62\\uFF1A\", group.start || '-', group.end ? ' - ' + group.end : ''), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      style: {\n        marginLeft: 12,\n        display: 'flex',\n        gap: 6\n      }\n    }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n      className: \"icon-btn\",\n      onClick: function onClick() {\n        return exportDayGeoJSON(group.day);\n      }\n    }, \"\\u5BFC\\u51FAGeoJSON\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n      className: \"icon-btn\",\n      onClick: function onClick() {\n        return exportDayGPX(group.day);\n      }\n    }, \"\\u5BFC\\u51FAGPX\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n      className: \"icon-btn\",\n      onClick: function onClick() {\n        return exportDayPNG(group.day);\n      }\n    }, \"\\u5BFC\\u51FA\\u56FE\\u7247\"))), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"ul\", {\n      className: \"item-list\"\n    }, group.entries.map(function (_ref18) {\n      var item = _ref18.item,\n        index = _ref18.index;\n      return /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"li\", {\n        className: \"item\",\n        key: item.id,\n        draggable: true,\n        onDragStart: function onDragStart() {\n          return setDragIndex(index);\n        },\n        onDragOver: function onDragOver(e) {\n          return e.preventDefault();\n        },\n        onDrop: function onDrop() {\n          reorder(dragIndex, index);\n          setDragIndex(null);\n        }\n      }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n        className: \"item-line\"\n      }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n        className: \"index\"\n      }, index + 1, item.startOfDay ? ' · 起点' : '', item.endOfDay ? ' · 终点' : ''), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"input\", {\n        className: \"item-name\",\n        value: item.name,\n        onChange: function onChange(e) {\n          return updateItemField(item.id, 'name', e.target.value);\n        },\n        placeholder: \"\\u5730\\u70B9\\u540D\\u79F0/\\u5907\\u6CE8\"\n      }), item.nameLocal && /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"span\", {\n        style: {\n          color: '#6b7280',\n          fontSize: 12,\n          marginLeft: 6\n        }\n      }, \"(\", item.nameLocal, \")\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n        className: \"icon-btn\",\n        onClick: function onClick() {\n          return setStartOfDay(group.day, item.id);\n        }\n      }, \"\\u8BBE\\u4E3A\\u8D77\\u70B9\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n        className: \"icon-btn\",\n        onClick: function onClick() {\n          return setEndOfDay(group.day, item.id);\n        }\n      }, \"\\u8BBE\\u4E3A\\u7EC8\\u70B9\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"select\", {\n        className: \"icon-btn\",\n        onChange: function onChange(e) {\n          return applyNoteTemplate(item.id, e.target.value);\n        },\n        defaultValue: \"\"\n      }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n        value: \"\",\n        disabled: true\n      }, \"\\u5907\\u6CE8\\u6A21\\u677F\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n        value: \"play\"\n      }, \"\\u6E38\\u73A9\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n        value: \"move\"\n      }, \"\\u79FB\\u52A8\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n        value: \"stay\"\n      }, \"\\u4F4F\\u5BBF\")), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"select\", {\n        className: \"icon-btn\",\n        onChange: function onChange(e) {\n          var val = e.target.value;\n          if (!val) return;\n          applyDuration(item.id, val);\n          e.target.value = '';\n        },\n        defaultValue: \"\"\n      }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n        value: \"\",\n        disabled: true\n      }, \"\\u9884\\u8BA1\\u65F6\\u957F\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n        value: \"30\\u5206\\u949F\"\n      }, \"30\\u5206\\u949F\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n        value: \"1\\u5C0F\\u65F6\"\n      }, \"1\\u5C0F\\u65F6\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n        value: \"2\\u5C0F\\u65F6\"\n      }, \"2\\u5C0F\\u65F6\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n        value: \"\\u534A\\u5929\"\n      }, \"\\u534A\\u5929\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n        value: \"\\u5168\\u5929\"\n      }, \"\\u5168\\u5929\")), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n        className: \"icon-btn danger\",\n        onClick: function onClick() {\n          return confirmDeleteItem(item.id);\n        }\n      }, \"\\u2715\")), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n        className: \"item-line\"\n      }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"input\", {\n        type: \"date\",\n        className: \"date-input\",\n        value: item.date || '',\n        onChange: function onChange(e) {\n          return updateItemField(item.id, 'date', e.target.value);\n        }\n      }), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"input\", {\n        type: \"time\",\n        className: \"time-input\",\n        value: item.time || '',\n        onChange: function onChange(e) {\n          return updateItemField(item.id, 'time', e.target.value);\n        }\n      }), item.unlocated ? /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n        className: \"coords\",\n        style: {\n          color: '#ef4444'\n        }\n      }, \"\\u672A\\u5B9A\\u4F4D\", /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n        className: \"icon-btn\",\n        style: {\n          marginLeft: 8\n        },\n        onClick: function onClick() {\n          placingRef.current = item.id;\n          alert('请在地图上点选一个位置，来放置：' + (item.name || '此条目'));\n        }\n      }, \"\\u5728\\u5730\\u56FE\\u4E0A\\u653E\\u7F6E\")) : /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n        className: \"coords\"\n      }, isFinite(item.lat) && isFinite(item.lng) ? \"\".concat(item.lat.toFixed(5), \", \").concat(item.lng.toFixed(5)) : '', finalDistances[index] ? \" \\xB7 \\u8DDD\\u4E0A\\u4E2A \".concat(finalDistances[index].toFixed(1), \" km \\xB7 \\u5EFA\\u8BAE\\uFF1A\").concat(recommendTransport(finalDistances[index], items[index - 1], item)) : '')), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"textarea\", (0,_babel_runtime_helpers_extends__WEBPACK_IMPORTED_MODULE_1__[\"default\"])({\n        className: \"notes\",\n        rows: 2,\n        value: item.notes || '',\n        onChange: function onChange(e) {\n          return updateItemField(item.id, 'notes', e.target.value);\n        },\n        placeholder: \"\\u5907\\u6CE8\"\n      }, bindLongPress(item.id))));\n    })));\n  })), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"stats-bar\"\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", null, \"\\u603B\\u8DDD\\u79BB\\uFF1A\", distanceStatsFinal.total.toFixed(1), \" km\"), Object.keys(distanceStatsFinal.perDay).length > 0 && /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"stats-days\"\n  }, Object.entries(distanceStatsFinal.perDay).map(function (_ref19) {\n    var _ref20 = (0,_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_5__[\"default\"])(_ref19, 2),\n      d = _ref20[0],\n      val = _ref20[1];\n    return /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"span\", {\n      key: d,\n      className: \"stats-day\"\n    }, d || '未设日期', \"\\uFF1A\", val.toFixed(1), \" km\");\n  })), osrmWarn && /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"warning-bar\"\n  }, osrmWarn))), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"style\", null, \".map-container{height:\".concat(mapHeight, \"px}\")), showSupplies && /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    style: {\n      position: 'fixed',\n      inset: 0,\n      background: 'rgba(0,0,0,.35)',\n      zIndex: 10000,\n      display: 'flex',\n      alignItems: 'center',\n      justifyContent: 'center'\n    },\n    onClick: function onClick() {\n      return setShowSupplies(false);\n    }\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"paper-card\",\n    style: {\n      width: 'min(720px,92vw)',\n      maxHeight: '80vh',\n      display: 'flex',\n      flexDirection: 'column'\n    },\n    onClick: function onClick(e) {\n      return e.stopPropagation();\n    }\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"paper-header\",\n    style: {\n      display: 'flex',\n      alignItems: 'center',\n      padding: '12px 14px'\n    }\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    style: {\n      fontWeight: 700,\n      letterSpacing: 1\n    }\n  }, \"\\u65C5\\u884C\\u5907\\u5FD8\\u5F55\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    style: {\n      marginLeft: 'auto',\n      display: 'flex',\n      gap: 8\n    }\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"select\", {\n    className: \"icon-btn\",\n    \"aria-label\": \"\\u6A21\\u677F\\u5E93\",\n    defaultValue: \"\",\n    onChange: function onChange(e) {\n      var v = e.target.value;\n      if (!v) return;\n      setSuppliesText(getSuppliesTemplate(v));\n      e.target.value = '';\n    }\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n    value: \"\",\n    disabled: true\n  }, \"\\u6A21\\u677F\\u5E93\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n    value: \"domestic\"\n  }, \"\\u56FD\\u5185\\u57CE\\u5E02\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n    value: \"abroad\"\n  }, \"\\u56FD\\u5916\\u51FA\\u884C\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n    value: \"hiking\"\n  }, \"\\u5F92\\u6B65/\\u767B\\u5C71\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n    value: \"camp\"\n  }, \"\\u9732\\u8425/\\u81EA\\u9A7E\")), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"select\", {\n    className: \"icon-btn\",\n    \"aria-label\": \"\\u6211\\u7684\\u6A21\\u677F\",\n    value: selectedTplName,\n    onChange: function onChange(e) {\n      return setSelectedTplName(e.target.value);\n    },\n    style: {\n      minWidth: 120\n    }\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n    value: \"\"\n  }, \"\\u6211\\u7684\\u6A21\\u677F\"), myTemplates.map(function (t) {\n    return /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"option\", {\n      key: t.name,\n      value: t.name\n    }, t.name);\n  })), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"icon-btn\",\n    disabled: !selectedTplName,\n    onClick: function onClick() {\n      var t = myTemplates.find(function (x) {\n        return x.name === selectedTplName;\n      });\n      if (t) setSuppliesText(t.text || '');\n    }\n  }, \"\\u5E94\\u7528\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"icon-btn\",\n    onClick: saveSuppliesAsTemplate\n  }, \"\\u4FDD\\u5B58\\u4E3A\\u6A21\\u677F\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"icon-btn danger\",\n    disabled: !selectedTplName,\n    onClick: deleteSelectedTemplate\n  }, \"\\u5220\\u9664\\u6A21\\u677F\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"icon-btn\",\n    onClick: function onClick() {\n      setSuppliesText(defaultSuppliesTemplate());\n    }\n  }, \"\\u57FA\\u7840\\u6A21\\u677F\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"icon-btn\",\n    onClick: function onClick() {\n      return setShowSupplies(false);\n    }\n  }, \"\\u5173\\u95ED\"))), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"textarea\", {\n    style: {\n      flex: 1,\n      minHeight: 240,\n      border: 'none',\n      outline: 'none',\n      padding: 14,\n      background: 'transparent',\n      fontFamily: '\"Courier New\", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas',\n      lineHeight: '1.6'\n    },\n    value: suppliesText,\n    onChange: function onChange(e) {\n      return setSuppliesText(e.target.value);\n    },\n    placeholder: '出行备忘示例:\\n- 证件：身份证/护照/签证\\n- 电子：手机/充电宝/充电器/数据线\\n- 衣物：外套/换洗衣物/雨具\\n- 洗护：牙刷牙膏/洗面奶/毛巾\\n- 药品：感冒药/肠胃药/创可贴\\n- 其他：水杯/太阳镜/防晒/伞'\n  }))), showImport && /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    style: {\n      position: 'fixed',\n      inset: 0,\n      background: 'rgba(0,0,0,.35)',\n      zIndex: 10000,\n      display: 'flex',\n      alignItems: 'center',\n      justifyContent: 'center'\n    },\n    onClick: function onClick() {\n      return setShowImport(false);\n    }\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"paper-card\",\n    style: {\n      width: 'min(860px,94vw)',\n      maxHeight: '84vh',\n      display: 'flex',\n      flexDirection: 'column'\n    },\n    onClick: function onClick(e) {\n      return e.stopPropagation();\n    }\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"paper-header\",\n    style: {\n      display: 'flex',\n      alignItems: 'center',\n      gap: 10,\n      padding: '12px 14px'\n    }\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    style: {\n      fontWeight: 700\n    }\n  }, \"\\u4ECE\\u6587\\u672C\\u5BFC\\u5165\\uFF08Beta\\uFF09\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    style: {\n      marginLeft: 'auto',\n      display: 'flex',\n      gap: 8,\n      alignItems: 'center'\n    }\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"label\", {\n    style: {\n      color: '#6b7280'\n    }\n  }, \"Day1\\u65E5\\u671F\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"input\", {\n    type: \"date\",\n    value: importDay1Date,\n    onChange: function onChange(e) {\n      return setImportDay1Date(e.target.value);\n    }\n  }), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"icon-btn\",\n    disabled: importParsing || !importText.trim(),\n    onClick: /*#__PURE__*/(0,_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_4__[\"default\"])(/*#__PURE__*/_regenerator().m(function _callee16() {\n      var parsed, baseDate, dayIndex, entries, tasks;\n      return _regenerator().w(function (_context18) {\n        while (1) switch (_context18.p = _context18.n) {\n          case 0:\n            setImportParsing(true);\n            _context18.p = 1;\n            // 使用中文行程解析器\n            parsed = parseChineseItinerary(importText); // 如果用户选择了 Day1 日期，则填充 dateStr，否则留空，后续导入时按 Day 偏移\n            baseDate = importDay1Date || '';\n            dayIndex = 0;\n            entries = parsed.map(function (e) {\n              if (!e.dateStr && baseDate) {\n                var dt = new Date(baseDate.replace(/-/g, '/'));\n                var tag = \"D\".concat(dayIndex + 1);\n                dayIndex++;\n                return _objectSpread(_objectSpread({}, e), {}, {\n                  dayIndex: dayIndex - 1,\n                  dateStr: '',\n                  tag: tag\n                });\n              } else {\n                return _objectSpread(_objectSpread({}, e), {}, {\n                  dayIndex: 0\n                });\n              }\n            });\n            setImportPreview(entries.map(function (e) {\n              return {\n                name: e.name,\n                time: e.time || '',\n                notes: e.notes || '',\n                dayIndex: e.dayIndex || 0,\n                _type: e._type || 'poi',\n                candidates: [],\n                selectedIdx: -1\n              };\n            }));\n            setImportGeocoding(true);\n            tasks = entries.map(/*#__PURE__*/function () {\n              var _ref22 = (0,_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_4__[\"default\"])(/*#__PURE__*/_regenerator().m(function _callee15(e, idx) {\n                var q, found, localized, _iterator5, _step5, c, label, info, _t20, _t21, _t22;\n                return _regenerator().w(function (_context17) {\n                  while (1) switch (_context17.p = _context17.n) {\n                    case 0:\n                      _context17.p = 0;\n                      if (!((e._type || 'poi') === 'timeEvent')) {\n                        _context17.n = 1;\n                        break;\n                      }\n                      return _context17.a(2);\n                    case 1:\n                      // 时间事件不做地理编码\n                      q = sanitizePlaceName(e.name || '');\n                      if (q) {\n                        _context17.n = 2;\n                        break;\n                      }\n                      return _context17.a(2);\n                    case 2:\n                      _context17.n = 3;\n                      return searchPlaces(q);\n                    case 3:\n                      found = _context17.v;\n                      localized = [];\n                      _iterator5 = _createForOfIteratorHelper(found);\n                      _context17.p = 4;\n                      _iterator5.s();\n                    case 5:\n                      if ((_step5 = _iterator5.n()).done) {\n                        _context17.n = 11;\n                        break;\n                      }\n                      c = _step5.value;\n                      label = c.display_name || '';\n                      _context17.p = 6;\n                      _context17.n = 7;\n                      return reverseGeocodeMultiDetailed(parseFloat(c.lat), parseFloat(c.lon));\n                    case 7:\n                      info = _context17.v;\n                      label = info.cn || label;\n                      _context17.n = 9;\n                      break;\n                    case 8:\n                      _context17.p = 8;\n                      _t20 = _context17.v;\n                    case 9:\n                      localized.push(_objectSpread(_objectSpread({}, c), {}, {\n                        display_name: label\n                      }));\n                    case 10:\n                      _context17.n = 5;\n                      break;\n                    case 11:\n                      _context17.n = 13;\n                      break;\n                    case 12:\n                      _context17.p = 12;\n                      _t21 = _context17.v;\n                      _iterator5.e(_t21);\n                    case 13:\n                      _context17.p = 13;\n                      _iterator5.f();\n                      return _context17.f(13);\n                    case 14:\n                      setImportPreview(function (prev) {\n                        var next = prev.slice();\n                        if (next[idx]) next[idx] = _objectSpread(_objectSpread({}, next[idx]), {}, {\n                          candidates: localized,\n                          selectedIdx: localized.length ? 0 : -1\n                        });\n                        return next;\n                      });\n                      _context17.n = 16;\n                      break;\n                    case 15:\n                      _context17.p = 15;\n                      _t22 = _context17.v;\n                    case 16:\n                      return _context17.a(2);\n                  }\n                }, _callee15, null, [[6, 8], [4, 12, 13, 14], [0, 15]]);\n              }));\n              return function (_x19, _x20) {\n                return _ref22.apply(this, arguments);\n              };\n            }());\n            _context18.n = 2;\n            return Promise.allSettled(tasks);\n          case 2:\n            _context18.p = 2;\n            setImportParsing(false);\n            setImportGeocoding(false);\n            return _context18.f(2);\n          case 3:\n            return _context18.a(2);\n        }\n      }, _callee16, null, [[1,, 2, 3]]);\n    }))\n  }, \"\\u89E3\\u6790\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"icon-btn\",\n    disabled: !importPreview.length || importGeocoding,\n    onClick: /*#__PURE__*/(0,_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_4__[\"default\"])(/*#__PURE__*/_regenerator().m(function _callee17() {\n      var baseDate, addDays, toAdd, _iterator6, _step6, e, date, c, item, center, _item, newName;\n      return _regenerator().w(function (_context19) {\n        while (1) switch (_context19.n) {\n          case 0:\n            // 将已选择/或第一个候选转为条目；对没有候选的 POI 也导入为“未定位”，方便稍后在地图上放置\n            baseDate = importDay1Date || getNowDateTime().date;\n            addDays = function addDays(d, k) {\n              var dt = new Date(d.replace(/-/g, '/'));\n              dt.setDate(dt.getDate() + k);\n              var p = function p(n) {\n                return n < 10 ? '0' + n : String(n);\n              };\n              return \"\".concat(dt.getFullYear(), \"-\").concat(p(dt.getMonth() + 1), \"-\").concat(p(dt.getDate()));\n            };\n            toAdd = [];\n            _iterator6 = _createForOfIteratorHelper(importPreview);\n            try {\n              for (_iterator6.s(); !(_step6 = _iterator6.n()).done;) {\n                e = _step6.value;\n                date = addDays(baseDate, e.dayIndex || 0);\n                c = e.candidates && e.candidates.length ? e.selectedIdx >= 0 ? e.candidates[e.selectedIdx] : e.candidates[0] : null;\n                if (c) {\n                  item = {\n                    id: uid(),\n                    placeId: String(c.place_id || ''),\n                    name: c.display_name || e.name || '未命名',\n                    nameLocal: '',\n                    city: '',\n                    province: '',\n                    country: '',\n                    lat: parseFloat(c.lat),\n                    lng: parseFloat(c.lon),\n                    date: date,\n                    time: e.time || '',\n                    notes: e.notes || ''\n                  };\n                  toAdd.push(item);\n                } else if ((e._type || 'poi') === 'poi' && e.name) {\n                  center = mapRef.current ? mapRef.current.getCenter() : {\n                    lat: DEFAULT_CENTER.lat,\n                    lng: DEFAULT_CENTER.lng\n                  };\n                  _item = {\n                    id: uid(),\n                    placeId: '',\n                    name: e.name,\n                    nameLocal: '',\n                    city: '',\n                    province: '',\n                    country: '',\n                    lat: center.lat,\n                    lng: center.lng,\n                    date: date,\n                    time: e.time || '',\n                    notes: (e.notes ? e.notes + \"\\n\" : \"\") + \"（未定位：请点击‘在地图上放置’）\",\n                    unlocated: true\n                  };\n                  toAdd.push(_item);\n                }\n              }\n            } catch (err) {\n              _iterator6.e(err);\n            } finally {\n              _iterator6.f();\n            }\n            if (toAdd.length) {\n              _context19.n = 1;\n              break;\n            }\n            alert('没有可导入的条目');\n            return _context19.a(2);\n          case 1:\n            _context19.n = 2;\n            return derivePlanName(importText, toAdd);\n          case 2:\n            newName = _context19.v;\n            setPlanId(null);\n            setPlanName(newName);\n            if (clusterGroupRef.current && clusterGroupRef.current.clearLayers) {\n              try {\n                clusterGroupRef.current.clearLayers();\n              } catch (_) {}\n            }\n            Object.values(markersRef.current).forEach(function (m) {\n              try {\n                m.remove();\n              } catch (_) {}\n            });\n            markersRef.current = {};\n            toAdd.filter(function (it) {\n              return !it.unlocated;\n            }).forEach(addMarkerForItem);\n            setItems(toAdd);\n            setShowImport(false);\n          case 3:\n            return _context19.a(2);\n        }\n      }, _callee17);\n    }))\n  }, \"\\u5BFC\\u5165\\u5230\\u884C\\u7A0B\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"button\", {\n    className: \"icon-btn\",\n    onClick: function onClick() {\n      return setShowImport(false);\n    }\n  }, \"\\u5173\\u95ED\"))), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    style: {\n      display: 'flex',\n      gap: 12,\n      padding: '10px 14px',\n      alignItems: 'stretch'\n    }\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"textarea\", {\n    style: {\n      flex: 1,\n      minHeight: 240,\n      border: 'none',\n      outline: 'none',\n      padding: 12,\n      background: 'transparent'\n    },\n    placeholder: '粘贴行程文本，如：\\nDay1：10:00 八一广场（游玩半小时）\\n11:00 江西省美术馆（半小时到1.5小时）\\n13:00 羊子街（午餐）\\n14:30 八一起义纪念馆（约2小时）...\\nDay2：...',\n    value: importText,\n    onChange: function onChange(e) {\n      return setImportText(e.target.value);\n    }\n  }), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    style: {\n      flex: 1,\n      overflow: 'auto',\n      maxHeight: '52vh'\n    }\n  }, !importPreview || importPreview.length === 0 ? /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    style: {\n      color: '#6b7280'\n    }\n  }, \"\\u89E3\\u6790\\u7ED3\\u679C\\u5C06\\u5728\\u6B64\\u663E\\u793A\\uFF1B\\u89E3\\u6790\\u540E\\u53EF\\u4EE5\\u4E3A\\u6BCF\\u4E00\\u6761\\u9009\\u62E9\\u5019\\u9009\\u5730\\u70B9\\u3002\") : /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", null, importPreview.map(function (e, idx) {\n    return /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      key: idx,\n      className: \"paper-card\",\n      style: {\n        padding: 10,\n        marginBottom: 8\n      }\n    }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      style: {\n        display: 'flex',\n        alignItems: 'center',\n        gap: 8\n      }\n    }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"span\", {\n      className: \"badge\",\n      \"aria-hidden\": \"true\"\n    }), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", null, \"Day\", (e.dayIndex || 0) + 1, \" \\xB7 \", e.time || '--:--', \" \\xB7 \", e.name)), e.notes ? /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      style: {\n        color: '#6b7280',\n        marginTop: 6\n      }\n    }, \"\\u5907\\u6CE8\\uFF1A\", e.notes) : null, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      style: {\n        marginTop: 8\n      }\n    }, !e.candidates || e.candidates.length === 0 ? e._type === 'timeEvent' || !e.name ? null : /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      style: {\n        color: '#ef4444'\n      }\n    }, \"\\u672A\\u627E\\u5230\\u5019\\u9009\\u5730\\u70B9\\uFF08\\u4E5F\\u53EF\\u76F4\\u63A5\\u5BFC\\u5165\\u4E3A\\u672A\\u5B9A\\u4F4D\\uFF0C\\u7A0D\\u540E\\u5230\\u5730\\u56FE\\u4E0A\\u653E\\u7F6E\\uFF09\") : /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", null, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n      style: {\n        color: '#6b7280',\n        marginBottom: 6\n      }\n    }, \"\\u5019\\u9009\\u5730\\u70B9\\uFF08\\u4F18\\u5148\\u663E\\u793A\\u4E2D\\u6587\\u540D\\u79F0\\uFF09\\uFF1A\"), e.candidates.map(function (c, i) {\n      return /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"label\", {\n        key: i,\n        style: {\n          display: 'flex',\n          gap: 8,\n          alignItems: 'flex-start',\n          marginBottom: 6\n        }\n      }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"input\", {\n        type: \"radio\",\n        name: 'cand-' + idx,\n        checked: e.selectedIdx === i,\n        onChange: function onChange() {\n          return setImportPreview(function (prev) {\n            var next = prev.slice();\n            next[idx].selectedIdx = i;\n            return next;\n          });\n        }\n      }), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", null, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n        style: {\n          fontWeight: 600\n        }\n      }, c.display_name), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n        style: {\n          color: '#6b7280',\n          fontSize: 12\n        }\n      }, \"(\", parseFloat(c.lat).toFixed(5), \", \", parseFloat(c.lon).toFixed(5), \")\")));\n    }))));\n  })))))), menu.show && /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    style: {\n      position: 'fixed',\n      inset: 0,\n      zIndex: 10001\n    },\n    onClick: closeContextMenu\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"context-menu paper-card\",\n    style: {\n      position: 'absolute',\n      left: Math.min(menu.x, window.innerWidth - 220),\n      top: Math.min(menu.y, window.innerHeight - 220),\n      width: 200,\n      padding: 8\n    },\n    onClick: function onClick(e) {\n      return e.stopPropagation();\n    }\n  }, /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"context-item\",\n    onClick: function onClick() {\n      var idx = items.findIndex(function (it) {\n        return it.id === menu.itemId;\n      });\n      if (idx > 0) moveItem(idx, -1);\n      closeContextMenu();\n    }\n  }, \"\\u4E0A\\u79FB\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"context-item\",\n    onClick: function onClick() {\n      var idx = items.findIndex(function (it) {\n        return it.id === menu.itemId;\n      });\n      if (idx >= 0 && idx < items.length - 1) moveItem(idx, +1);\n      closeContextMenu();\n    }\n  }, \"\\u4E0B\\u79FB\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"context-sep\"\n  }), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"context-item\",\n    onClick: function onClick() {\n      applyNoteTemplate(menu.itemId, 'play');\n      closeContextMenu();\n    }\n  }, \"\\u5907\\u6CE8\\xB7\\u6E38\\u73A9\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"context-item\",\n    onClick: function onClick() {\n      applyNoteTemplate(menu.itemId, 'move');\n      closeContextMenu();\n    }\n  }, \"\\u5907\\u6CE8\\xB7\\u79FB\\u52A8\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"context-item\",\n    onClick: function onClick() {\n      applyNoteTemplate(menu.itemId, 'stay');\n      closeContextMenu();\n    }\n  }, \"\\u5907\\u6CE8\\xB7\\u4F4F\\u5BBF\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"context-sep\"\n  }), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"context-item\",\n    onClick: function onClick() {\n      var it = items.find(function (x) {\n        return x.id === menu.itemId;\n      });\n      if (!it) return;\n      updateItemField(menu.itemId, 'fav', !it.fav);\n      closeContextMenu();\n    }\n  }, function () {\n    var it = items.find(function (x) {\n      return x.id === menu.itemId;\n    });\n    return it && it.fav ? '取消收藏' : '设为收藏';\n  }()), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"context-item danger\",\n    onClick: function onClick() {\n      confirmDeleteItem(menu.itemId);\n      closeContextMenu();\n    }\n  }, \"\\u5220\\u9664\"), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"context-sep\"\n  }), /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_6__.createElement(\"div\", {\n    className: \"context-item\",\n    onClick: closeContextMenu\n  }, \"\\u5173\\u95ED\"))));\n}\n\n//# sourceURL=webpack://fzz-react-app/./src/pages/jihua/jahua.js?\n}");

/***/ }),

/***/ "./src/pages/jihua/jihua.css":
/*!***********************************!*\
  !*** ./src/pages/jihua/jihua.css ***!
  \***********************************/
/***/ ((module, __unused_webpack_exports, __webpack_require__) => {

eval("{var api = __webpack_require__(/*! !../../../node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js */ \"./node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js\");\n            var content = __webpack_require__(/*! !!../../../node_modules/css-loader/dist/cjs.js!../../../node_modules/postcss-loader/src/index.js!./jihua.css */ \"./node_modules/css-loader/dist/cjs.js!./node_modules/postcss-loader/src/index.js!./src/pages/jihua/jihua.css\");\n\n            content = content.__esModule ? content.default : content;\n\n            if (typeof content === 'string') {\n              content = [[module.id, content, '']];\n            }\n\nvar options = {};\n\noptions.insert = \"head\";\noptions.singleton = false;\n\nvar update = api(content, options);\n\n\nif (true) {\n  if (!content.locals || module.hot.invalidate) {\n    var isEqualLocals = function isEqualLocals(a, b) {\n  if (!a && b || a && !b) {\n    return false;\n  }\n\n  var p;\n\n  for (p in a) {\n    if (a[p] !== b[p]) {\n      return false;\n    }\n  }\n\n  for (p in b) {\n    if (!a[p]) {\n      return false;\n    }\n  }\n\n  return true;\n};\n    var oldLocals = content.locals;\n\n    module.hot.accept(\n      /*! !!../../../node_modules/css-loader/dist/cjs.js!../../../node_modules/postcss-loader/src/index.js!./jihua.css */ \"./node_modules/css-loader/dist/cjs.js!./node_modules/postcss-loader/src/index.js!./src/pages/jihua/jihua.css\",\n      function () {\n        content = __webpack_require__(/*! !!../../../node_modules/css-loader/dist/cjs.js!../../../node_modules/postcss-loader/src/index.js!./jihua.css */ \"./node_modules/css-loader/dist/cjs.js!./node_modules/postcss-loader/src/index.js!./src/pages/jihua/jihua.css\");\n\n              content = content.__esModule ? content.default : content;\n\n              if (typeof content === 'string') {\n                content = [[module.id, content, '']];\n              }\n\n              if (!isEqualLocals(oldLocals, content.locals)) {\n                module.hot.invalidate();\n\n                return;\n              }\n\n              oldLocals = content.locals;\n\n              update(content);\n      }\n    )\n  }\n\n  module.hot.dispose(function() {\n    update();\n  });\n}\n\nmodule.exports = content.locals || {};\n\n//# sourceURL=webpack://fzz-react-app/./src/pages/jihua/jihua.css?\n}");

/***/ })

}]);