/*! For license information please see 318.9ca2a912.js.LICENSE.txt */
(self.webpackChunkfzz_react_app=self.webpackChunkfzz_react_app||[]).push([[318],{3312:()=>{},8318:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>B});var a=n(2284),r=n(8168),c=n(5458),i=n(4467),o=n(467),l=n(296),u=n(6540),s=n(1083),m=n(1225);function d(e){if(null!=e){var t=e["function"==typeof Symbol&&Symbol.iterator||"@@iterator"],n=0;if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length))return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}}throw new TypeError((0,a.A)(e)+" is not iterable")}function f(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return p(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?p(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0,r=function(){};return{s:r,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,i=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){o=!0,c=e},f:function(){try{i||null==n.return||n.return()}finally{if(o)throw c}}}}function p(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=Array(t);n<t;n++)a[n]=e[n];return a}function v(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,a)}return n}function g(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?v(Object(n),!0).forEach(function(t){(0,i.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):v(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function h(){var e,t,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",r=n.toStringTag||"@@toStringTag";function c(n,a,r,c){var l=a&&a.prototype instanceof o?a:o,u=Object.create(l.prototype);return y(u,"_invoke",function(n,a,r){var c,o,l,u=0,s=r||[],m=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,n){return c=t,o=0,l=e,d.n=n,i}};function f(n,a){for(o=n,l=a,t=0;!m&&u&&!r&&t<s.length;t++){var r,c=s[t],f=d.p,p=c[2];n>3?(r=p===a)&&(l=c[(o=c[4])?5:(o=3,3)],c[4]=c[5]=e):c[0]<=f&&((r=n<2&&f<c[1])?(o=0,d.v=a,d.n=c[1]):f<p&&(r=n<3||c[0]>a||a>p)&&(c[4]=n,c[5]=a,d.n=p,o=0))}if(r||n>1)return i;throw m=!0,a}return function(r,s,p){if(u>1)throw TypeError("Generator is already running");for(m&&1===s&&f(s,p),o=s,l=p;(t=o<2?e:l)||!m;){c||(o?o<3?(o>1&&(d.n=-1),f(o,l)):d.n=l:d.v=l);try{if(u=2,c){if(o||(r="next"),t=c[r]){if(!(t=t.call(c,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,o<2&&(o=0)}else 1===o&&(t=c.return)&&t.call(c),o<2&&(l=TypeError("The iterator does not provide a '"+r+"' method"),o=1);c=e}else if((t=(m=d.n<0)?l:n.call(a,d))!==i)break}catch(t){c=e,o=1,l=t}finally{u=1}}return{value:t,done:m}}}(n,r,c),!0),u}var i={};function o(){}function l(){}function u(){}t=Object.getPrototypeOf;var s=[][a]?t(t([][a]())):(y(t={},a,function(){return this}),t),m=u.prototype=o.prototype=Object.create(s);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,y(e,r,"GeneratorFunction")),e.prototype=Object.create(m),e}return l.prototype=u,y(m,"constructor",u),y(u,"constructor",l),l.displayName="GeneratorFunction",y(u,r,"GeneratorFunction"),y(m),y(m,r,"Generator"),y(m,a,function(){return this}),y(m,"toString",function(){return"[object Generator]"}),(h=function(){return{w:c,m:d}})()}function y(e,t,n,a){var r=Object.defineProperty;try{r({},"",{})}catch(e){r=0}y=function(e,t,n,a){function c(t,n){y(e,t,function(e){return this._invoke(t,n,e)})}t?r?r(e,t,{value:n,enumerable:!a,configurable:!a,writable:!a}):e[t]=n:(c("next",0),c("throw",1),c("return",2))},y(e,t,n,a)}n(3312);var b=null,E=null,w=null;function k(){return window.html2canvas?Promise.resolve(window.html2canvas):w||(w=new Promise(function(e,t){var n=document.createElement("script");n.src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js",n.async=!0,n.defer=!0,n.onload=function(){return e(window.html2canvas)},n.onerror=function(){return t(new Error("Failed to load html2canvas"))},document.body.appendChild(n)}))}function x(){return Math.random().toString(36).slice(2,9)}var N={lat:39.9042,lng:116.4074};function C(){return!("undefined"==typeof window||!window.CONFIG||!window.CONFIG.TIANDITU_TOKEN)}function S(){var e=new Date,t=function(e){return e<10?"0"+e:""+e};return{date:"".concat(e.getFullYear(),"-").concat(t(e.getMonth()+1),"-").concat(t(e.getDate())),time:"".concat(t(e.getHours()),":").concat(t(e.getMinutes()))}}function _(){var e="undefined"!=typeof window&&window.CONFIG?window.CONFIG:{};return{initialZoom:"number"==typeof e.MAP_INITIAL_ZOOM?e.MAP_INITIAL_ZOOM:11,customTile:{url:e.MAP_TILE_URL||"",attribution:e.MAP_ATTRIBUTION||"",subdomains:e.MAP_SUBDOMAINS||void 0}}}function A(e){return e*Math.PI/180}function I(e,t,n,a){var r=A(n-e),c=A(a-t),i=A(e),o=A(n),l=Math.pow(Math.sin(r/2),2)+Math.cos(i)*Math.cos(o)*Math.pow(Math.sin(c/2),2);return 12742*Math.asin(Math.min(1,Math.sqrt(l)))}function T(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return isFinite(e)?function(e,t){if(!e||!t)return!1;var n=e.city||e.county||e.district||e.province||e.state,a=t.city||t.county||t.district||t.province||t.state;if(n&&a&&n===a)return!0;var r=e.province||e.state,c=t.province||t.state;return!(!r||!c||r!==c)}(t,n)?e<1.2?"步行":e<8?"地铁/公交":e<25?"打车/网约车":e<60?"城际快线/高铁":"高铁/飞机":e<3?"打车/公交":e<50?"大巴/自驾":e<300?"高铁/动车":e<800?"高铁/飞机":"飞机":"步行"}function L(e,t){if(!e)return t||"";var n=[],a=e.state||e.province||"",r=e.city||e.town||e.village||"",c=e.city_district||e.district||e.county||"",i=e.road||e.residential||e.neighbourhood||"",o=e.house_number||"",l=e.amenity||e.tourism||e.building||e.hotel||e.shop||"";return a&&n.push(a),r&&!n.includes(r)&&n.push(r),c&&n.push(c),i&&n.push(i+(o||"")),l&&n.push(l),n.join("")||t||""}function O(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2,t=[],n=0,a=function(){var e=t.shift();e&&e()};return function(){var r=(0,o.A)(h().m(function r(c){return h().w(function(r){for(;;)switch(r.p=r.n){case 0:if(!(n>=e)){r.n=1;break}return r.n=1,new Promise(function(e){return t.push(e)});case 1:return n++,r.p=2,r.n=3,c();case 3:return r.a(2,r.v);case 4:return r.p=4,n--,a(),r.f(4);case 5:return r.a(2)}},r,null,[[2,,4,5]])}));return function(e){return r.apply(this,arguments)}}()}function F(e){return M.apply(this,arguments)}function M(){return M=(0,o.A)(h().m(function e(t){var n,a,r,c,i,o,l,u,s=arguments;return h().w(function(e){for(;;)switch(e.n){case 0:a=(n=s.length>1&&void 0!==s[1]?s[1]:{}).retries,r=void 0===a?2:a,c=n.baseDelay,i=void 0===c?500:c,o=0,l=h().m(function e(){var n,a,c,l,u,s;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,t();case 1:return u=e.v,e.a(2,{v:u});case 2:if(e.p=2,s=e.v,o++,n=s&&s.response&&s.response.status,a=!n||n>=500||429===n,!(o>r)&&a){e.n=3;break}throw s;case 3:return c=1+.2*Math.random(),l=Math.round(i*Math.pow(2,o-1)*c),e.n=4,new Promise(function(e){return setTimeout(e,l)});case 4:return e.a(2)}},e,null,[[0,2]])});case 1:return e.d(d(l()),2);case 2:if(!(u=e.v)){e.n=3;break}return e.a(2,u.v);case 3:e.n=1;break;case 4:return e.a(2)}},e)})),M.apply(this,arguments)}var j=O(2),D=O(2),R=new Map,P=new Map,z=new Map,G=200;function U(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:G;if(e.has(t)&&e.delete(t),e.set(t,n),e.size>a){var r=e.keys().next().value;e.delete(r)}}function B(){var e=(0,u.useRef)(null),t=((0,u.useRef)(null),(0,u.useRef)(null)),n=(0,u.useRef)(null),a=(0,u.useRef)(null),p=(0,u.useRef)(null),v=(0,u.useRef)({}),y=(0,u.useRef)(10),w=(0,u.useState)(!1),A=(0,l.A)(w,2),O=A[0],M=A[1],G=(0,u.useState)("我的旅行计划"),B=(0,l.A)(G,2),W=B[0],q=B[1],V=(0,u.useState)(null),H=(0,l.A)(V,2),Z=H[0],X=H[1],K=(0,u.useState)([]),Q=(0,l.A)(K,2),$=Q[0],Y=Q[1],J=(0,u.useState)(""),ee=(0,l.A)(J,2),te=ee[0],ne=ee[1],ae=(0,u.useState)(null),re=(0,l.A)(ae,2),ce=re[0],ie=re[1],oe=(0,u.useState)(""),le=(0,l.A)(oe,2),ue=le[0],se=le[1],me=(0,u.useState)(!0),de=(0,l.A)(me,2),fe=de[0],pe=de[1],ve=(0,u.useState)("list"),ge=(0,l.A)(ve,2),he=ge[0],ye=ge[1],be=(0,u.useState)(function(){try{return"1"===localStorage.getItem("jihua_show_extra")}catch(e){return!1}}),Ee=(0,l.A)(be,2),we=Ee[0],ke=Ee[1],xe=(0,u.useState)(Math.round(.46*window.innerHeight)),Ne=(0,l.A)(xe,2),Ce=Ne[0],Se=Ne[1],_e=(0,u.useRef)(!1),Ae=(0,u.useRef)(0),Ie=(0,u.useRef)(0),Te=(0,u.useState)(!1),Le=(0,l.A)(Te,2),Oe=Le[0],Fe=Le[1],Me=(0,u.useState)(null),je=(0,l.A)(Me,2),De=je[0],Re=je[1],Pe=(0,u.useRef)(0),ze=(0,u.useRef)(!1),Ge=(0,u.useRef)(140),Ue=(0,u.useRef)([]);(0,u.useEffect)(function(){Ue.current=et},[et]);var Be=(0,u.useRef)({tag:"",lat:null,lng:null,t:0}),We=function(e){return new Promise(function(t){return setTimeout(t,e)})},qe=(0,u.useState)(function(){try{var e=localStorage.getItem("jihua_supplies_templates"),t=e?JSON.parse(e):[];return Array.isArray(t)?t:[]}catch(e){return[]}}),Ve=(0,l.A)(qe,2),He=Ve[0],Ze=Ve[1],Xe=(0,u.useState)(""),Ke=(0,l.A)(Xe,2),Qe=Ke[0],$e=Ke[1],Ye=(0,u.useState)([]),Je=(0,l.A)(Ye,2),et=Je[0],tt=Je[1],nt=(0,u.useState)(function(){try{var e=parseInt(localStorage.getItem("jihua_sugg_max")||"5",10);return[3,5,8].includes(e)?e:5}catch(e){return 5}}),at=(0,l.A)(nt,2),rt=at[0],ct=at[1];(0,u.useEffect)(function(){try{localStorage.setItem("jihua_sugg_max",String(rt))}catch(e){}},[rt]);var it=(0,u.useState)({show:!1,x:0,y:0,itemId:null}),ot=(0,l.A)(it,2),lt=ot[0],ut=ot[1],st=(0,u.useRef)(null),mt=(0,u.useRef)(null),dt=(0,u.useState)("amap"),ft=(0,l.A)(dt,2),pt=ft[0],vt=ft[1],gt=(0,u.useRef)(0),ht=(0,u.useState)(!1),yt=(0,l.A)(ht,2),bt=yt[0],Et=yt[1],wt=(0,u.useState)(""),kt=(0,l.A)(wt,2),xt=kt[0],Nt=kt[1],Ct=(0,u.useRef)(null),St=(0,u.useState)(!1),_t=(0,l.A)(St,2),At=_t[0],It=_t[1],Tt=(0,u.useState)({done:0,total:0}),Lt=(0,l.A)(Tt,2),Ot=Lt[0],Ft=Lt[1],Mt=(0,u.useState)(!1),jt=(0,l.A)(Mt,2),Dt=jt[0],Rt=jt[1],Pt=(0,u.useState)([]),zt=(0,l.A)(Pt,2),Gt=zt[0],Ut=zt[1],Bt=(0,u.useRef)(new Map),Wt=(0,u.useState)(""),qt=(0,l.A)(Wt,2),Vt=qt[0],Ht=qt[1],Zt=(0,u.useState)(!1),Xt=(0,l.A)(Zt,2),Kt=Xt[0],Qt=Xt[1],$t=(0,u.useState)(!1),Yt=(0,l.A)($t,2),Jt=Yt[0],en=Yt[1],tn=(0,u.useState)(""),nn=(0,l.A)(tn,2),an=nn[0],rn=nn[1],cn=(0,u.useState)(function(){return S().date}),on=(0,l.A)(cn,2),ln=on[0],un=on[1],sn=(0,u.useState)([]),mn=(0,l.A)(sn,2),dn=mn[0],fn=mn[1],pn=(0,u.useState)(!1),vn=(0,l.A)(pn,2),gn=vn[0],hn=vn[1],yn=(0,u.useState)(!1),bn=(0,l.A)(yn,2),En=bn[0],wn=bn[1],kn=(0,u.useRef)(null),xn=(0,u.useRef)(0),Nn=(0,u.useCallback)(function(){try{var e=window&&window.CONFIG?window.CONFIG:{},t=localStorage.getItem("jihua_geo_mode")||"",n=String(t||e.GEO_MODE||"stable").toLowerCase();return"stable"===n||"auto"===n||"nominatim"===n?n:"stable"}catch(e){return"stable"}},[]),Cn=(0,m.wA)(),Sn=(0,m.d4)(function(e){return{travelPlans:e.travelPlans,travelPlansLoading:e.travelPlansLoading,travelPlansError:e.travelPlansError,currentPlan:e.currentPlan,planSaving:e.planSaving,planSaveError:e.planSaveError,planDeleting:e.planDeleting,planDeleteError:e.planDeleteError,currentPlanError:e.currentPlanError}}),_n=Sn.travelPlans,An=Sn.travelPlansLoading,In=Sn.travelPlansError,Tn=Sn.currentPlan,Ln=Sn.planSaving,On=Sn.planSaveError,Fn=Sn.planDeleting,Mn=Sn.planDeleteError,jn=Sn.currentPlanError;(0,u.useEffect)(function(){var r=!1;return(window.L?Promise.resolve(window.L):b||(b=new Promise(function(e,t){var n=document.createElement("link");n.rel="stylesheet",n.href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css",document.head.appendChild(n);var a=document.createElement("script");a.src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js",a.async=!0,a.defer=!0,a.onload=function(){return e(window.L)},a.onerror=function(){return t(new Error("Failed to load Leaflet"))},document.body.appendChild(a)}))).then(function(){if(!r){var i=_().initialZoom,l=window.L,u=l.map(e.current,{zoomAnimation:!1,markerZoomAnimation:!1,scrollWheelZoom:!0}).setView([N.lat,N.lng],i);!function(e){var t={url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:"&copy; OpenStreetMap contributors",subdomains:["a","b","c"]},a={default:t,amap:{url:"https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=7&x={x}&y={y}&z={z}",attribution:"© 高德地图(仅供开发调试)",subdomains:["1","2","3","4"]},geoqBlue:{url:"https://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineStreetPurplishBlue/MapServer/tile/{z}/{y}/{x}",attribution:"© GeoQ"},geoqGray:{url:"https://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineStreetGray/MapServer/tile/{z}/{y}/{x}",attribution:"© GeoQ"},geoqWarm:{url:"https://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineStreetWarm/MapServer/tile/{z}/{y}/{x}",attribution:"© GeoQ"},esriStreet:{url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",attribution:"© Esri"},esriImagery:{url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",attribution:"© Esri"},tdtVec:C()?{compose:[{url:"https://t{s}.tianditu.gov.cn/vec_w/wmts?service=wmts&request=GetTile&version=1.0.0&layer=vec&tilematrixSet=w&TileMatrix={z}&TileRow={y}&TileCol={x}&style=default&format=tiles&tk="+window.CONFIG.TIANDITU_TOKEN,subdomains:["0","1","2","3","4","5","6","7"]},{url:"https://t{s}.tianditu.gov.cn/cva_w/wmts?service=wmts&request=GetTile&version=1.0.0&layer=cva&tilematrixSet=w&TileMatrix={z}&TileRow={y}&TileCol={x}&style=default&format=tiles&tk="+window.CONFIG.TIANDITU_TOKEN,subdomains:["0","1","2","3","4","5","6","7"]}],attribution:"© 天地图"}:void 0,tdtImg:C()?{compose:[{url:"https://t{s}.tianditu.gov.cn/img_w/wmts?service=wmts&request=GetTile&version=1.0.0&layer=img&tilematrixSet=w&TileMatrix={z}&TileRow={y}&TileCol={x}&style=default&format=tiles&tk="+window.CONFIG.TIANDITU_TOKEN,subdomains:["0","1","2","3","4","5","6","7"]},{url:"https://t{s}.tianditu.gov.cn/cia_w/wmts?service=wmts&request=GetTile&version=1.0.0&layer=cia&tilematrixSet=w&TileMatrix={z}&TileRow={y}&TileCol={x}&style=default&format=tiles&tk="+window.CONFIG.TIANDITU_TOKEN,subdomains:["0","1","2","3","4","5","6","7"]}],attribution:"© 天地图"}:void 0},r=function(){var e=gt.current;return gt.current=e+1,0===e?"amap":1===e&&C()?"tdtVec":1!==e||C()?2===e?"esriStreet":3===e?"esriImagery":"default":"esriStreet"},c=_().customTile,i=t;if(e in a&&a[e]?i=a[e]:"custom"===e&&c.url&&(i={url:c.url,attribution:c.attribution||t.attribution,subdomains:c.subdomains||t.subdomains}),n.current){try{n.current.remove()}catch(e){}n.current=null}if(Pe.current=0,ze.current=!1,gt.current=0,i&&i.compose&&Array.isArray(i.compose)){var o=i.compose.map(function(e){var t={attribution:i.attribution||e.attribution,maxZoom:19,crossOrigin:!0,updateWhenIdle:!0};e.subdomains&&(t.subdomains=e.subdomains);var n=l.tileLayer(e.url,t);return n.on("tileerror",function(){ze.current||++Pe.current>=2&&(ze.current=!0,vt(r()))}),n});n.current=l.layerGroup(o).addTo(u)}else{var s={attribution:i.attribution,maxZoom:19,crossOrigin:!0,updateWhenIdle:!0};i.subdomains&&(s.subdomains=i.subdomains);var m=l.tileLayer(i.url,s);m.on("tileerror",function(){ze.current||++Pe.current>=2&&(ze.current=!0,vt(r()))}),n.current=m.addTo(u)}}(pt),t.current=u,M(!0),u.on("click",function(){var e=(0,o.A)(h().m(function e(t){var n,a,r,i,o,l,u,s;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=t.latlng.lat,a=t.latlng.lng,r=S(),!kn.current){e.n=5;break}if(i=kn.current,kn.current=null,o=null,Y(function(e){return e.map(function(e){return e.id===i?o=g(g({},e),{},{lat:n,lng:a,unlocated:!1}):e})}),!o){e.n=4;break}try{Dn(o)}catch(e){}return e.p=1,e.n=2,Gn(n,a);case 2:l=e.v,Y(function(e){return e.map(function(e){return e.id===o.id?g(g({},e),{},{name:l.cn||e.name,nameLocal:l.local||"",city:l.city||"",province:l.province||"",country:l.country||""}):e})}),e.n=4;break;case 3:e.p=3,e.v;case 4:return e.a(2);case 5:if(window.confirm("在此位置添加标记点并加入行程？")){e.n=6;break}return e.a(2);case 6:return u={id:x(),placeId:"",name:"标记点",lat:n,lng:a,date:r.date,time:r.time,notes:"",nameLocal:"",city:"",province:"",country:""},Dn(u),Y(function(e){return[].concat((0,c.A)(e),[u])}),e.p=7,e.n=8,Gn(n,a);case 8:s=e.v,Y(function(e){return e.map(function(e){return e.id===u.id?g(g({},e),{},{name:s.cn||e.name,nameLocal:s.local||"",city:s.city||"",province:s.province||"",country:s.country||""}):e})}),e.n=10;break;case 9:e.p=9,e.v;case 10:return e.a(2)}},e,null,[[7,9],[1,3]])}));return function(t){return e.apply(this,arguments)}}()),(window.L&&window.L.markerClusterGroup?Promise.resolve(!0):E||(E=new Promise(function(e,t){var n=document.createElement("link");n.rel="stylesheet",n.href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css",document.head.appendChild(n);var a=document.createElement("link");a.rel="stylesheet",a.href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css",document.head.appendChild(a);var r=document.createElement("script");r.src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js",r.async=!0,r.defer=!0,r.onload=function(){return e(!0)},r.onerror=function(){return t(new Error("Failed to load MarkerCluster"))},document.body.appendChild(r)}))).then(function(){if(window.L&&t.current){var e=window.L.markerClusterGroup({showCoverageOnHover:!1,spiderfyOnMaxZoom:!0,chunkedLoading:!0,removeOutsideVisibleBounds:!0});a.current=e,u.addLayer(e),Object.values(v.current).forEach(function(t){try{e.addLayer(t)}catch(e){}})}}).catch(function(){});try{p.current=window.L.layerGroup().addTo(u)}catch(e){p.current=null}}}).catch(function(e){return ne(e.message)}),function(){r=!0}},[]),(0,u.useEffect)(function(){if(t.current&&window.L){var e=window.L,a={url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:"&copy; OpenStreetMap contributors",subdomains:["a","b","c"]},r={default:a,amap:{url:"https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=7&x={x}&y={y}&z={z}",attribution:"© 高德地图(仅供开发调试)",subdomains:["1","2","3","4"]},geoqBlue:{url:"https://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineStreetPurplishBlue/MapServer/tile/{z}/{y}/{x}",attribution:"© GeoQ"},geoqGray:{url:"https://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineStreetGray/MapServer/tile/{z}/{y}/{x}",attribution:"© GeoQ"},geoqWarm:{url:"https://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineStreetWarm/MapServer/tile/{z}/{y}/{x}",attribution:"© GeoQ"},esriStreet:{url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",attribution:"© Esri"},esriImagery:{url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",attribution:"© Esri"},tdtVec:C()?{compose:[{url:"https://t{s}.tianditu.gov.cn/vec_w/wmts?service=wmts&request=GetTile&version=1.0.0&layer=vec&tilematrixSet=w&TileMatrix={z}&TileRow={y}&TileCol={x}&style=default&format=tiles&tk="+window.CONFIG.TIANDITU_TOKEN,subdomains:["0","1","2","3","4","5","6","7"]},{url:"https://t{s}.tianditu.gov.cn/cva_w/wmts?service=wmts&request=GetTile&version=1.0.0&layer=cva&tilematrixSet=w&TileMatrix={z}&TileRow={y}&TileCol={x}&style=default&format=tiles&tk="+window.CONFIG.TIANDITU_TOKEN,subdomains:["0","1","2","3","4","5","6","7"]}],attribution:"© 天地图"}:void 0,tdtImg:C()?{compose:[{url:"https://t{s}.tianditu.gov.cn/img_w/wmts?service=wmts&request=GetTile&version=1.0.0&layer=img&tilematrixSet=w&TileMatrix={z}&TileRow={y}&TileCol={x}&style=default&format=tiles&tk="+window.CONFIG.TIANDITU_TOKEN,subdomains:["0","1","2","3","4","5","6","7"]},{url:"https://t{s}.tianditu.gov.cn/cia_w/wmts?service=wmts&request=GetTile&version=1.0.0&layer=cia&tilematrixSet=w&TileMatrix={z}&TileRow={y}&TileCol={x}&style=default&format=tiles&tk="+window.CONFIG.TIANDITU_TOKEN,subdomains:["0","1","2","3","4","5","6","7"]}],attribution:"© 天地图"}:void 0},c=_().customTile,i=a;if(pt in r&&r[pt]?i=r[pt]:"custom"===pt&&c.url&&(i={url:c.url,attribution:c.attribution||a.attribution,subdomains:c.subdomains||a.subdomains}),n.current){try{n.current.remove()}catch(e){}n.current=null}Pe.current=0,ze.current=!1,gt.current=0;var o=function(){var e=gt.current;return gt.current=e+1,0===e?"amap":1===e&&C()?"tdtVec":1!==e||C()?2===e?"esriStreet":3===e?"esriImagery":"default":"esriStreet"};if(i&&i.compose&&Array.isArray(i.compose)){var l=i.compose.map(function(t){var n={attribution:i.attribution||t.attribution,maxZoom:19,crossOrigin:!0,updateWhenIdle:!0};t.subdomains&&(n.subdomains=t.subdomains);var a=e.tileLayer(t.url,n);return a.on("tileerror",function(){ze.current||++Pe.current>=2&&(ze.current=!0,vt(o()))}),a});n.current=e.layerGroup(l).addTo(t.current)}else{var u={attribution:i.attribution,maxZoom:19,crossOrigin:!0,updateWhenIdle:!0};i.subdomains&&(u.subdomains=i.subdomains);var s=e.tileLayer(i.url,u);s.on("tileerror",function(){ze.current||++Pe.current>=2&&(ze.current=!0,vt(o()))}),n.current=s.addTo(t.current)}}},[pt]);var Dn=(0,u.useCallback)(function(e){if(t.current&&window.L){var n=window.L.marker([e.lat,e.lng],{draggable:!0});if(a.current&&a.current.addLayer)try{a.current.addLayer(n)}catch(e){n.addTo(t.current)}else n.addTo(t.current);n.on("dragend",function(){var t=(0,o.A)(h().m(function t(n){var a,r;return h().w(function(t){for(;;)switch(t.p=t.n){case 0:return a=n.target.getLatLng(),Y(function(t){return t.map(function(t){return t.id===e.id?g(g({},t),{},{lat:a.lat,lng:a.lng}):t})}),t.p=1,t.n=2,Gn(a.lat,a.lng);case 2:r=t.v,Y(function(t){return t.map(function(t){return t.id===e.id?g(g({},t),{},{name:r.cn||t.name,nameLocal:r.local||"",city:r.city||"",province:r.province||"",country:r.country||""}):t})}),t.n=4;break;case 3:t.p=3,t.v;case 4:return t.a(2)}},t,null,[[1,3]])}));return function(e){return t.apply(this,arguments)}}()),v.current[e.id]=n}},[]);(0,u.useEffect)(function(){window.L&&$.forEach(function(e,t){var n=v.current[e.id];if(n){var a=window.L&&window.L.divIcon?window.L.divIcon({className:"marker-index-icon",html:"<div>".concat(t+1,"</div>"),iconSize:[24,24],iconAnchor:[12,12]}):void 0;a&&n.setIcon(a)}})},[$]);var Rn=function(e,t){Y(function(n){var a=n.slice(),r=e+t;if(r<0||r>=a.length)return n;var c=a.splice(e,1),i=(0,l.A)(c,1)[0];return a.splice(r,0,i),a})},Pn=function(e,t){null!=e&&null!=t&&e!==t&&Y(function(n){var a=n.slice();if(e<0||e>=a.length||t<0||t>=a.length)return n;var r=a.splice(e,1),c=(0,l.A)(r,1)[0];return a.splice(t,0,c),a})},zn=function(e,t,n){Y(function(a){return a.map(function(a){return a.id===e?g(g({},a),{},(0,i.A)({},t,n)):a})})},Gn=((0,u.useCallback)(function(e,t){Y(function(n){var a=n.findIndex(function(t){return t.id===e});if(a<0)return n;var r=n[a],c=String(r.notes||""),i=/(交通：)([^。；;，,\n]*)/;i.test(c)?c=c.replace(i,function(e,n){return"".concat(n).concat(t)}):c.trim()?c+=" · 交通：".concat(t):c="交通：".concat(t);var o=n.slice();return o[a]=g(g({},r),{},{notes:c}),o})},[]),function(){var e=(0,o.A)(h().m(function e(t,n){var a,r,c,i,o,l,u,m,d,f,p,v,y,b,E,w,k,x,N,C,S;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:if(a=t.toFixed(5)+","+n.toFixed(5),!P.has("cn:"+a)||!z.has("en:"+a)){e.n=1;break}return r=P.get("cn:"+a),c=z.get("en:"+a),i=P.get("meta:"+a)||{},e.a(2,g({cn:r,local:c},i));case 1:if("stable"!==Nn()){e.n=5;break}return e.p=2,e.n=3,D(function(){return F(function(){return s.A.get("https://api.bigdatacloud.net/data/reverse-geocode-client",{params:{latitude:t,longitude:n,localityLanguage:"zh"},timeout:6e3})},{retries:1,baseDelay:600})});case 3:return o=e.v,l=o.data||{},u=l.locality||l.city||l.localityInfo&&l.localityInfo.locality&&l.localityInfo.locality.name||"",m=l.principalSubdivision||"",d=l.countryName||"",f=[u,m,d].filter(Boolean).join(" · ")||d||m||u||"",p=f,v={city:u||"",province:m||"",country:d||""},P.set("cn:"+a,f),z.set("en:"+a,p),P.set("meta:"+a,v),e.a(2,g({cn:f,local:p},v));case 4:return e.p=4,e.v,e.a(2,{cn:"",local:"",city:"",province:"",country:""});case 5:return y=D(function(){return F(function(){return s.A.get("https://nominatim.openstreetmap.org/reverse",{params:{format:"jsonv2",lat:t,lon:n,addressdetails:1,namedetails:1},headers:{Accept:"application/json","Accept-Language":"zh-CN"},timeout:7e3})},{retries:1,baseDelay:700})}).then(function(e){var t=e.data||{},n=t.address||{},r=L(n,t.display_name||""),c=t.namedetails||{},i=c["name:zh"]||c["name:zh-CN"]||c["name:en"]||c.name||t.display_name||"",o={city:n.city||n.town||n.village||n.county||n.city_district||"",province:n.state||n.province||"",country:n.country||""};return P.set("cn:"+a,r),z.set("en:"+a,i),P.set("meta:"+a,o),g({cn:r,local:i},o)}),e.p=6,e.n=7,y;case 7:return e.a(2,e.v);case 8:return e.p=8,e.v,e.p=9,e.n=10,D(function(){return F(function(){return s.A.get("https://api.bigdatacloud.net/data/reverse-geocode-client",{params:{latitude:t,longitude:n,localityLanguage:"zh"},timeout:6e3})},{retries:1,baseDelay:600})});case 10:return b=e.v,E=b.data||{},w=E.locality||E.city||E.localityInfo&&E.localityInfo.locality&&E.localityInfo.locality.name||"",k=E.principalSubdivision||"",x=E.countryName||"",N=[w,k,x].filter(Boolean).join(" · ")||x||k||w||"",C=N,S={city:w||"",province:k||"",country:x||""},P.set("cn:"+a,N),z.set("en:"+a,C),P.set("meta:"+a,S),e.a(2,g({cn:N,local:C},S));case 11:return e.p=11,e.v,e.a(2,{cn:"",local:"",city:"",province:"",country:""})}},e,null,[[9,11],[6,8],[2,4]])}));return function(t,n){return e.apply(this,arguments)}}()),Un=(0,u.useCallback)(function(){Cn({type:"TRAVEL_PLANS_FETCH_REQUEST"})},[Cn]),Bn=(0,u.useCallback)(function(e){e&&Cn({type:"TRAVEL_PLAN_FETCH_REQUEST",payload:e})},[Cn]),Wn=(0,u.useCallback)(function(){W.trim()?(ne(""),Cn({type:"TRAVEL_PLAN_SAVE_REQUEST",payload:{id:Z,name:W.trim(),items:$}})):ne("请输入计划名称")},[Cn,Z,W,$]),qn=function(){if(X(null),q("我的旅行计划"),Y([]),a.current&&a.current.clearLayers)try{a.current.clearLayers()}catch(e){}Object.values(v.current).forEach(function(e){try{e.remove()}catch(e){}}),v.current={}},Vn=((0,u.useCallback)(function(){if(!Z)return qn();Cn({type:"TRAVEL_PLAN_DELETE_REQUEST",payload:Z})},[Cn,Z]),(0,u.useCallback)(function(){if(!Z)return qn();window.confirm("确认删除该计划？")&&window.confirm("再次确认：删除后无法恢复，确定吗？")&&Cn({type:"TRAVEL_PLAN_DELETE_REQUEST",payload:Z})},[Cn,Z])),Hn=function(e){window.confirm("确认删除该地点？")&&window.confirm("再次确认：删除后无法恢复，确定吗？")&&function(e){Y(function(t){return t.filter(function(t){return t.id!==e})});var t=v.current[e];if(t){if(a.current&&a.current.removeLayer)try{a.current.removeLayer(t)}catch(e){try{t.remove()}catch(e){}}else try{t.remove()}catch(e){}delete v.current[e]}}(e)},Zn=(0,u.useCallback)(function(e,t,n){ut({show:!0,x:e,y:t,itemId:n})},[]),Xn=(0,u.useCallback)(function(){ut({show:!1,x:0,y:0,itemId:null})},[]),Kn=function(e){return{onMouseDown:function(t){st.current&&clearTimeout(st.current);var n=t.clientX,a=t.clientY;st.current=setTimeout(function(){return Zn(n,a,e)},550)},onMouseUp:function(){st.current&&clearTimeout(st.current)},onMouseLeave:function(){st.current&&clearTimeout(st.current)},onTouchStart:function(t){st.current&&clearTimeout(st.current);var n=t.touches&&t.touches[0],a=n?n.clientX:0,r=n?n.clientY:0;st.current=setTimeout(function(){return Zn(a,r,e)},550)},onTouchEnd:function(){st.current&&clearTimeout(st.current)},onTouchMove:function(){st.current&&clearTimeout(st.current)}}};function Qn(){return["证件：身份证/护照/签证","电子：手机/充电宝/充电器/数据线","衣物：外套/换洗衣物/雨具","洗护：牙刷牙膏/洗面奶/毛巾","药品：感冒药/肠胃药/创可贴","其他：水杯/太阳镜/防晒/伞"].map(function(e){return"- "+e}).join("\n")}(0,u.useEffect)(function(){if(Tn){if(a.current&&a.current.clearLayers)try{a.current.clearLayers()}catch(e){}Object.values(v.current).forEach(function(e){try{e.remove()}catch(e){}}),v.current={},X(Tn.id||null),q(Tn.name||"未命名计划");var e=Array.isArray(Tn.items)?Tn.items:[];Y(e),setTimeout(function(){e.forEach(function(e){return Dn(e)}),e[0]&&t.current&&t.current.setView([e[0].lat,e[0].lng],_().initialZoom)},0)}},[Tn,Dn]),(0,u.useEffect)(function(){try{localStorage.setItem("jihua_show_extra",we?"1":"0")}catch(e){}},[we]),(0,u.useEffect)(function(){var e="jihua_supplies_"+(Z||"__temp"),t=localStorage.getItem(e);return Nt(null!=t?t:Qn()),function(){}},[Z]),(0,u.useEffect)(function(){bt&&(Ct.current&&clearTimeout(Ct.current),Ct.current=setTimeout(function(){try{localStorage.setItem("jihua_supplies_"+(Z||"__temp"),xt)}catch(e){}},400))},[xt,bt,Z]),(0,u.useEffect)(function(){try{localStorage.setItem("jihua_supplies_templates",JSON.stringify(He.slice(0,100)))}catch(e){}},[He]);var $n=(0,u.useCallback)(function(){var e=window.prompt("输入模板名称",Qe||W||"我的模板");if(e&&(e=e.trim())&&(!He.some(function(t){return t.name===e})||window.confirm("同名模板已存在，是否覆盖？"))){var t={name:e,text:xt};Ze(function(n){var a=n.filter(function(t){return t.name!==e});return[].concat((0,c.A)(a),[t]).sort(function(e,t){return e.name.localeCompare(t.name)})}),$e(e)}},[He,xt,Qe,W]),Yn=(0,u.useCallback)(function(){Qe&&window.confirm('删除模板 "'.concat(Qe,'"？'))&&(Ze(function(e){return e.filter(function(e){return e.name!==Qe})}),$e(""))},[Qe]),Jn=(0,u.useCallback)(function(e){var t=$.filter(function(t){return(t.date||"")===e}),n=t.map(function(e,t){return{type:"Feature",properties:{index:t+1,name:e.name,nameLocal:e.nameLocal||"",time:(e.date||"")+" "+(e.time||"")},geometry:{type:"Point",coordinates:[e.lng,e.lat]}}});t.length>=2&&n.push({type:"Feature",properties:{name:"Path"},geometry:{type:"LineString",coordinates:t.map(function(e){return[e.lng,e.lat]})}});var a={type:"FeatureCollection",features:n},r=new Blob([JSON.stringify(a,null,2)],{type:"application/geo+json"}),c=URL.createObjectURL(r),i=document.createElement("a");i.href=c,i.download="".concat((W||"计划").replace(/[\\/:*?"<>|]/g,"_"),"-").concat(e,".geojson"),i.click(),URL.revokeObjectURL(c)},[$,W]),ea=(0,u.useCallback)(function(e){var t=$.filter(function(t){return(t.date||"")===e}),n=(W||"计划").replace(/[\\/:*?"<>|]/g,"_"),a=t.map(function(e,t){return'<wpt lat="'.concat(e.lat,'" lon="').concat(e.lng,'"><name>').concat(t+1,". ").concat(ta(e.name||""),"</name><desc>").concat(ta(((e.date||"")+" "+(e.time||"")).trim()),"</desc></wpt>")}).join(""),r=t.length?"<trk><name>".concat(ta(n+" "+e),"</name><trkseg>").concat(t.map(function(e){return'<trkpt lat="'.concat(e.lat,'" lon="').concat(e.lng,'"></trkpt>')}).join(""),"</trkseg></trk>"):"",c=new Blob(['<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" creator="JihuaPlanner" xmlns="http://www.topografix.com/GPX/1/1">'+a+r+"</gpx>"],{type:"application/gpx+xml"}),i=URL.createObjectURL(c),o=document.createElement("a");o.href=i,o.download="".concat(n,"-").concat(e,".gpx"),o.click(),URL.revokeObjectURL(i)},[$,W]);function ta(e){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}var na=(0,u.useCallback)(function(){var e=(0,o.A)(h().m(function e(t){var n,a,r,c,i,o,l;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,k();case 1:if(n=e.v,a=document.getElementById("day-"+t)){e.n=2;break}return ne("未找到该天内容"),e.a(2);case 2:return e.n=3,n(a,{backgroundColor:null,scale:Math.min(2,window.devicePixelRatio||1),useCORS:!0});case 3:return r=e.v,e.n=4,new Promise(function(e){return r.toBlob(function(t){return e(t)},"image/png")});case 4:c=e.v,i=URL.createObjectURL(c),(o=document.createElement("a")).href=i,o.download="".concat((W||"计划").replace(/[\/:*?"<>|]/g,"_"),"-").concat(t,".png"),o.click(),URL.revokeObjectURL(i),e.n=6;break;case 5:e.p=5,l=e.v,ne("导出图片失败："+(l&&l.message||l));case 6:return e.a(2)}},e,null,[[0,5]])}));return function(t){return e.apply(this,arguments)}}(),[W]),aa=(0,u.useCallback)(function(e){var n=$[$.length-1],a=n?n.lat:t.current?t.current.getCenter().lat:N.lat,r=n?n.lng:t.current?t.current.getCenter().lng:N.lng,i=S(),o={id:x(),placeId:"",name:"当天备注",nameLocal:"",lat:a,lng:r,date:e,time:i.time,notes:"当天备注："};Y(function(e){return[].concat((0,c.A)(e),[o])})},[$]),ra=(0,u.useRef)(null),ca=(0,u.useRef)(0),ia=(0,u.useState)(!1),oa=(0,l.A)(ia,2),la=oa[0],ua=oa[1],sa=(0,u.useState)(-1),ma=(0,l.A)(sa,2),da=ma[0],fa=ma[1],pa=(0,u.useCallback)(function(){var e=(0,o.A)(h().m(function e(n){var a,r,c,i,l,u,m,d,p,v,b,E,w,k,x,N,C,S,_,A,I,T,L,O,M,D,P,z,G,B,W,q,V,H,Z,X,K,Q,$,Y,J,ee;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:if((a=(n||"").trim())&&!(a.length<2)){e.n=1;break}return tt([]),e.a(2);case 1:if(r=/[\u4e00-\u9fff\u3040-\u30ff]/.test(a),c=a.toLowerCase(),i={大阪:["osaka"],东京:["tokyo"],京都:["kyoto"],名古屋:["nagoya"],札幌:["sapporo"],福冈:["fukuoka"],横滨:["yokohama"],神户:["kobe"],冲绳:["okinawa"]}[a]||[],l="global",u="",m="",fe&&t.current&&(d=t.current.getBounds(),p=d.getWest().toFixed(3),v=d.getEast().toFixed(3),b=d.getNorth().toFixed(3),E=d.getSouth().toFixed(3),w=t.current.getZoom?t.current.getZoom():0,k=r&&a.length>=3&&w>=12,u=k?"&viewbox=".concat(p,",").concat(b,",").concat(v,",").concat(E,"&bounded=1"):"","".concat(p,",").concat(E,",").concat(v,",").concat(b),m="".concat(E,",").concat(p,",").concat(b,",").concat(v),x=t.current.getCenter(),N=(Math.round(2*x.lat)/2).toFixed(1),C=(Math.round(2*x.lng)/2).toFixed(1),S=Math.round(w),_=Be.current&&Be.current.tag?"|adm:".concat(Be.current.tag):"",l="".concat(N,",").concat(C,",z").concat(S).concat(_),(!Be.current.tag||Math.abs((Be.current.lat||0)-x.lat)>.5||Math.abs((Be.current.lng||0)-x.lng)>.5||Date.now()-(Be.current.t||0)>12e4)&&Gn(x.lat,x.lng).then(function(e){var t="".concat(e.city||"","_").concat(e.province||"").replace(/\s+/g,"");Be.current={tag:t,lat:x.lat,lng:x.lng,t:Date.now()}}).catch(function(){})),A=a+"|"+l,!R.has(A)){e.n=2;break}return tt(R.get(A)),e.a(2);case 2:return ra.current&&ra.current.cancel("cancelled"),I=s.A.CancelToken.source(),ra.current=I,ua(!0),T=++ca.current,L="undefined"!=typeof performance&&performance.now?performance.now():Date.now(),O=Nn(),M="stable"!==O&&Date.now()>(xn.current||0),D=[],P=r&&/大阪|东京|京都|名古屋|札幌|福冈|冲绳|神户|横滨/.test(a)?"&countrycodes=jp":"",z="https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=10&accept-language=zh-CN".concat(P,"&q=").concat(encodeURIComponent(a)),G=M?j(function(){return F(function(){return s.A.get(z+u,{headers:{Accept:"application/json"},timeout:1500,cancelToken:I.token}).catch(function(){return s.A.get(z,{headers:{Accept:"application/json"},timeout:1500,cancelToken:I.token})})},{retries:1,baseDelay:500})}).then(function(e){return Array.isArray(e.data)?e.data:[]}).catch(function(e){return xn.current=Date.now()+6e5,[]}):Promise.resolve([]),B=function(e){return String(e).replace(/[.*+?^${}()|[\]\\]/g,"\\$&")},W=fe&&m?'[out:json][timeout:12];\n(\n        node["name:zh"~"'.concat(B(a),'",i](').concat(m,');\n\n        way["name:zh"~"').concat(B(a),'",i](').concat(m,');\n\n        relation["name:zh"~"').concat(B(a),'",i](').concat(m,');\n\n        node["name"~"').concat(B(a),'",i](').concat(m,');\n\n        way["name"~"').concat(B(a),'",i](').concat(m,');\n\n        relation["name"~"').concat(B(a),'",i](').concat(m,");\n\n      );\nout center 30;"):"",q=W?s.A.post("https://overpass-api.de/api/interpreter","data=".concat(encodeURIComponent(W)),{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},timeout:8e3,cancelToken:I.token}).catch(function(){return s.A.post("https://overpass.kumi.systems/api/interpreter","data=".concat(encodeURIComponent(W)),{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},timeout:8e3,cancelToken:I.token})}).then(function(e){return(e.data&&e.data.elements||[]).slice(0,30).map(function(e){var t=e.tags||{},n=t["name:zh"],a=t.name||n||"",r=null!=e.lat?e.lat:e.center&&e.center.lat,c=null!=e.lon?e.lon:e.center&&e.center.lon;return{place_id:null,osm_id:e.id,display_name:n||a||"未命名",lat:String(r||"0"),lon:String(c||"0")}}).filter(function(e){return"0"!==e.lat&&"0"!==e.lon})}).catch(function(){return[]}):Promise.resolve([]),V=s.A.get("https://geocoding-api.open-meteo.com/v1/search",{params:{name:a,count:8,language:"zh",format:"json"},timeout:5e3,cancelToken:I.token}).then(function(e){return(e.data&&e.data.results||[]).map(function(e){return{place_id:null,osm_id:null,display_name:[e.name,e.admin1,e.country].filter(Boolean).join(" · "),lat:String(e.latitude),lon:String(e.longitude)}})}),H=i.length?i[0]:"",Z=H?j(function(){return F(function(){return s.A.get("https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=10&accept-language=zh-CN&q=".concat(encodeURIComponent(H)),{headers:{Accept:"application/json"},timeout:3500,cancelToken:I.token})},{retries:1,baseDelay:400})}).then(function(e){return Array.isArray(e.data)?e.data:[]}).catch(function(){return[]}):Promise.resolve([]),X=H?s.A.get("https://geocoding-api.open-meteo.com/v1/search",{params:{name:H,count:6,language:"zh",format:"json"},timeout:4500,cancelToken:I.token}).then(function(e){return(e.data&&e.data.results||[]).map(function(e){return{place_id:null,osm_id:null,display_name:[e.name,e.admin1,e.country].filter(Boolean).join(" · "),lat:String(e.latitude),lon:String(e.longitude)}})}).catch(function(){return[]}):Promise.resolve([]),D.push(G,q,V,Z,X),e.p=3,K=function(e){return e.then(function(e){return e}).catch(function(){return[]})},e.n=4,Promise.race(D.map(K));case 4:return Q=e.v,e.p=5,$=Q.slice(0,y.current),e.n=6,Promise.all($.map(function(){var e=(0,o.A)(h().m(function e(t){var n;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,Gn(parseFloat(t.lat),parseFloat(t.lon));case 1:return n=e.v,e.a(2,g(g({},t),{},{display_name:n.cn||t.display_name}));case 2:return e.p=2,e.v,e.a(2,t)}},e,null,[[0,2]])}));return function(t){return e.apply(this,arguments)}}()));case 6:Y=e.v,Q=Y.concat(Q.slice(y.current)),e.n=8;break;case 7:e.p=7,e.v;case 8:(J=t.current?t.current.getCenter():null)&&Q.length&&(Q=Q.map(function(e,t){var n=String(e.display_name||""),r=n.toLowerCase(),o=n.includes(a)||r.includes(c)||i.some(function(e){return r.includes(e)}),l=Math.hypot(parseFloat(e.lat)-J.lat,parseFloat(e.lon)-J.lng);return g(g({},e),{},{__m:o?1:0,__dist:l,__rank:t})}).sort(function(e,t){return t.__m-e.__m||(e.__dist||0)-(t.__dist||0)}),Q=Q.map(function(e,t){return g(g({},e),{},{__rank:t})})),T===ca.current&&(U(R,A,Q),tt(Q)),Promise.allSettled(D).then(function(){var e=(0,o.A)(h().m(function e(n){var r,l,u,s,m,d,p,v,b,E,w,k,x;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:if(T===ca.current){e.n=1;break}return e.a(2);case 1:r=n.reduce(function(e,t){return"fulfilled"===t.status&&Array.isArray(t.value)&&(e=e.concat(t.value)),e},[]),l=new Set,u=[],s=f(r),e.p=2,s.s();case 3:if((m=s.n()).done){e.n=6;break}if(d=m.value,p="".concat(d.lat,"|").concat(d.lon,"|").concat(d.display_name),!l.has(p)){e.n=4;break}return e.a(3,5);case 4:l.add(p),u.push(d);case 5:e.n=3;break;case 6:e.n=8;break;case 7:e.p=7,x=e.v,s.e(x);case 8:return e.p=8,s.f(),e.f(8);case 9:v=t.current?t.current.getCenter():null,b=u.map(function(e){var t=String(e.display_name||""),n=t.toLowerCase(),r=t.includes(a)||n.includes(c)||i.some(function(e){return n.includes(e)});return g(g({},e),{},{__dist:v?Math.hypot(parseFloat(e.lat)-v.lat,parseFloat(e.lon)-v.lng):0,__m:r?1:0})}),E=new Map,(Ue.current||[]).forEach(function(e,t){var n="".concat(e.lat,"|").concat(e.lon);E.has(n)||E.set(n,t)}),w=E.size,b=b.map(function(e){var t="".concat(e.lat,"|").concat(e.lon),n=E.has(t)?E.get(t):w++;return g(g({},e),{},{__rank:n})}),b.sort(function(e,t){return t.__m-e.__m||e.__rank-t.__rank}),(0,o.A)(h().m(function e(){var t,n,a;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:t=Math.min(y.current,10,b.length),n=0;case 1:if(!(n<t)){e.n=7;break}return e.p=2,e.n=3,Gn(parseFloat(b[n].lat),parseFloat(b[n].lon));case 3:a=e.v,b[n]=g(g({},b[n]),{},{display_name:a.cn||b[n].display_name}),e.n=5;break;case 4:e.p=4,e.v;case 5:return e.n=6,We(Ge.current);case 6:n++,e.n=1;break;case 7:T===ca.current&&(U(R,A,b),tt(b));case 8:return e.a(2)}},e,null,[[2,4]])}))(),U(R,A,b),tt(b),k="undefined"!=typeof performance&&performance.now?performance.now():Date.now(),Ge.current=k-L>1500?Math.min(500,Math.round(1.5*Ge.current)):Math.max(100,Math.round(.9*Ge.current));case 10:return e.a(2)}},e,null,[[2,7,8,9]])}));return function(t){return e.apply(this,arguments)}}()),e.n=10;break;case 9:e.p=9,ee=e.v,s.A.isCancel(ee)||(ne("地点搜索失败"),tt([]));case 10:return e.p=10,ua(!1),e.f(10);case 11:return e.a(2)}},e,null,[[5,7],[3,9,10,11]])}));return function(t){return e.apply(this,arguments)}}(),[fe]),va=(0,u.useRef)(null),ga=(0,u.useCallback)(function(){var e=(0,o.A)(h().m(function e(n){var a,r,i,o,l,u,s,m,d;return h().w(function(e){for(;;)switch(e.n){case 0:if(n){e.n=1;break}return e.a(2);case 1:return a=parseFloat(n.lat),r=parseFloat(n.lon),i=S(),o=$[$.length-1],l=o?I(o.lat,o.lng,a,r):0,e.n=2,Gn(a,r).catch(function(){return{cn:n.display_name||"未命名",local:n.display_name||"未命名"}});case 2:u=e.v,s=o?T(l,o,u):"",m=o?"与上个地点直线距离约 ".concat(l.toFixed(1)," km · 交通：建议").concat(s):"",d={id:x(),placeId:String(n.place_id||n.osm_id||""),name:u.cn||n.display_name||"未命名地点",nameLocal:u.local||"",city:u.city||"",province:u.province||"",country:u.country||"",lat:a,lng:r,date:i.date,time:i.time,notes:m},Dn(d),Y(function(e){return[].concat((0,c.A)(e),[d])}),tt([]),se(""),fa(-1),t.current&&t.current.setView([a,r],14);case 3:return e.a(2)}},e)}));return function(t){return e.apply(this,arguments)}}(),[$]),ha=function(){var e=(0,o.A)(h().m(function e(t,n){var a,r,c,i,o;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:if(a=String(t||""),r=/长沙/.test(a)||n.some(function(e){return/长沙/.test(e.name||"")}),c=/岳阳/.test(a)||n.some(function(e){return/岳阳|君山|洞庭/.test(e.name||"")}),!r||!c){e.n=1;break}return e.a(2,"长沙到岳阳旅行计划");case 1:if(e.p=1,!(i=n[0])){e.n=3;break}return e.n=2,Gn(i.lat,i.lng);case 2:if(!(o=e.v)||!o.city){e.n=3;break}return e.a(2,"".concat(o.city,"旅行计划"));case 3:e.n=5;break;case 4:e.p=4,e.v;case 5:return e.a(2,"我的旅行计划")}},e,null,[[1,4]])}));return function(t,n){return e.apply(this,arguments)}}(),ya=function(e){var t,n=[],a=f(String(e||"").split(/\r?\n/));try{for(a.s();!(t=a.n()).done;){var r=t.value;(r=r.trim())&&"↓"!==r?n.push(r):n.push("")}}catch(e){a.e(e)}finally{a.f()}for(var c=[],i=/^(?:\d{1,2})月(?:\d{1,2})日(?:周[一二三四五六日天])?$/,o=/(\d{1,2})月(\d{1,2})日/,l=/^时间[:：]\s*(.+)$/,u=/^(\d{1,2})[，,、.]+\s*(.+)$/,s=function(e){if(!e)return"";var t=e.match(/(上|下|中)?午?\s*(\d{1,2})\s*点(?:\s*(\d{1,2}))?(?:\s*半)?/);if(t){var n=parseInt(t[2],10)||0,a=parseInt(t[3]||"0",10)||0;/下/.test(t[1]||"")&&n<12&&(n+=12);var r=function(e){return e<10?"0"+e:""+e};return"".concat(r(n),":").concat(r(a))}var c=e.match(/(\d{1,2})[:：](\d{2})/);if(c){var i=function(e){return e<10?"0"+e:""+e};return"".concat(i(parseInt(c[1],10)),":").concat(i(parseInt(c[2],10)))}return""},m="",d=null,p="",v=function(){d&&d.name&&c.push(g({},d)),d=null},h=0,y=n;h<y.length;h++){var b=y[h];if(b)if(i.test(b)){v();var E=b.match(o);if(E){var w=(new Date).getFullYear(),k=("0"+parseInt(E[1],10)).slice(-2),x=("0"+parseInt(E[2],10)).slice(-2);m="".concat(w,"-").concat(k,"-").concat(x)}else m=""}else{var N=b.match(l);if(N){var C=N[1],S=s(C),_=C.match(/到达\s*([^，。,\s]+)/)||C.match(/到\s*([^，。,\s]+)/),A=_?_[1]:"";/^\d/.test(A)&&(A=""),v(),d={name:A||"",time:S||"",notes:b,dateStr:m||"",_type:"timeEvent"}}else{var I=b.match(u);I?(v(),d={name:(I[2]||"").trim(),time:"",notes:p||"",dateStr:m||"",_type:"poi"},p=""):d?d.notes=(d.notes?d.notes+"\n":"")+b:p=(p?p+"\n":"")+b}}else v()}return v(),c.filter(function(e){return e.name&&e.name.trim()||"timeEvent"===e._type}).map(function(e){return g(g({},e),{},{name:(e.name||"").replace(/^(周[一二三四五六日天])?/,"").trim()})})},ba=function(e){if(!e)return"";var t=String(e).trim();return t=(t=t.replace(/[，。、“”‘’\(\)（）]/g," ")).replace(/附近|周边|左右|大约|约/g,"").trim(),/^行程事件$/.test(t)?"":t},Ea=function(){var e=(0,o.A)(h().m(function e(n){var a,r,c,i,o,l,u,m,d,f,p,v,g,y,b,E,w,k,x;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:if(a=ba(n)){e.n=1;break}return e.a(2,[]);case 1:if(r={format:"jsonv2",q:a,limit:5,addressdetails:1,namedetails:1,"accept-language":"zh-CN",countrycodes:"cn"},c="",t.current)try{(t.current.getZoom?t.current.getZoom():0)>=9&&(i=t.current.getBounds(),o=i.getWest().toFixed(3),l=i.getEast().toFixed(3),u=i.getNorth().toFixed(3),m=i.getSouth().toFixed(3),r.viewbox="".concat(o,",").concat(u,",").concat(l,",").concat(m),r.bounded=1,c="".concat(m,",").concat(o,",").concat(u,",").concat(l))}catch(e){}if(e.p=2,!("stable"!==Nn()&&Date.now()>(xn.current||0))){e.n=4;break}return e.n=3,j(function(){return F(function(){return s.A.get("https://nominatim.openstreetmap.org/search",{params:r,timeout:1500})},{retries:1,baseDelay:600})});case 3:if(d=e.v,!(f=Array.isArray(d&&d.data)?d.data:[]).length){e.n=4;break}return p=f.slice(0,5).map(function(e){return{source:"nominatim",place_id:String(e.place_id||""),display_name:e.display_name||a,lat:e.lat,lon:e.lon}}),e.a(2,p);case 4:e.n=6;break;case 5:e.p=5,e.v,xn.current=Date.now()+6e5;case 6:if(!c){e.n=11;break}return e.p=7,v=function(e){return String(e).replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}(a),g=' [out:json][timeout:12];\n( node["name:zh"~"'.concat(v,'",i](').concat(c,');\n  way["name:zh"~"').concat(v,'",i](').concat(c,');\n  relation["name:zh"~"').concat(v,'",i](').concat(c,');\n  node["name"~"').concat(v,'",i](').concat(c,');\n  way["name"~"').concat(v,'",i](').concat(c,');\n  relation["name"~"').concat(v,'",i](').concat(c,");\n); out center 20;"),e.n=8,s.A.post("https://overpass-api.de/api/interpreter","data=".concat(encodeURIComponent(g)),{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},timeout:8e3});case 8:if(y=e.v,b=y.data&&y.data.elements||[],!(E=b.slice(0,10).map(function(e){var t=e.tags||{},n=t["name:zh"],a=t.name||n||"未命名",r=null!=e.lat?e.lat:e.center&&e.center.lat,c=null!=e.lon?e.lon:e.center&&e.center.lon;return{source:"overpass",place_id:String(e.id),display_name:n||a,lat:String(r||""),lon:String(c||"")}}).filter(function(e){return e.lat&&e.lon})).length){e.n=9;break}return e.a(2,E);case 9:e.n=11;break;case 10:e.p=10,e.v;case 11:return e.p=11,e.n=12,s.A.get("https://geocoding-api.open-meteo.com/v1/search",{params:{name:a,count:6,language:"zh",format:"json"},timeout:5e3});case 12:return w=e.v,k=w.data&&w.data.results||[],x=k.slice(0,6).map(function(e){return{source:"openmeteo",place_id:String(e.id||""),display_name:[e.name,e.admin1,e.country].filter(Boolean).join(" · "),lat:String(e.latitude),lon:String(e.longitude)}}),e.a(2,x);case 13:return e.p=13,e.v,e.a(2,[])}},e,null,[[11,13],[7,10],[2,5]])}));return function(t){return e.apply(this,arguments)}}(),wa=(0,u.useCallback)(function(e){var t=((e.date||"")+" "+(e.time||"")).trim();return t&&Date.parse(t.replace(/-/g,"/"))||Number.MAX_SAFE_INTEGER},[]),ka=(0,u.useCallback)(function(e){return Oe?e.slice():e.map(function(e,t){return g(g({},e),{},{__idx:t})}).slice().sort(function(e,t){var n=wa(e),a=wa(t);return n===a?e.__idx-t.__idx:n-a})},[Oe,wa]),xa=(0,u.useMemo)(function(){return ka($)},[$,ka]),Na=(0,u.useMemo)(function(){for(var e=$.map(function(){return null}),t=1;t<$.length;t++){var n=$[t-1],a=$[t];n&&a&&!n.unlocated&&!a.unlocated&&isFinite(n.lat)&&isFinite(n.lng)&&isFinite(a.lat)&&isFinite(a.lng)?e[t]=I(n.lat,n.lng,a.lat,a.lng):e[t]=null}return e},[$]);(0,u.useMemo)(function(){for(var e=0,t={},n=1;n<$.length;n++){var a=Na[n];if(a){e+=a;var r=$[n].date||"";t[r]||(t[r]=0),t[r]+=a}}return{total:e,perDay:t}},[$,Na]),(0,u.useEffect)(function(){var e=!1;if(Dt){var t=function(){var t=(0,o.A)(h().m(function t(){var n,a,r,c,i,o;return h().w(function(t){for(;;)switch(t.n){case 0:Ht(""),n=new Array($.length).fill(null),a=[],r=0,c=0,i=h().m(function e(t){var i,o,l,u,m;return h().w(function(e){for(;;)switch(e.n){case 0:if(i=$[t-1],o=$[t],!i.unlocated&&!o.unlocated){e.n=1;break}return e.a(2,0);case 1:if(isFinite(i.lat)&&isFinite(i.lng)&&isFinite(o.lat)&&isFinite(o.lng)){e.n=2;break}return e.a(2,0);case 2:if(l="".concat(i.lat.toFixed(5),",").concat(i.lng.toFixed(5),"|").concat(o.lat.toFixed(5),",").concat(o.lng.toFixed(5)),!(u=Bt.current.get(l))){e.n=3;break}return n[t]=u,e.a(2,0);case 3:m="https://router.project-osrm.org/route/v1/driving/".concat(i.lng,",").concat(i.lat,";").concat(o.lng,",").concat(o.lat,"?overview=false&alternatives=false&steps=false"),c++,a.push(s.A.get(m,{timeout:8e3}).then(function(e){var a=e.data&&e.data.routes,r=a&&a[0]&&a[0].distance,c=r?r/1e3:null;c&&(Bt.current.set(l,c),n[t]=c)}).catch(function(){r++}));case 4:return e.a(2)}},e)}),o=1;case 1:if(!(o<$.length)){t.n=4;break}return t.d(d(i(o)),2);case 2:if(0!==t.v){t.n=3;break}return t.a(3,3);case 3:o++,t.n=1;break;case 4:return t.n=5,Promise.allSettled(a);case 5:e||(Ut(n),c>0&&r/c>=.5?(Ht("OSRM 路线服务当前不可用，已自动降级为直线距离"),Rt(!1)):r>0&&Ht("部分路线计算失败，已使用直线距离降级"));case 6:return t.a(2)}},t)}));return function(){return t.apply(this,arguments)}}();return t(),function(){e=!0}}Ut([])},[$,Dt]);var Ca=(0,u.useMemo)(function(){for(var e=$.map(function(){return null}),t=1;t<$.length;t++){var n=Gt[t],a=Na[t];e[t]=Dt&&isFinite(n)&&n>0?n:a}return e},[$,Gt,Na,Dt]),Sa=(0,u.useMemo)(function(){for(var e=0,t={},n=1;n<$.length;n++){var a=Ca[n];if(a){e+=a;var r=$[n].date||"";t[r]||(t[r]=0),t[r]+=a}}return{total:e,perDay:t}},[$,Ca]),_a=(0,u.useMemo)(function(){var e=new Map;$.forEach(function(t,n){var a=t.date||"未设日期";e.has(a)||e.set(a,[]),e.get(a).push({item:t,index:n})});var t,n=[],a=f(e.entries());try{var r=function(){var e=(0,l.A)(t.value,2),a=e[0],r=e[1],c=0;r.forEach(function(e){var t=e.index;if(t>=1&&$[t].date===a){var n=Ca[t];n&&(c+=n)}});var i=r.map(function(e){return e.item.time}).filter(Boolean).sort(),o=i[0]||"",u=i[i.length-1]||"";n.push({day:a,entries:r,totalKm:c,start:o,end:u})};for(a.s();!(t=a.n()).done;)r()}catch(e){a.e(e)}finally{a.f()}return n.sort(function(e,t){return(e.day||"").localeCompare(t.day||"")}),n},[$,Ca]),Aa=(0,u.useCallback)(function(){Y(function(e){return e.slice().sort(function(e,t){return wa(e)-wa(t)})}),ye("day")},[wa]),Ia=(0,u.useCallback)(function(e,t){Y(function(n){var a=n.findIndex(function(t){return t.id===e});if(a<0)return n;var r=n[a],c=String(r.notes||""),i=/(耗时：)([^。；;，,\n]*)/;i.test(c)?c=c.replace(i,function(e,n){return"".concat(n).concat(t)}):c.trim()?c+=" · 耗时：".concat(t):c="耗时：".concat(t);var o=n.slice();return o[a]=g(g({},r),{},{notes:c}),o})},[]),Ta=(0,u.useCallback)(function(e,t){Y(function(n){return n.map(function(n){return n.date===e?g(g({},n),{},{startOfDay:n.id===t}):n})})},[]),La=(0,u.useCallback)(function(e,t){Y(function(n){return n.map(function(n){return n.date===e?g(g({},n),{},{endOfDay:n.id===t}):n})})},[]);(0,u.useEffect)(function(){if(t.current&&window.L&&p.current){try{p.current.clearLayers()}catch(e){}for(var e=1;e<$.length;e++){var n=$[e-1],a=$[e];if(n&&a&&!n.unlocated&&!a.unlocated&&isFinite(n.lat)&&isFinite(n.lng)&&isFinite(a.lat)&&isFinite(a.lng))try{var r=window.L.polyline([[n.lat,n.lng],[a.lat,a.lng]],{color:"#2952ff",weight:2,opacity:.9,dashArray:"6,6"});p.current.addLayer(r)}catch(e){}}}},[$]);var Oa,Fa=(0,u.useCallback)(function(e,t){Y(function(n){var a=n.findIndex(function(t){return t.id===e});if(a<0)return n;var r=n[a],c=a>0?n[a-1]:null,i=function(e){if(!e)return"";var t=e.split("-"),n=(0,l.A)(t,3),a=(n[0],n[1]),r=n[2];return(a?String(parseInt(a,10)):"")+"月"+(r?String(parseInt(r,10)):"")+"日"}(r.date||""),o=c?I(c.lat,c.lng,r.lat,r.lng):0,u=r.notes||"";c&&"与上个地点直线距离约 ".concat(o.toFixed(1)," km。"),"play"===t?u="".concat(i," 在「").concat(r.name||"此地","」玩什么项目，预计消费 XXX 元。"):"move"===t?u="".concat(i," 从「").concat(c&&c.name||"上个地点","」到「").concat(r.name||"此地","」，直线距离约 ").concat(o.toFixed(1)," km。交通： ，耗时： ，预计消费 XXX 元。"):"stay"===t&&(u="".concat(i," 在「").concat(r.name||"此地","」入住酒店（名称： ），预计消费 XXX 元。"));var s=n.slice();return s[a]=g(g({},r),{},{notes:u}),s})},[]);return u.createElement("div",{className:"jihua-page"},u.createElement("header",{className:"jihua-header"},u.createElement("div",{className:"controls-primary"},u.createElement("div",{className:"brand"},"旅行计划"),u.createElement("button",{className:"icon-btn ".concat(fe?"active":""),title:"就近优先（按当前地图范围搜索）",onClick:function(){return pe(function(e){return!e})}},fe?"就近":"全局"),u.createElement("select",{className:"tile-select","aria-label":"瓦片源",value:pt,onChange:function(e){return vt(e.target.value)},disabled:!O},u.createElement("option",{value:"amap"},"高德(道路-深色)"),u.createElement("option",{value:"esriStreet"},"Esri街道"),u.createElement("option",{value:"esriImagery"},"Esri影像"),u.createElement("option",{value:"default"},"OSM"),C()?u.createElement("option",{value:"tdtVec"},"天地图-矢量"):null,C()?u.createElement("option",{value:"tdtImg"},"天地图-影像"):null,_().customTile.url?u.createElement("option",{value:"custom"},"自定义瓦片"):null),u.createElement("div",{className:"search-wrap",style:{position:"relative",minWidth:220,flex:"0 1 340px"}},u.createElement("input",{disabled:!O,className:"search-input",style:{width:"100%"},placeholder:"搜索地点（输入≥2个字）回车或停顿触发","aria-label":"搜索地点",value:ue,onChange:function(e){return t=e.target.value,se(t),fa(-1),va.current&&clearTimeout(va.current),void(va.current=setTimeout(function(){return pa(t)},140));var t},onKeyDown:function(e){var t=Math.min(et.length,rt);return"ArrowDown"===e.key?(e.preventDefault(),void(t&&fa(function(e){return Math.min(e+1,t-1)}))):"ArrowUp"===e.key?(e.preventDefault(),void(t&&fa(function(e){return Math.max(e-1,0)}))):"Enter"===e.key?(e.preventDefault(),void(da>=0&&da<t?ga(et[da]):pa(ue))):"Escape"===e.key?(tt([]),void fa(-1)):void 0}}),String(ue||"").trim().length>=2&&u.createElement("div",{className:"suggestions",role:"listbox","aria-label":"搜索建议列表",style:{position:"absolute",top:"calc(100% + 4px)",left:0,right:0,zIndex:4e3,maxHeight:"40vh",overflowY:"auto"}},la&&u.createElement("div",{className:"suggestion-item"},"搜索中…"),et.slice(0,rt).map(function(e,n){return u.createElement("div",{key:(e.place_id||e.osm_id||"".concat(e.lat,",").concat(e.lon,",").concat(e.display_name||""))+"#".concat(n),className:"suggestion-item ".concat(n===da?"selected":""),role:"option","aria-selected":n===da,onClick:(0,o.A)(h().m(function t(){return h().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,ga(e);case 1:return t.a(2)}},t)}))},u.createElement("div",{className:"sugg-title"},e.display_name),t.current?u.createElement("div",{className:"sugg-meta"},function(){try{var n=t.current.getCenter(),a=parseFloat(e.lat)-n.lat,r=parseFloat(e.lon)-n.lng,c=111*Math.sqrt(r*r+a*a);return"".concat(c.toFixed(1)," km")}catch(e){return""}}()):null)}),!la&&0===et.length&&u.createElement("div",{className:"suggestion-item"},"无搜索结果"))),u.createElement("button",{className:"icon-btn",style:{position:"relative",zIndex:5001},title:"定位当前位置",onClick:function(){tt([]),navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){var n=e.coords,a=n.latitude,r=n.longitude;t.current&&t.current.setView([a,r],14)},function(){return ne("定位失败，请检查权限")}):ne("当前浏览器不支持定位")}},"定位当前位置"),u.createElement("span",{className:"spacer"}),u.createElement("button",{"aria-label":"更多",className:"icon-btn",onClick:function(){return ke(function(e){return!e})}},we?"收起":"更多")),we&&u.createElement("div",{className:"controls-more"},u.createElement("div",{className:"controls-col"},u.createElement("div",{className:"view-toggle"},u.createElement("button",{className:"icon-btn ".concat("list"===he?"active":""),onClick:function(){return ye("list")}},"列表"),u.createElement("button",{className:"icon-btn ".concat("timeline"===he?"active":""),onClick:function(){return ye("timeline")}},"时间轴"),u.createElement("button",{className:"icon-btn ".concat("day"===he?"active":""),onClick:function(){return ye("day")}},"按天"),"timeline"===he?u.createElement("button",{className:"icon-btn",onClick:function(){Y(function(e){return ka(e)}),Fe(!1)},title:"按时间排序"},"按时间排序"):null,u.createElement("button",{className:"icon-btn",onClick:Aa,title:"按日期时间排序并切换按天视图"},"按日期排序"),u.createElement("button",{className:"icon-btn ".concat(Dt?"active":""),onClick:function(){return Rt(function(e){return!e})},title:"路线型距离（OSRM）"},"路线距离")),u.createElement("div",{style:{display:"flex",alignItems:"center",gap:8}},u.createElement("span",{style:{color:"#6b7280"}},"地图高度"),u.createElement("input",{type:"range",min:200,max:Math.round(.8*window.innerHeight),value:Ce,onChange:function(e){return Se(parseInt(e.target.value||"0",10)||Ce)}}),u.createElement("span",{style:{minWidth:36,textAlign:"right"}},Math.round(Ce),"px")),u.createElement("div",{style:{display:"flex",alignItems:"center",gap:8}},u.createElement("span",{style:{color:"#6b7280"}},"建议条数"),u.createElement("select",{value:rt,onChange:function(e){var t=parseInt(e.target.value||"5",10);ct([3,5,8].includes(t)?t:5)}},u.createElement("option",{value:3},"3"),u.createElement("option",{value:5},"5"),u.createElement("option",{value:8},"8")))))),u.createElement("div",{className:"map-container",ref:e,"aria-label":"地图"}),u.createElement("div",{className:"splitter",onPointerDown:function(e){_e.current=!0,Ae.current=e.clientY||0,Ie.current=Ce,document.body.style.userSelect="none";try{e.currentTarget.setPointerCapture&&e.currentTarget.setPointerCapture(e.pointerId)}catch(e){}var n=function(e){if(_e.current){var n=(e.clientY||0)-Ae.current,a=Ie.current+n,r=Math.max(120,window.innerHeight-220);a<120&&(a=120),a>r&&(a=r),Se(a),t.current&&t.current.invalidateSize()}},a=function(){_e.current=!1,document.body.style.userSelect="",window.removeEventListener("pointermove",n,!0),window.removeEventListener("pointerup",a,!0),t.current&&setTimeout(function(){return t.current.invalidateSize()},50)};window.addEventListener("pointermove",n,!0),window.addEventListener("pointerup",a,!0)},title:"拖动调整地图高度"}),u.createElement("section",{className:"sheet paper"},u.createElement("div",{className:"sheet-header"},u.createElement("input",{className:"plan-name",value:W,onChange:function(e){return q(e.target.value)},placeholder:"计划名称"}),u.createElement("div",{className:"actions",style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"}},u.createElement("button",{className:"btn",onClick:function(){$.length?window.confirm("确认新建并清空当前编辑内容？")&&qn():qn()}},"新建"),u.createElement("button",{className:"btn",onClick:Wn,disabled:Ln},Ln?"保存中…":"保存"),u.createElement("button",{className:"btn",onClick:function(){return Et(!0)}},"物资清单"),u.createElement("button",{className:"icon-btn",onClick:function(){return Qt(function(e){return!e})},"aria-expanded":Kt},Kt?"收起":"更多"),Kt&&u.createElement(u.Fragment,null,u.createElement("button",{className:"btn danger",onClick:Vn,disabled:Fn},Fn?"删除中…":"删除"),u.createElement("button",{className:"btn",onClick:function(){return function(e,t,n){var a=[];a.push("计划名称: "+(e||"未命名")),a.push("");for(var r=0;r<t.length;r++){var c=t[r];if(a.push(r+1+". "+(c.name||"未命名地点")),a.push(("   时间: "+(c.date||"")+" "+(c.time||"")).trim()),a.push("   坐标: "+c.lat+", "+c.lng),r>=1){var i=n&&n[r];i&&a.push("   与上个地点距离: "+i.toFixed(1)+" km")}c.notes&&a.push("   备注: "+c.notes)}var o=new Blob([a.join("\n")],{type:"text/plain;charset=utf-8"}),l=URL.createObjectURL(o),u=document.createElement("a");u.href=l,u.download=(e||"旅行计划").replace(/[\\/:*?"<>|]/g,"_")+".txt",u.click(),URL.revokeObjectURL(l)}(W,$,Ca)}},"导出TXT"),u.createElement("button",{className:"btn",onClick:function(){return function(e,t,n){var a=[];a.push("# ".concat(e||"旅行计划")),a.push(""),t.forEach(function(e){a.push("## ".concat(e.day||"未设日期","  · 当天总距离 ").concat(e.totalKm.toFixed(1)," km · 起止 ").concat(e.start||"").concat(e.end?" - "+e.end:"")),e.entries.forEach(function(e){var t=e.item,r=e.index,c=n&&n[r];a.push("- ".concat(r+1,". ").concat(t.date||""," ").concat(t.time||""," · ").concat(t.name||"").concat(c?" · 距上个 ".concat(c.toFixed(1)," km"):"")),a.push("  - 坐标: ".concat(t.lat,", ").concat(t.lng)),t.notes&&a.push("  - 备注: ".concat(t.notes))}),a.push("")});var r=new Blob([a.join("\n")],{type:"text/markdown;charset=utf-8"}),c=URL.createObjectURL(r),i=document.createElement("a");i.href=c,i.download=(e||"旅行计划").replace(/[\\/:*?"<>|]/g,"_")+".md",i.click(),URL.revokeObjectURL(c)}(W,_a,Ca)}},"导出MD"),u.createElement("button",{className:"btn",onClick:function(){return function(e,t,n){for(var a=[["序号","日期","时间","名称","纬度","经度","距上个(km)","备注"]],r=0;r<t.length;r++){var c=t[r],i=n&&n[r];a.push([String(r+1),c.date||"",c.time||"",(c.name||"").replace(/\n/g," "),String(c.lat),String(c.lng),i?i.toFixed(1):"",(c.notes||"").replace(/\n/g," ")])}var o=a.map(function(e){return e.map(function(e){return'"'.concat(String(e).replace(/"/g,'""'),'"')}).join(",")}).join("\n"),l=new Blob([o],{type:"text/csv;charset=utf-8"}),u=URL.createObjectURL(l),s=document.createElement("a");s.href=u,s.download=(e||"旅行计划").replace(/[\\/:*?"<>|]/g,"_")+".csv",s.click(),URL.revokeObjectURL(u)}(W,$,Ca)}},"导出CSV"),u.createElement("button",{className:"btn",onClick:function(){return function(e,t){if(Array.isArray(t)&&t.length){var n=t.slice().sort(function(e,t){var n=e.date||"",a=t.date||"";return n!==a?n<a?-1:1:(e.time||"")<(t.time||"")?-1:1}).reduce(function(e,t){var n=t.date||"";return(e[n]=e[n]||[]).push(t),e},{}),a=["日","一","二","三","四","五","六"],r=function(e){if(!e)return"";var t=e.match(/^(\d{1,2}):(\d{2})$/);return t?"".concat(parseInt(t[1],10),"点").concat(t[2]):e},c=[];e&&c.push(e),Object.keys(n).sort().forEach(function(e){c.push(""),c.push(function(e){if(!e)return"";try{var t=new Date(e.replace(/-/g,"/")),n=t.getMonth()+1,r=t.getDate();return"".concat(n,"月").concat(r,"日周").concat(a[t.getDay()])}catch(t){return e}}(e));var t,i=1,o=f(n[e]);try{for(o.s();!(t=o.n()).done;){var l=t.value;"timeEvent"!==(l._type||"poi")?l.name&&(c.push("".concat(i++,"，").concat(l.name)),l.notes&&c.push(String(l.notes).trim())):(l.notes&&/^时间[:：]/.test(String(l.notes))?c.push(String(l.notes)):l.time&&l.name?c.push("时间：".concat(r(l.time),"到达").concat(l.name)):l.time&&c.push("时间：".concat(r(l.time))),l.notes&&!/^时间[:：]/.test(String(l.notes))&&c.push(String(l.notes).trim()))}}catch(e){o.e(e)}finally{o.f()}});var i=new Blob([c.join("\n")],{type:"text/plain;charset=utf-8"}),o=URL.createObjectURL(i),l=document.createElement("a");l.href=o,l.download=((e||"旅行计划")+"-行程文案.txt").replace(/[\\/:*?\"<>|]/g,"_"),l.click(),URL.revokeObjectURL(o)}else alert("没有内容可导出")}(W,$)}},"导出行程文案"),u.createElement("button",{className:"btn",onClick:function(){return en(!0)}},"从文本导入(Beta)")))),u.createElement("div",{className:"plans-bar",style:{display:"flex",gap:8,alignItems:"center"}},u.createElement("button",{className:"btn",onClick:Un,disabled:An},An?"加载中…":"刷新计划"),u.createElement("select",{className:"plan-select",onChange:function(e){return Bn(e.target.value)},value:Z||""},u.createElement("option",{value:"",disabled:!0},"选择已有计划"),(_n||[]).map(function(e){return u.createElement("option",{key:e.id,value:e.id},e.name)})),u.createElement("div",{style:{marginLeft:"auto",display:"flex",gap:8}},u.createElement("button",{className:"btn",disabled:At,onClick:(0,o.A)(h().m(function e(){var t,n;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:It(!0),Ft({done:0,total:$.length}),e.p=1,t=h().m(function e(){var t,a;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:if(!(t=$[n])||t.city&&t.province&&t.nameLocal){e.n=5;break}return e.p=1,e.n=2,Gn(t.lat,t.lng);case 2:a=e.v,Y(function(e){return e.map(function(e){return e.id===t.id?g(g({},e),{},{name:a.cn||e.name,nameLocal:a.local||e.nameLocal||"",city:a.city||e.city||"",province:a.province||e.province||"",country:a.country||e.country||""}):e})}),e.n=4;break;case 3:e.p=3,e.v;case 4:return e.n=5,new Promise(function(e){return setTimeout(e,380)});case 5:Ft({done:n+1,total:$.length});case 6:return e.a(2)}},e,null,[[1,3]])}),n=0;case 2:if(!(n<$.length)){e.n=4;break}return e.d(d(t()),3);case 3:n++,e.n=2;break;case 4:return e.p=4,It(!1),e.f(4);case 5:return e.a(2)}},e,null,[[1,,4,5]])}))},At?"补全中 ".concat(Ot.done,"/").concat(Ot.total):"一键补全地名"))),we&&u.createElement("div",{className:"plans-bar"},u.createElement("div",{style:{display:"flex",gap:8,flexWrap:"wrap",width:"100%"}},u.createElement("div",{style:{display:"flex",alignItems:"center",gap:6}},u.createElement("span",{style:{color:"#6b7280"}},"地图高度"),u.createElement("input",{type:"range",min:200,max:Math.round(.8*window.innerHeight),value:Ce,onChange:function(e){return Se(parseInt(e.target.value||"0",10)||Ce)}}),u.createElement("span",{style:{minWidth:36,textAlign:"right"}},Math.round(Ce),"px")),u.createElement("div",{style:{marginLeft:"auto"}},u.createElement("button",{className:"icon-btn ".concat(fe?"active":""),title:"就近优先（按当前地图范围搜索）",onClick:function(){return pe(function(e){return!e})}},fe?"就近":"全局"),u.createElement("button",{className:"icon-btn ".concat(Dt?"active":""),onClick:function(){return Rt(function(e){return!e})},title:"路线型距离（OSRM）"},"路线距离")))),te?u.createElement("div",{className:"error"},te):null,In?u.createElement("div",{className:"error"},In):null,jn?u.createElement("div",{className:"error"},jn):null,On?u.createElement("div",{className:"error"},On):null,Mn?u.createElement("div",{className:"error"},Mn):null,"list"===he?u.createElement("ul",{className:"item-list"},$.map(function(e,t){return u.createElement("li",{className:"item",key:e.id,draggable:!0,onDragStart:function(){return ie(t)},onDragOver:function(e){return e.preventDefault()},onDrop:function(){Pn(ce,t),ie(null)}},u.createElement("div",{className:"item-line"},u.createElement("div",{className:"index"},t+1),u.createElement("button",{className:"icon-btn",title:e.fav?"取消收藏":"收藏",onClick:function(){return zn(e.id,"fav",!e.fav)}},e.fav?"★":"☆"),u.createElement("input",{className:"item-name",value:e.name,onChange:function(t){return zn(e.id,"name",t.target.value)},placeholder:"地点名称/备注"}),e.nameLocal&&u.createElement("span",{style:{color:"#6b7280",fontSize:12,marginLeft:6}},"(",e.nameLocal,")"),u.createElement("select",{className:"icon-btn",onChange:function(t){return Fa(e.id,t.target.value)},defaultValue:""},u.createElement("option",{value:"",disabled:!0},"备注模板"),u.createElement("option",{value:"play"},"游玩"),u.createElement("option",{value:"move"},"移动"),u.createElement("option",{value:"stay"},"住宿")),u.createElement("select",{className:"icon-btn",onChange:function(t){var n=t.target.value;n&&(Ia(e.id,n),t.target.value="")},defaultValue:""},u.createElement("option",{value:"",disabled:!0},"预计时长"),u.createElement("option",{value:"30分钟"},"30分钟"),u.createElement("option",{value:"1小时"},"1小时"),u.createElement("option",{value:"2小时"},"2小时"),u.createElement("option",{value:"半天"},"半天"),u.createElement("option",{value:"全天"},"全天")),u.createElement("div",{className:"move"},u.createElement("button",{className:"icon-btn",onClick:function(){return Rn(t,-1)},disabled:0===t},"↑"),u.createElement("button",{className:"icon-btn",onClick:function(){return Rn(t,1)},disabled:t===$.length-1},"↓")),u.createElement("button",{className:"icon-btn danger",onClick:function(){return Hn(e.id)}},"✕")),u.createElement("div",{className:"item-line"},u.createElement("input",{type:"date",className:"date-input",value:e.date||"",onChange:function(t){return zn(e.id,"date",t.target.value)}}),u.createElement("input",{type:"time",className:"time-input",value:e.time||"",onChange:function(t){return zn(e.id,"time",t.target.value)}}),e.unlocated?u.createElement("div",{className:"coords",style:{color:"#ef4444"}},"未定位",u.createElement("button",{className:"icon-btn",style:{marginLeft:8},onClick:function(){kn.current=e.id,alert("请在地图上点选一个位置，来放置："+(e.name||"此条目"))}},"在地图上放置")):u.createElement("div",{className:"coords"},isFinite(e.lat)&&isFinite(e.lng)?"".concat(e.lat.toFixed(5),", ").concat(e.lng.toFixed(5)):"",Ca[t]?" · 距上个 ".concat(Ca[t].toFixed(1)," km · 建议：").concat(T(Ca[t],$[t-1],e)):"")),u.createElement("textarea",(0,r.A)({className:"notes",rows:2,value:e.notes||"",onChange:function(t){return zn(e.id,"notes",t.target.value)},placeholder:"备注"},Kn(e.id))))})):"timeline"===he?u.createElement("div",{className:"timeline"},xa.map(function(e,t){return u.createElement("div",{key:e.id,className:"timeline-item",draggable:!0,onDragStart:function(){return Re(t)},onDragOver:function(e){return e.preventDefault()},onDrop:function(){null!=De&&(Y(function(e){var n=ka(e).map(function(e){return e.id}),a=De,r=t;if(a<0||a>=n.length||r<0||r>=n.length)return e;var c=n.splice(a,1),i=(0,l.A)(c,1)[0];n.splice(r,0,i);var o=new Map(e.map(function(e){return[e.id,e]}));return n.map(function(e){return o.get(e)}).filter(Boolean)}),Fe(!0),Re(null))}},u.createElement("div",{className:"timeline-left"},u.createElement("div",{className:"timeline-dot"}),u.createElement("div",{className:"timeline-line"})),u.createElement("div",{className:"timeline-content"},u.createElement("div",{className:"timeline-title"},u.createElement("span",{className:"index"},t+1),u.createElement("input",{className:"item-name",value:e.name,onChange:function(t){return zn(e.id,"name",t.target.value)}}),e.nameLocal&&u.createElement("span",{style:{color:"#6b7280",fontSize:12,marginLeft:6}},"(",e.nameLocal,")"),u.createElement("div",{className:"move"},u.createElement("button",{className:"icon-btn",onClick:function(){Y(function(e){var n=ka(e).map(function(e){return e.id}),a=t,r=t-1;if(a<=0)return e;var c=n.splice(a,1),i=(0,l.A)(c,1)[0];n.splice(r,0,i);var o=new Map(e.map(function(e){return[e.id,e]}));return n.map(function(e){return o.get(e)}).filter(Boolean)}),Fe(!0)},disabled:0===t},"↑"),u.createElement("button",{className:"icon-btn",onClick:function(){Y(function(e){var n=ka(e).map(function(e){return e.id}),a=t,r=t+1;if(a>=n.length-1)return e;var c=n.splice(a,1),i=(0,l.A)(c,1)[0];n.splice(r,0,i);var o=new Map(e.map(function(e){return[e.id,e]}));return n.map(function(e){return o.get(e)}).filter(Boolean)}),Fe(!0)},disabled:t===xa.length-1},"↓")),u.createElement("button",{className:"icon-btn danger",onClick:function(){return Hn(e.id)}},"✕")),u.createElement("div",{className:"timeline-meta"},u.createElement("input",{type:"date",className:"date-input",value:e.date||"",onChange:function(t){return zn(e.id,"date",t.target.value)}}),u.createElement("input",{type:"time",className:"time-input",value:e.time||"",onChange:function(t){return zn(e.id,"time",t.target.value)}}),e.unlocated?u.createElement("span",{className:"coords",style:{color:"#ef4444"}},"未定位",u.createElement("button",{className:"icon-btn",style:{marginLeft:8},onClick:function(){kn.current=e.id,alert("请在地图上点选一个位置，来放置："+(e.name||"此条目"))}},"在地图上放置")):u.createElement("span",{className:"coords"},isFinite(e.lat)&&isFinite(e.lng)?"".concat(e.lat.toFixed(5),", ").concat(e.lng.toFixed(5)):"",Ca[$.indexOf(e)]?" · 距上个 ".concat(Ca[$.indexOf(e)].toFixed(1)," km · 建议：").concat(T(Ca[$.indexOf(e)],$[$.indexOf(e)-1],e)):"")),u.createElement("textarea",(0,r.A)({className:"notes",rows:2,value:e.notes||"",onChange:function(t){return zn(e.id,"notes",t.target.value)},placeholder:"备注"},Kn(e.id)))))})):u.createElement("div",{className:"day-groups"},u.createElement("div",{className:"day-picker"},_a.map(function(e){var t=S().date,n=e.day===t,a=e.entries.some(function(e){return!!e.item.fav});return u.createElement("button",{key:e.day,className:"day-chip ".concat(n?"today":""," ").concat(a?"hasFav":""),onClick:function(){var t=document.getElementById("day-"+e.day);t&&t.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},onMouseDown:function(){mt.current&&clearTimeout(mt.current),mt.current=setTimeout(function(){return aa(e.day)},600)},onMouseUp:function(){mt.current&&clearTimeout(mt.current)},onMouseLeave:function(){mt.current&&clearTimeout(mt.current)},onTouchStart:function(){mt.current&&clearTimeout(mt.current),mt.current=setTimeout(function(){return aa(e.day)},600)},onTouchEnd:function(){mt.current&&clearTimeout(mt.current)},onTouchMove:function(){mt.current&&clearTimeout(mt.current)}},e.day,a?u.createElement("span",{className:"badge","aria-hidden":"true"}):null)})),_a.map(function(e){return u.createElement("div",{key:e.day,className:"day-section",id:"day-"+e.day},u.createElement("div",{className:"item-line",style:{fontWeight:600}},u.createElement("div",{className:"index"},e.day),u.createElement("div",{style:{marginLeft:8}},"当天总距离：",e.totalKm.toFixed(1)," km"),u.createElement("div",{style:{marginLeft:"auto"}},"起止：",e.start||"-",e.end?" - "+e.end:""),u.createElement("div",{style:{marginLeft:12,display:"flex",gap:6}},u.createElement("button",{className:"icon-btn",onClick:function(){return Jn(e.day)}},"导出GeoJSON"),u.createElement("button",{className:"icon-btn",onClick:function(){return ea(e.day)}},"导出GPX"),u.createElement("button",{className:"icon-btn",onClick:function(){return na(e.day)}},"导出图片"))),u.createElement("ul",{className:"item-list"},e.entries.map(function(t){var n=t.item,a=t.index;return u.createElement("li",{className:"item",key:n.id,draggable:!0,onDragStart:function(){return ie(a)},onDragOver:function(e){return e.preventDefault()},onDrop:function(){Pn(ce,a),ie(null)}},u.createElement("div",{className:"item-line"},u.createElement("div",{className:"index"},a+1,n.startOfDay?" · 起点":"",n.endOfDay?" · 终点":""),u.createElement("input",{className:"item-name",value:n.name,onChange:function(e){return zn(n.id,"name",e.target.value)},placeholder:"地点名称/备注"}),n.nameLocal&&u.createElement("span",{style:{color:"#6b7280",fontSize:12,marginLeft:6}},"(",n.nameLocal,")"),u.createElement("button",{className:"icon-btn",onClick:function(){return Ta(e.day,n.id)}},"设为起点"),u.createElement("button",{className:"icon-btn",onClick:function(){return La(e.day,n.id)}},"设为终点"),u.createElement("select",{className:"icon-btn",onChange:function(e){return Fa(n.id,e.target.value)},defaultValue:""},u.createElement("option",{value:"",disabled:!0},"备注模板"),u.createElement("option",{value:"play"},"游玩"),u.createElement("option",{value:"move"},"移动"),u.createElement("option",{value:"stay"},"住宿")),u.createElement("select",{className:"icon-btn",onChange:function(e){var t=e.target.value;t&&(Ia(n.id,t),e.target.value="")},defaultValue:""},u.createElement("option",{value:"",disabled:!0},"预计时长"),u.createElement("option",{value:"30分钟"},"30分钟"),u.createElement("option",{value:"1小时"},"1小时"),u.createElement("option",{value:"2小时"},"2小时"),u.createElement("option",{value:"半天"},"半天"),u.createElement("option",{value:"全天"},"全天")),u.createElement("button",{className:"icon-btn danger",onClick:function(){return Hn(n.id)}},"✕")),u.createElement("div",{className:"item-line"},u.createElement("input",{type:"date",className:"date-input",value:n.date||"",onChange:function(e){return zn(n.id,"date",e.target.value)}}),u.createElement("input",{type:"time",className:"time-input",value:n.time||"",onChange:function(e){return zn(n.id,"time",e.target.value)}}),n.unlocated?u.createElement("div",{className:"coords",style:{color:"#ef4444"}},"未定位",u.createElement("button",{className:"icon-btn",style:{marginLeft:8},onClick:function(){kn.current=n.id,alert("请在地图上点选一个位置，来放置："+(n.name||"此条目"))}},"在地图上放置")):u.createElement("div",{className:"coords"},isFinite(n.lat)&&isFinite(n.lng)?"".concat(n.lat.toFixed(5),", ").concat(n.lng.toFixed(5)):"",Ca[a]?" · 距上个 ".concat(Ca[a].toFixed(1)," km · 建议：").concat(T(Ca[a],$[a-1],n)):"")),u.createElement("textarea",(0,r.A)({className:"notes",rows:2,value:n.notes||"",onChange:function(e){return zn(n.id,"notes",e.target.value)},placeholder:"备注"},Kn(n.id))))})))})),u.createElement("div",{className:"stats-bar"},u.createElement("div",null,"总距离：",Sa.total.toFixed(1)," km"),Object.keys(Sa.perDay).length>0&&u.createElement("div",{className:"stats-days"},Object.entries(Sa.perDay).map(function(e){var t=(0,l.A)(e,2),n=t[0],a=t[1];return u.createElement("span",{key:n,className:"stats-day"},n||"未设日期","：",a.toFixed(1)," km")})),Vt&&u.createElement("div",{className:"warning-bar"},Vt))),u.createElement("style",null,".map-container{height:".concat(Ce,"px}")),bt&&u.createElement("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,.35)",zIndex:1e4,display:"flex",alignItems:"center",justifyContent:"center"},onClick:function(){return Et(!1)}},u.createElement("div",{className:"paper-card",style:{width:"min(720px,92vw)",maxHeight:"80vh",display:"flex",flexDirection:"column"},onClick:function(e){return e.stopPropagation()}},u.createElement("div",{className:"paper-header",style:{display:"flex",alignItems:"center",padding:"12px 14px"}},u.createElement("div",{style:{fontWeight:700,letterSpacing:1}},"旅行备忘录"),u.createElement("div",{style:{marginLeft:"auto",display:"flex",gap:8}},u.createElement("select",{className:"icon-btn","aria-label":"模板库",defaultValue:"",onChange:function(e){var t=e.target.value;t&&(Nt(function(e){switch(e){case"domestic":return["证件：身份证/驾驶证","交通：机票/火车票/公交卡","支付：现金/银行卡/移动支付","衣物：换洗衣物/外套/雨具","洗护：牙刷牙膏/洗面奶/毛巾/护肤","药品：感冒药/肠胃药/晕车药/创可贴","电子：手机/充电宝/充电器/耳机","其他：水杯/太阳镜/防晒/伞/口罩"].map(function(e){return"- "+e}).join("\n");case"abroad":return["证件：护照/签证/行程单/保险","支付：双币信用卡/部分现金","通讯：境外流量卡/随身WiFi","电源：万能转换插头/排插","语言：常用语/离线地图","衣物：换洗衣物/外套/雨具","洗护：牙刷牙膏/洗面奶/毛巾","药品：感冒药/肠胃药/创可贴/常备药","其他：水杯/太阳镜/防晒/伞"].map(function(e){return"- "+e}).join("\n");case"hiking":return["背包/登山杖/头灯","保暖：速干衣/抓绒/冲锋衣","鞋袜：登山鞋/备用袜子/护膝","饮食：水/能量棒/压缩饼干","导航：离线地图/GPS/指南针","防晒/防蚊","简易医药包","应急：太空毯/哨子/打火机"].map(function(e){return"- "+e}).join("\n");case"camp":return["帐篷/防潮垫/睡袋","照明：营灯/头灯","炊具：炉头/气罐/打火机/锅具","食品：即食/调料/水","工具：小刀/胶带/绳子","卫生：纸巾/湿巾/垃圾袋","保暖：外套/毛毯","其他：驱蚊/防晒/药品"].map(function(e){return"- "+e}).join("\n");default:return Qn()}}(t)),e.target.value="")}},u.createElement("option",{value:"",disabled:!0},"模板库"),u.createElement("option",{value:"domestic"},"国内城市"),u.createElement("option",{value:"abroad"},"国外出行"),u.createElement("option",{value:"hiking"},"徒步/登山"),u.createElement("option",{value:"camp"},"露营/自驾")),u.createElement("select",{className:"icon-btn","aria-label":"我的模板",value:Qe,onChange:function(e){return $e(e.target.value)},style:{minWidth:120}},u.createElement("option",{value:""},"我的模板"),He.map(function(e){return u.createElement("option",{key:e.name,value:e.name},e.name)})),u.createElement("button",{className:"icon-btn",disabled:!Qe,onClick:function(){var e=He.find(function(e){return e.name===Qe});e&&Nt(e.text||"")}},"应用"),u.createElement("button",{className:"icon-btn",onClick:$n},"保存为模板"),u.createElement("button",{className:"icon-btn danger",disabled:!Qe,onClick:Yn},"删除模板"),u.createElement("button",{className:"icon-btn",onClick:function(){Nt(Qn())}},"基础模板"),u.createElement("button",{className:"icon-btn",onClick:function(){return Et(!1)}},"关闭"))),u.createElement("textarea",{style:{flex:1,minHeight:240,border:"none",outline:"none",padding:14,background:"transparent",fontFamily:'"Courier New", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas',lineHeight:"1.6"},value:xt,onChange:function(e){return Nt(e.target.value)},placeholder:"出行备忘示例:\n- 证件：身份证/护照/签证\n- 电子：手机/充电宝/充电器/数据线\n- 衣物：外套/换洗衣物/雨具\n- 洗护：牙刷牙膏/洗面奶/毛巾\n- 药品：感冒药/肠胃药/创可贴\n- 其他：水杯/太阳镜/防晒/伞"}))),Jt&&u.createElement("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,.35)",zIndex:1e4,display:"flex",alignItems:"center",justifyContent:"center"},onClick:function(){return en(!1)}},u.createElement("div",{className:"paper-card",style:{width:"min(860px,94vw)",maxHeight:"84vh",display:"flex",flexDirection:"column"},onClick:function(e){return e.stopPropagation()}},u.createElement("div",{className:"paper-header",style:{display:"flex",alignItems:"center",gap:10,padding:"12px 14px"}},u.createElement("div",{style:{fontWeight:700}},"从文本导入（Beta）"),u.createElement("div",{style:{marginLeft:"auto",display:"flex",gap:8,alignItems:"center"}},u.createElement("label",{style:{color:"#6b7280"}},"Day1日期"),u.createElement("input",{type:"date",value:ln,onChange:function(e){return un(e.target.value)}}),u.createElement("button",{className:"icon-btn",disabled:gn||!an.trim(),onClick:(0,o.A)(h().m(function e(){var t,n,a,r,c;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:return hn(!0),e.p=1,t=ya(an),n=ln||"",a=0,r=t.map(function(e){if(!e.dateStr&&n){new Date(n.replace(/-/g,"/"));var t="D".concat(a+1);return a++,g(g({},e),{},{dayIndex:a-1,dateStr:"",tag:t})}return g(g({},e),{},{dayIndex:0})}),fn(r.map(function(e){return{name:e.name,time:e.time||"",notes:e.notes||"",dayIndex:e.dayIndex||0,_type:e._type||"poi",candidates:[],selectedIdx:-1}})),wn(!0),c=r.map(function(){var e=(0,o.A)(h().m(function e(t,n){var a,r,c,i,o,l,u,s,m;return h().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,"timeEvent"!==(t._type||"poi")){e.n=1;break}return e.a(2);case 1:if(a=ba(t.name||"")){e.n=2;break}return e.a(2);case 2:return e.n=3,Ea(a);case 3:r=e.v,c=[],i=f(r),e.p=4,i.s();case 5:if((o=i.n()).done){e.n=11;break}return l=o.value,u=l.display_name||"",e.p=6,e.n=7,Gn(parseFloat(l.lat),parseFloat(l.lon));case 7:s=e.v,u=s.cn||u,e.n=9;break;case 8:e.p=8,e.v;case 9:c.push(g(g({},l),{},{display_name:u}));case 10:e.n=5;break;case 11:e.n=13;break;case 12:e.p=12,m=e.v,i.e(m);case 13:return e.p=13,i.f(),e.f(13);case 14:fn(function(e){var t=e.slice();return t[n]&&(t[n]=g(g({},t[n]),{},{candidates:c,selectedIdx:c.length?0:-1})),t}),e.n=16;break;case 15:e.p=15,e.v;case 16:return e.a(2)}},e,null,[[6,8],[4,12,13,14],[0,15]])}));return function(t,n){return e.apply(this,arguments)}}()),e.n=2,Promise.allSettled(c);case 2:return e.p=2,hn(!1),wn(!1),e.f(2);case 3:return e.a(2)}},e,null,[[1,,2,3]])}))},"解析"),u.createElement("button",{className:"icon-btn",disabled:!dn.length||En,onClick:(0,o.A)(h().m(function e(){var n,r,c,i,o,l,u,s,m,d,p,g;return h().w(function(e){for(;;)switch(e.n){case 0:n=ln||S().date,r=function(e,t){var n=new Date(e.replace(/-/g,"/"));n.setDate(n.getDate()+t);var a=function(e){return e<10?"0"+e:String(e)};return"".concat(n.getFullYear(),"-").concat(a(n.getMonth()+1),"-").concat(a(n.getDate()))},c=[],i=f(dn);try{for(i.s();!(o=i.n()).done;)l=o.value,u=r(n,l.dayIndex||0),(s=l.candidates&&l.candidates.length?l.selectedIdx>=0?l.candidates[l.selectedIdx]:l.candidates[0]:null)?(m={id:x(),placeId:String(s.place_id||""),name:s.display_name||l.name||"未命名",nameLocal:"",city:"",province:"",country:"",lat:parseFloat(s.lat),lng:parseFloat(s.lon),date:u,time:l.time||"",notes:l.notes||""},c.push(m)):"poi"===(l._type||"poi")&&l.name&&(d=t.current?t.current.getCenter():{lat:N.lat,lng:N.lng},p={id:x(),placeId:"",name:l.name,nameLocal:"",city:"",province:"",country:"",lat:d.lat,lng:d.lng,date:u,time:l.time||"",notes:(l.notes?l.notes+"\n":"")+"（未定位：请点击‘在地图上放置’）",unlocated:!0},c.push(p))}catch(e){i.e(e)}finally{i.f()}if(c.length){e.n=1;break}return alert("没有可导入的条目"),e.a(2);case 1:return e.n=2,ha(an,c);case 2:if(g=e.v,X(null),q(g),a.current&&a.current.clearLayers)try{a.current.clearLayers()}catch(e){}Object.values(v.current).forEach(function(e){try{e.remove()}catch(e){}}),v.current={},c.filter(function(e){return!e.unlocated}).forEach(Dn),Y(c),en(!1);case 3:return e.a(2)}},e)}))},"导入到行程"),u.createElement("button",{className:"icon-btn",onClick:function(){return en(!1)}},"关闭"))),u.createElement("div",{style:{display:"flex",gap:12,padding:"10px 14px",alignItems:"stretch"}},u.createElement("textarea",{style:{flex:1,minHeight:240,border:"none",outline:"none",padding:12,background:"transparent"},placeholder:"粘贴行程文本，如：\nDay1：10:00 八一广场（游玩半小时）\n11:00 江西省美术馆（半小时到1.5小时）\n13:00 羊子街（午餐）\n14:30 八一起义纪念馆（约2小时）...\nDay2：...",value:an,onChange:function(e){return rn(e.target.value)}}),u.createElement("div",{style:{flex:1,overflow:"auto",maxHeight:"52vh"}},dn&&0!==dn.length?u.createElement("div",null,dn.map(function(e,t){return u.createElement("div",{key:t,className:"paper-card",style:{padding:10,marginBottom:8}},u.createElement("div",{style:{display:"flex",alignItems:"center",gap:8}},u.createElement("span",{className:"badge","aria-hidden":"true"}),u.createElement("div",null,"Day",(e.dayIndex||0)+1," · ",e.time||"--:--"," · ",e.name)),e.notes?u.createElement("div",{style:{color:"#6b7280",marginTop:6}},"备注：",e.notes):null,u.createElement("div",{style:{marginTop:8}},e.candidates&&0!==e.candidates.length?u.createElement("div",null,u.createElement("div",{style:{color:"#6b7280",marginBottom:6}},"候选地点（优先显示中文名称）："),e.candidates.map(function(n,a){return u.createElement("label",{key:a,style:{display:"flex",gap:8,alignItems:"flex-start",marginBottom:6}},u.createElement("input",{type:"radio",name:"cand-"+t,checked:e.selectedIdx===a,onChange:function(){return fn(function(e){var n=e.slice();return n[t].selectedIdx=a,n})}}),u.createElement("div",null,u.createElement("div",{style:{fontWeight:600}},n.display_name),u.createElement("div",{style:{color:"#6b7280",fontSize:12}},"(",parseFloat(n.lat).toFixed(5),", ",parseFloat(n.lon).toFixed(5),")")))})):"timeEvent"!==e._type&&e.name?u.createElement("div",{style:{color:"#ef4444"}},"未找到候选地点（也可直接导入为未定位，稍后到地图上放置）"):null))})):u.createElement("div",{style:{color:"#6b7280"}},"解析结果将在此显示；解析后可以为每一条选择候选地点。"))))),lt.show&&u.createElement("div",{style:{position:"fixed",inset:0,zIndex:10001},onClick:Xn},u.createElement("div",{className:"context-menu paper-card",style:{position:"absolute",left:Math.min(lt.x,window.innerWidth-220),top:Math.min(lt.y,window.innerHeight-220),width:200,padding:8},onClick:function(e){return e.stopPropagation()}},u.createElement("div",{className:"context-item",onClick:function(){var e=$.findIndex(function(e){return e.id===lt.itemId});e>0&&Rn(e,-1),Xn()}},"上移"),u.createElement("div",{className:"context-item",onClick:function(){var e=$.findIndex(function(e){return e.id===lt.itemId});e>=0&&e<$.length-1&&Rn(e,1),Xn()}},"下移"),u.createElement("div",{className:"context-sep"}),u.createElement("div",{className:"context-item",onClick:function(){Fa(lt.itemId,"play"),Xn()}},"备注·游玩"),u.createElement("div",{className:"context-item",onClick:function(){Fa(lt.itemId,"move"),Xn()}},"备注·移动"),u.createElement("div",{className:"context-item",onClick:function(){Fa(lt.itemId,"stay"),Xn()}},"备注·住宿"),u.createElement("div",{className:"context-sep"}),u.createElement("div",{className:"context-item",onClick:function(){var e=$.find(function(e){return e.id===lt.itemId});e&&(zn(lt.itemId,"fav",!e.fav),Xn())}},(Oa=$.find(function(e){return e.id===lt.itemId}))&&Oa.fav?"取消收藏":"设为收藏"),u.createElement("div",{className:"context-item danger",onClick:function(){Hn(lt.itemId),Xn()}},"删除"),u.createElement("div",{className:"context-sep"}),u.createElement("div",{className:"context-item",onClick:Xn},"关闭"))))}}}]);